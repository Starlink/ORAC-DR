\documentclass[twoside,11pt,nolof]{starlink}

%+
%  Name:
%     sun232.tex

%  Purpose:
%     SUN documentation for ORAC-DR imaging (SUN/232)

%  Notes:
%     -  Has definitions to give small capitals for ARD, CCDPACK,
%     CONVERT, CURSA, EXTRACTOR, FIGARO, GAIA, KAPPA, PHOTOM,
%     PISA, and POLPACK.  Each command is \<package>.
%     -  Definition of \ORACDR as ORAC-DR in small capitals.
%     -  Definition of \FITSref to point to FITS Home Page.
%     -  Definition of \<instrument> and \<telescope> to point to
%     their respective web sites.  These are AAT, JCMT, UKIRT, VLT.
%     INGRID, IRCAM, IRIS, ISAAC, Michelle, UIST, UFTI, and FP.
%     The last points to the UFTI Fabry-Perot web page.
%     -  SST has singled-sided name.
%     -  Added \pagebreak[3] and \goodbreaks to SST to prevent
%     section headings at the foot of a page.
%     -  \markboth in definition of \sstroutine to get running
%     header in reference section.
%     -  Used SUN/95 version of sstitemlist to remove
%     superfluous space after headings.  Added ssthitemlist
%     where the spacing is correct.
%     -  Uses some definitions of degrees, arcminutes,
%     arcsecond, underscore, and a centred asterisk.

%  Things to do:
%     - Example of -calib.

%  Authors:
%     MJC: Malcolm J. Currie (JAC)
%     TIMJ: Tim Jenness (JAC)
%     BRADC: Brad Cavanagh (JAC)

%  History:
%     2000 February 2 (MJC):
%        Original version 232.1.
%     2000 August 30 (MJC):
%        232.2: Replaced deprecated recipes with generic (jitter
%        size and instruments) versions.
%     2000 October 26 (MJC):
%        232.3: Added descriptions of the photometry and results file
%        to the *_APHOT recipes' notes.  Updated the file suffices,
%        changes, and the Features of the Primitives since the original
%        submission of V2.0-0.  Move notes about using the pre-ORAC
%        data to an appendix for improved visibility.
%     2001 March 20 (MJC):
%        232.4: Updated for v2.1-0, including new recipes.
%     2001 April 11 (TIMJ):
%        Add stardoccopyright
%     2001 November 23 (MJC):
%        232.5: Updated for v3.0-1, including new Michelle recipes.
%     2001 November 27 (MJC):
%        Updated for v3.0-2, including new Michelle recipes.
%     2001 December 4 (MJC):
%        Updated for v3.0-3, including new Michelle polarimetry recipes.
%     2002 May 28 (BRADC):
%        Clarified use of calibration options.
%     2002 September 13 (BRADC):
%        232.6: Updated for v3.1-1, including new recipes.
%     2003 May (BRADC):
%        Updated for v4.0, including UIST.
%     2003 June 12 (MJC)
%        232.7: Added new recipes; revised recipe descriptions, including
%        output data prefixes for INGRID, ISAAC, and UIST.  Added section
%        on xoracdr.  Mentioned relative ORAC_DATA directories.  Formed
%        section on raw formats and their conversion expanding on previous
%        material.  Restructured and augmented the Features of the Primitives,
%        including lists of the associated primitives by section.  Updated
%        the file suffices.  Created an appendix on internal headers.
%        Included v4.0 Release Notes.  Added many new links, many from new
%        commands defining telescope and instrument web sites.
%     2004 May 27 (BRADC):
%        Updated for v4.1. Included v4.1 Release Notes.
%     2004 May 28 (MJC)
%        Added new recipes; revised recipe descriptions.  Added sections
%        on NACO and Classic Cam startup and format conversion, and
%        instrument-specific properties of the recipes within Appendix E
%        (was D).  Insert references to these instruments and NIRI where
%        appropriate.  Added fpcentre and polrefang to the list of available
%        calibration methods.  Updated and augmented the Features of the
%        Primitives, listing new primitives.  Updated the file suffices.
%        Trimmed the Output Data by not listing all the prefixes, instead
%        citing a new appendix listing the various file prefixes.  Fixed a
%        two hyperlinks in the recipe reference appendix.  Augmented the
%        list of steering headers.  Included detailed v4.1 Release Notes.
%      2004 June 9 (BRADC):
%        232.8: Added brief description of eSTAR integration.

%  Copyright:
%     Copyright (C) 1998--2004 Particle Physics and Astronomy
%     Research Council.  All Rights Reserved.

%-

% -----------------------------------------------------------------------------
\stardoccategory    {Starlink User Note}
\stardocinitials    {SUN}
\stardocsource      {sun\stardocnumber}
\stardocnumber      {232.8}
\stardocauthors     {Malcolm J. Currie\\
                               Brad Cavanagh\\
                               Joint Astronomy Centre, Hilo, Hawaii}
\stardocdate        {2004 June}
\stardoccopyright   {Copyright \copyright\ 2004 Particle Physics and Astronomy Research Council}
\stardoctitle       {ORAC-DR -- imaging data reduction}
\stardocversion     {4.1}
\stardocmanual      {User Guide}
\stardocabstract    {{\footnotesize ORAC-DR} is a
general-purpose automatic data-reduction pipeline environment.  This
document describes its use to reduce imaging data collected at the
United Kingdom Infrared Telescope (UKIRT) with the UFTI, UIST, IRCAM,
and Michelle instruments; at the Anglo-Australian Telescope (AAT) with
the IRIS2 instrument; at the Very Large Telescope with ISAAC and NACO;
from Magellan's Classic~Cam, at Gemini with NIRI, and from the Isaac
Newton Group using INGRID.  It outlines the algorithms used and how to
make minor modifications to them, and how to correct for errors made
at the telescope.}
\stardocname  {\stardocinitials /\stardocnumber}
% -----------------------------------------------------------------------------
% degrees symbol
\providecommand{\dgs}{\hbox{$^\circ$}}

% arcminute symbol
\providecommand{\arcm}{\hbox{$^\prime$}}

% arcsec symbol
\providecommand{\arcsec}{\arcm\hskip -0.1em\arcm}

% decimal-degree symbol
\providecommand{\udeg}{\hskip-0.3em\dgs\hskip-0.08em}

% decimal-arcsecond symbol
\providecommand{\uarcs}{\hskip-0.27em\arcsec\hskip-0.02em}

% centre an asterisk
\providecommand{\lsk}{\raisebox{-0.4ex}{\rm *}}

% Software
\providecommand{\ARD}{{\footnotesize ARD}}
\providecommand{\ATOOLS}{{\footnotesize ATOOLS}}
\providecommand{\CCDPACK}{{\footnotesize CCDPACK}}
\providecommand{\CONVERT}{{\footnotesize CONVERT}}
\providecommand{\CURSA}{{\footnotesize CURSA}}
\providecommand{\GAIA}{{\footnotesize GAIA}}
\providecommand{\EXTRACTOR}{\mbox{\footnotesize EXTRACTOR}}
\providecommand{\FIGARO}{\mbox{\footnotesize FIGARO}}
\providecommand{\KAPPA}{{\footnotesize KAPPA}}
\providecommand{\ORACDR}{{\footnotesize ORAC-DR}}
\providecommand{\PHOTOM}{{\footnotesize PHOTOM}}
\providecommand{\PISA}{{\footnotesize PISA}}
\providecommand{\POLPACK}{{\footnotesize POLPACK}}
\providecommand{\FITSref}{\htmladdnormallink{FITS}{http://fits.gsfc.nasa.gov/}}
\providecommand{\eSTAR}{\htmladdnormallink{eSTAR}{http://www.estar.org.uk/}}

% Telescopes and instruments
\providecommand{\AAT}{\htmladdnormallink{AAT}{http://www.aao.gov.au/}}
\providecommand{\JCMT}{\htmladdnormallink{JCMT}{http://www.jach.hawaii.edu/JACpublic/JCMT/}}
\providecommand{\UKIRT}{\htmladdnormallink{UKIRT}{http://www.jach.hawaii.edu/JACpublic/UKIRT/}}
\providecommand{\VLT}{\htmladdnormallink{VLT}{http://www.eso.org/instruments/}}

\providecommand{\ClassicCam}{\htmladdnormallink{Classic~Cam}{http://www.ociw.edu/lco/magellan/instruments/Classic_Cam/}}
\providecommand{\INGRID}{\htmladdnormallink{INGRID}{http://www.ing.iac.es/Astronomy/instruments/ingrid/}}
\providecommand{\IRCAM}{\htmladdnormallink{IRCAM}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/ircam/ircam3.html}}
\providecommand{\IRIS}{\htmladdnormallink{IRIS2}{http://www.aao.gov.au/iris2/}}
\providecommand{\ISAAC}{\htmladdnormallink{ISAAC}{http://www.eso.org/instruments/isaac/}}
\providecommand{\Michelle}{\htmladdnormallink{Michelle}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/michelle/michelle.html}}
\providecommand{\NACO}{\htmladdnormallink{NACO}{http://www.eso.org/instruments/naco/}}
\providecommand{\NIRI}{\htmladdnormallink{NIRI}{http://www.gemini.edu/sciops/instruments/niri/}}
\providecommand{\UIST}{\htmladdnormallink{UIST}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/uist/uist.html}}
\providecommand{\UFTI}{\htmladdnormallink{UFTI}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/ufti/ufti.html}}
\providecommand{\FP}{\htmladdnormallink{Fabry-Perot}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/ufti/ufti_fp.html}}

% -----------------------------------------------------------------------------
\begin{document}
\scfrontmatter

\section{\xlabel{introduction}Introduction\label{introduction}}

\ORACDR\ is a data-reduction pipeline operating at \UKIRT, \JCMT,
the \AAT.  It is part of the
\htmladdnormallink{ORAC system}{http://www.stsci.edu/stsci/meetings/adassVII/bridgera.html}.
The pipeline reduces and displays multi-frame
observations soon after they are read from the detector.  This allows
observers to assess the quality and suitability of their data in near
real time.  Yet \ORACDR\ is capable of producing publication-quality
results.

\ORACDR\ is suitable for `offline' data reduction at your home
institution too.  There are many reasons why you may wish to use
\ORACDR\ in this fashion.  For instance, you may have come back from
UKIRT with only the raw observations; or there was an error in a
telescope sequence (formerly an `exec') mixing the groups of
observations; or some data were reduced with a basic algorithm for
speed at the telescope, and now you want to do a more-careful job.
\ORACDR\ is capable of reducing data from instruments not running the
pipeline at their respective telescopes.  Hence \ORACDR\ is available
on Starlink.

\xref{SUN/230}{sun230}{} presents an overview of \ORACDR,
general facilities like its display system, and it explains the
differences between a pipeline and a traditional reduction package.
Put briefly, \ORACDR\ uses a few data headers to direct the data
reduction.  Amongst these headers is the name of a \emph{recipe}.  A
recipe is a series of high-level instructions such as ``make a
mosaic'' or ``divide by a flat'' that reduces an \emph{observation\/}
comprising one or more data frames.  The implementation of each of
these instructions is through a Perl script---called a
primitive---which calls Starlink packages such as
\xref{\CCDPACK}{sun139}{} and \xref{\KAPPA}{sun95}{},
to actually do the processing of the bulk data.

This document describes how to use \ORACDR\ software on Starlink to
reduce data from the UKIRT imaging instruments: \UFTI, \UIST, \IRCAM, and
\Michelle; the AAT imaging instrument \IRIS; the \ISAAC\ and \NACO\
instruments on the Very Large Telescope (\VLT); \ClassicCam\ from
Magellan; \NIRI\ from Gemini, and \INGRID\ from the Isaac Newton
Group on La Palma.  It outlines the various algorithms used in the
recipes, and includes detailed recipe documentation in the appendix.
Besides the standard reduction recipes, this manual describes how you
can customise recipes to suit your preferences, and how to correct
errors in the headers of your data frames.

There are complementary documents: \xref{SUN/236}{sun236}{} describes the
\ORACDR\ for spectroscopy from CGS4, Michelle, and UIST; \xref{SUN/246}{sun246}{}
describes the \ORACDR\ for integral field spectroscopy from UIST;
and \xref{SUN/231}{sun231}{} addresses the reduction of SCUBA data with \ORACDR.

% When SUN/234 is ready, remove the above sentence and these comments,
% and uncomment the three lines below.

%\ORACDR\ is not limited to processing UKIRT imaging data.  Complementary
%documents \xref{SUN/231}{sun231}{} and \xref{SUN/234}{sun234}{} address
%the reduction of SCUBA and CGS4 data respectively.

Those wishing wishing to write their own recipes from scratch, or wanting
to apply ORAC-DR to new instruments should consult \xref{SUN/233}{sun233}{}.

\section{\xlabel{using_the_pipeline}Using the pipeline\label{using_the_pipeline}}

\subsection{\xlabel{setting_up_orac-dr}Setting up \ORACDR\label{setting_up_orac-dr}}

Before you can run the pipeline you have to tell \ORACDR\ for which
instrument you wish to reduce data, the observation date, and the
directory containing the raw data, and wher you want the processed
data to be written.  There are two options.

\begin{itemize}

\item  The first needs your data to conform to the directory-naming
convention of the instrument at UKIRT.  This will be the case if you
simply unpack the archive written by the \textbf{uktape} utility.  In
this case enter

\begin{terminalv}
      % setenv ORAC_DATA_ROOT <root_data_directory>
      % oracdr_<instrument> <date>
\end{terminalv}
where \texttt{$<$root\_data\_directory$>$} is the directory in which you
unpacked the data from the tape, \texttt{$<$instrument$>$} is either \texttt{ufti} or \texttt{ircam}, and {\tt$<$date$>$} is the UT date in the format
YYYYMMDD.  Note that each \texttt{\%} represents the UNIX shell's
prompt, which you do not type.  The commands must be entered in the
above order.

For example, the standard location for raw UFTI data is \texttt{raw/ufti/YYYYMMDD/}, and \texttt{reduced/ufti/YYYYMMDD/} for the
corresponding reduced data.  So if your data are stored in \texttt{/home/users/abc/data/UKIRT/raw/ufti/20001108/} you should enter the
following.

\begin{terminalv}
      % setenv ORAC_DATA_ROOT  /home/users/abc/data/UKIRT/
      % oracdr_ufti 20001108
\end{terminalv}
to enable the pipeline for \UFTI\ data taken on 2000 November 8.

Data taken from the AAT is handled differently, as there is no unified
directory structure for both raw and reduced data directories.  For
IRIS2, INGRID, ISAAC, NACO, NIRI, or Classic~Cam data the best option is
specifying where the raw and reduced data directories are, as shown
below.  Those with ISAAC and NACO data should see


\begin{latexonly}
Section~\ref{isaac_and_naco_preliminary_conversion}
\end{latexonly}
for a necessary preliminary naming conversion step for each instrument.
Classic~Cam users need to read


\begin{latexonly}
Section~\ref{classiccam_preliminary_conversion}
\end{latexonly}
concerning renaming raw data files for the respective instruments.

\item The second option is where your raw and reduced data are to be
in arbitrary directories.  Type the following

\begin{terminalv}
      % oracdr_<instrument> <date>
      % setenv ORAC_DATA_IN <raw_data_directory>
      % setenv ORAC_DATA_OUT <reduced_data_directory>
\end{terminalv}

The directories can either be given as full paths, or as relative paths
to the current working directory.  Here is an example for IRCAM data using
full paths.
\begin{terminalv}
      % oracdr_ircam 19990328
      % setenv ORAC_DATA_IN /export/data/mjc/asteroid/night1
      % setenv ORAC_DATA_OUT /home/scratch/mjc/reduced
\end{terminalv}

\end{itemize}
In the first case \texttt{\$ORAC\_DATA\_IN} and \texttt{\$ORAC\_DATA\_OUT} are
still defined, but in terms of the root directory.  For instance, re-using
the earlier example with UFTI for UT date 2000 November 8,
\texttt{\$ORAC\_DATA\_IN} points to \texttt{\$ORAC\_DATA\_ROOT/raw/ufti/20001108/}.

\ORACDR\ operates in \texttt{\$ORAC\_DATA\_OUT}, irrespective of
what your current directory is when you invoke it.   Your current
directory remains unchanged.

It is highly recommended to work in directories on discs local to
the computer running the pipeline.  Processing over NFS-served drives
can many times slower and degrades the performance seen by other users.
Running \ORACDR\ on a Linux computer over NFS-served drives can also
lead to erroneous results, crashing of the pipeline, or computer lockups.

\subsection{\xlabel{raw_data_formats_and_conversions}Raw Data Formats
and Conversions\label{raw_data_formats_and_conversions}}

Raw data take the form of multiple NDFs within an
\xref{HDS container file}{sun92}{} for UKIRT data, or individual
\FITSref\ files for \AAT, \INGRID, \ISAAC, \NACO, \NIRI, and \ClassicCam\ data.
For \UFTI, \UIST, and \IRCAM\ they comprise one NDF for the data array
and dynamic headers, such as the start time of the exposure, and
another for static headers.  Each container file is converted to a
single NDF in \texttt{\$ORAC\_DATA\_OUT} with a merged set of headers.

The \Michelle\ HDS container file also has NDFs for the individual chop
beams.  However, these cannot be merged until the data variance is
calculated from the individual beams.  Michelle reduced chopped data
become simple NDFs once the recipe takes the difference of the two
beams.

\ORACDR\ automatically converts AAT FITS files into single NDFs in
\texttt{\$ORAC\_DATA\_OUT} which retain the original FITS headers. For
INGRID and NIRI, \ORACDR\ converts a multi-extension FITS file into a
multi-NDF HDS container file following UKIRT conventions.

\subsubsection{\xlabel{isaac_and_naco_preliminary_conversion}ISAAC and NACO Preliminary
Conversion\label{isaac_and_naco_preliminary_conversion}}

Since \ORACDR\ as yet cannot cope with ESO file naming, which uses
the UT epoch instead of a sequence number, there is a special C-shell
script which must be invoked once, normally before the first \ORACDR\
initialisation.  If you enter

\begin{terminalv}
      % isaac2oracdr
\end{terminalv}
in a directory containing ISAAC FITS files, the command converts them
into NDFs with names adhering to the UKIRT convention.  The prefix
is \texttt{isaac}.  The earliest file has observation number 1, and the
observation number increments for each FITS file in time order.  The
script copes with files names in either the raw or archive nomenclature.
It also writes observation and group number headers to assist ORAC-DR.
It copes with data from more than one night in a given directory,
assigning each night its own sequence of observation numbers; and it
uses a common UT date for observations in a single night spanning
midnight UT.  You should put all both the calibration and target files
for a given night in the same directory.

Likewise in a directory of \NACO\ FITS files, you should first enter
\begin{terminalv}
      % naco2oracdr
\end{terminalv}
to create a set of NDF files whose names adhere to the UKIRT
convention with a \texttt{naco} prefix.

\subsubsection{\xlabel{classiccam_preliminary_conversion}Classic~Cam Preliminary
Conversion\label{classiccam_preliminary_conversion}}

The Magellan \ClassicCam\ raw FITS data have a sequence number but no UT
date in their names.   There is a preprocessor C-shell script which must be
invoked once, normally before the first \ORACDR\ initialisation.  If you enter

\begin{terminalv}
      % cc2oracdr
\end{terminalv}
in a directory containing Classic~Cam FITS files, the command converts them
into NDFs with names adhering to the UKIRT convention.  The prefix
is \texttt{cc}.  The earliest file has observation number 100 (a
Classic~Cam convention), and the observation number increments for each
FITS file in sequence-number order.

It also writes the observation and group numbers, and the number of
offsets in the grouped observation into the headers, to assist
ORAC-DR.

\subsection{\xlabel{running_the_pipeline}Running the
pipeline\label{running_the_pipeline}}

To run the pipeline, you use the \textbf{oracdr} command.  This has a
number of qualifiers described fully in \xref{SUN/230}{sun230}{oracdr}.
There is online help too; enter

\begin{terminalv}
      % oracdr -h
\end{terminalv}
for a list of the options.

Unlike using \ORACDR\ at \UKIRT, you are unlikely to need the looping (\texttt{-loop}
option) for offline processing, as all the data exist.  Thus the most
important qualifiers are \texttt{-list} and \texttt{-from}, which specify
the frames to process; and the recipe name.

\begin{terminalv}
      % oracdr -from 42
\end{terminalv}
will process frames f20001108\_00042 until the end of the night's data
(assuming the earlier \textbf{oracdr\_ufti} command), running the recipes
given by each frame's header (RECIPE keyword).  More likely is that
you provide a list of selected observations.  The following example

\begin{terminalv}
      % oracdr -list 41:49,51:59 JITTER_SELF_FLAT
\end{terminalv}
processes frames from 41 to 49 inclusive and 51 to 59 inclusive,
invoking the \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} recipe,
and overriding the RECIPE header.

\begin{terminalv}
      % oracdr -list 5:7,23,33
\end{terminalv}
would reduce the frames 5, 6, 7, 23, and 33.  This is most likely
to be applicable to a series of dark frames.

There is a hazard with the \texttt{-list} option.  Take care to select a
complete set of frames associated with an observation.  A common error
is to include accidently a dark frame not part of the group.  Check
the log in the raw data directory; it has file extension \texttt{.nightlog}.  If you do not have a log, it is easy to create one.
\label{night_log}

\begin{terminalv}
      % oracdr -noeng -from 1 -skip -nodisplay NIGHT_LOG
\end{terminalv}
This will create a log called \texttt{\$ORAC\_DATA\_IN/$<$date$>$.nightlog}
for the current UT date. For multi-mode instruments such as Michelle, UIST,
IRIS2, NACO or ISAAC, the log will be called
\goodbreak \texttt{\$ORAC\_DATA\_IN/$<$date$>$\_im.nightlog}.

\subsection{\xlabel{graphical_initialisation_and_operation}Graphical initialisation and
operation\label{graphical_initialisation_and_operation}}

You may prefer the \ORACDR\ graphical interface called
\xref{\textbf{xoracdr}}{sun230}{xoracdr}.
\latexonly{( See SUN/230.)}  It allows you to configure
ORAC-DR: set the instrument, UT date, raw and reduced directories; and
to run the pipeline with the various options.  It permits monitoring
of the primitives during execution of a recipe. \textbf{xoracdr} offers
access to other facilities like
\htmlref{display control}{display} and recipe editing.  The in-built
documentation does not pertain to the GUI itself but to general
\ORACDR\ information, however, \textbf{xoracdr} is straightforward to use
and explore.  While \textbf{xoracdr} has some rough edges, it is popular
with many users.  To try it, enter

\begin{terminalv}
      % xoracdr &
\end{terminalv}

Once the tool appears, you should select an instrument from the menu on
the left, a UT date in the top centre, and raw and reduced directories
to the lower right.   The \texttt{From:} and \texttt{To:} refer to the
observation numbers to process.  When you are ready to reduce data,
click on the \texttt{Start ORAC-DR} button.

\subsection{\xlabel{display}Display\label{display}}

\ORACDR\ optionally lets you inspect the raw frames, and the processed
data as they are created.  There is a variety of graphical
methods available, including histograms and contour plots, if you
choose a \xref{\KAPPA}{sun95}{} GWM widget.  Most people prefer a
simple scaled image display with \xref{\GAIA}{sun214}{}.  This offers
facilities to inspect and analyse the data, and both pixel and sky
co-ordinates of the cursor position are presented.  The selection of
frame types to display, where they should appear, and how they are
scaled are configurable using a simple text file or a special GUI tool
\textbf{oracdisp}.  See \xref{SUN/230}{sun230}{display_system} for details
and examples.

Processing offline, there is less need to see the data displayed in real time.
If you wish to accelerate the processing switch off the display option.

\begin{terminalv}
      % oracdr -nodisplay ...
\end{terminalv}

If you do want to display a recommendation is to create two GAIA windows
displaying images using autoscaled limits.  This first could be for
raw and flat-fielded data, and the second for the mosaics.  You are
likely to want to interact with the latter, using \GAIA's toolboxes.
Your \texttt{\$ORAC\_DATA\_OUT/disp.dat} could look like this.

\begin{terminalv}
      # Send raw frame to first GAIA window
      num type=image tool=gaia region=0 window=0 autoscale=1 zautoscale=1

      # Send flatfielded frame to first GAIA window.
      ff  type=image tool=gaia region=0 window=0 autoscale=1 zautoscale=1

      # Send mosaic frame to second GAIA window.
      mos type=image tool=gaia region=0 window=1 autoscale=1 zautoscale=1
\end{terminalv}

\subsection{\xlabel{calibration_information}Calibration Information\label{calibration_information}}

\ORACDR\ records calibration information, such as dark frames, flat
fields, and the read noise, within index files, one for each type of
calibration information.  When the pipeline needs a calibration frame
it searches the index file for the best matching entry subject to a
set of rules. Each recipe reports the calibrations it has used.  If no
suitable calibration exists, the pipeline exits with an error message
stating this fact.  For further details see
\xref{SUN/230}{sun230}{calibration_selection}.


\begin{latexonly}
Section~\ref{index_files} has an example of an index file.
\end{latexonly}

You can also select a specific calibration using the \texttt{-calib}
command-line option, provided the chosen calibration has an entry
in the appropriate index file.  See
\begin{latexonly}
the section on
\end{latexonly}
\xref{calibration options}{sun230}{calibration_options}
\begin{latexonly}
in SUN/230
\end{latexonly}
for details and examples.

\subsubsection{\xlabel{available_calib}Available calibration methods\label{available_calib}}

The following calibration methods are available for imaging recipes.

\begin{itemize}

\item baseshift --- Use the given comma-separated doublet (\emph{{i.e.}}\ \texttt{0,0}) as the
frame's base position.  This is used to locate faint sources in the
mid-infra-red data where centroiding fails when there is some
telescope pointing error (such as incorrect instrument apertures).  It
is calibrated within \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT} on a
bright standard, and used by
\htmlref{NOD\_CHOP\_FAINT}{NOD\_CHOP\_FAINT}.  For a well-tuned
system, the baseshift is expected to be near 0,0, so the centre of the
detector is at the reference position (derived from the FITS headers).

\item bias --- Use the given bias frame.

\item dark --- Use the given dark frame.

\item fpcentre --- Use the given Cartesian pixel centre of the
Fabry-Perot transmitted region (UFTI only).

\item flat --- Use the given flat frame.

\item mask --- Use the given bad-pixel mask.

\item polrefang --- Use the specified polarimetry calibration angle,
converting measured polarisation vector orientations into position angles.
It is measured in degrees, applied clockwise to the vector direction
to allow for the orientation of the analyser with respect to north.

\item readnoise --- Use the given value for the detector readnoise in
electrons.

\item referenceoffset --- Use the comma-separated doublet
(\emph{{i.e.}}\ \texttt{0,0}) as the frame's reference offset, which is
difference between the frame centre and the reference pixel derived
from the FITS headers.

\item rotation --- Use the given frame as a rotation matrix.  This is
no longer used in the imaging recipes.

\item sky --- Use the given sky frame.

\end{itemize}

\subsection{\xlabel{log_files}Log files\label{log_files}}

In addition to presenting the progressing data reduction to an
\ORACDR\ X-window, \ORACDR, by default, retains a copy of the
processing steps and errors in a log file.  These logs are important
if something has gone wrong, and you have exited the X-window.
Information from the applications software can be included if you run
the pipeline with the \texttt{-verbose} command-line option.  Logs also
serve as a record of the data processing.  Yet the log files are often
overlooked because they are hidden.  The log file is called
{\tt\$ORAC\_DATA\_OUT/.oracdr\_$<$number$>$}, where {\tt$<$number$>$}
is the current process identification.  The \texttt{-log f} option to the
\textbf{oracdr} command enables log-file creation.

See \xref{SUN/230}{sun230}{windows_and_output} for details of the
logging options.

\section{\xlabel{features_of_the_primitives}Features of the
Primitives\label{features_of_the_primitives}}

Primitives are the Perl scripts which actually call the applications
to do most of the data processing.  All of the imaging recipes are, in
principle, independent of the instrument.  However, some recipes are
inappropriate; for example, the NOD\_CHOP family of recipes are
intended for mid-IR imaging with Michelle, but not the
\htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} family.  The generality
comes in part from translations of relevant header information into a
generic form used by \ORACDR.

Not all the following steps apply to all recipes.  Consult the
\htmlref{reference section}{recipes} to see summaries for each recipe.
The steps are presented in normal order of appearance.

The main primitives pertinent to each step are listed in bracketed
italics, should you wish to tailor the recipes.  These are found in
{\tt\$ORAC\_DIR/imaging} tree, unless they start with \emph{general/}
when they are located in {\tt\$ORAC\_DIR/general}.  Note the some may
be instrument-specific variants, either given explicitly or with the
\emph{$<$instrument$>$} token, which means substitute the instrument
name in uppercase.

While those listed form the bulk of the primitives, there are many not
listed here, mostly those for


\begin{latexonly}
recipe initialisation called \emph{$<$recipe$>$}\_HELLO\_ (see
Section~\ref{hello_primitives} for more information),
\end{latexonly}
and for


\begin{latexonly}
recipe steering which control when to perform certain operations, called
\emph{$<$recipe$>$}\_STEER\_ (see Section~\ref{steering_primitive}).
\end{latexonly}
The first of these is normally left unchanged unless there is a need
to add more steering parameters passed to the steering primitive.  The
steering primitive itself is only modified for such new steering
parameters, and if the observing pattern or sequence is different from
what the recipe is programmed to expect.  Other primitives not
mentioned here are tied closely with single recipes, usually to create
and file calibrations.

\subsection{\xlabel{preparation_of_single_frames}Preparation of Single
Frames\label{preparation_of_single_frames}}

\emph{[\_IMAGING\_HELLO\_, $<$instrument$>$/\_INSTRUMENT\_HELLO\_,\\
\_PREPARE\_SINGLE\_FRAME\_]}

\subsubsection{\xlabel{manipulation_of_raw_data}Manipulation of Raw
Data\label{manipulation_of_raw_data}}

The first stage makes an NDF, or multiple NDFs stored in an
\xref{HDS}{sun92}{} container file, located in {\tt\$ORAC\_DATA\_OUT}, the actual
operation depending on the instrument.  In some cases like \UFTI, this
is dealt by the \ORACDR\ infrastructure, including conversion from
\FITSref\ for early UFTI data.
\newline \emph{[$<$instrument$>$/\_CREATE\_RAW\_FRAME\_]}

For \IRCAM\ the recipes are merely copying the raw NDF, because the
original raw files are normally write protected.

\UIST\ and \Michelle\ both copy all the components of multi-NDF container
file.  These container files have a HEADER NDF of the observation-wide
FITS headers, and NDFs of chopped beams or integrations.  Recipes
check that two integrations are present for a chopped observations or
one integration for other modes, exiting with an error message if
either test fails.  A single integration NDF is merged with the HEADER
NDF into a simple NDF.

\subsubsection{\xlabel{preliminaries}Preliminaries\label{preliminaries}}

There are a few operations applied to all frames.  First the raw frame
may be displayed.  \newline \emph{[general/\_DISPLAY\_FRAME\_IMAGE\_]}

Recipes remove any \xref{AXIS and blank TITLE components}{sun95}{ap_NDFformat};
the latter to preserve the object name when NDFs are exported to
\FITSref.  Next they set the origin of the frame so that frame pixels retain the detector
pixel indices.  It then becomes possible to use a full-sized bad-pixel
mask or flat field on any subset of a detector's pixel grid.
\newline \emph{[\_REMOVE\_AXES\_, \_REMOVE\_BLANK\_TITLE\_, \_SET\_ORIGIN\_]}

Then recipes determine the displacements of the reference pixel with
respect to the centre of the frame and stores the displacements in the
referenceoffset \htmlref{calibration system}{calibration_information}.
The reference pixel is where a star would be placed for photometry or
the centre of a chopped and nodded pattern.
\newline \emph{[\_SET\_REFERENCE\_PIXEL\_OFFSET\_, \_GET\_FRAME\_CENTRE\_]}

The next step is to switch on history recording.  It is recommended to
leave this enabled, since it provides a record of the processing steps
of your final mosaics.  Otherwise the pipeline becomes something of
a black box.  Use the \KAPPA\ command
\xref{\textbf{hislist}}{sun95}{HISLIST} to list the history records.
\newline \emph{[\_TURN\_ON\_HISTORY\_]}

For Michelle there is a validation check of the waveform used,
comparing the waveform name given in the headers with other metadata,
and recipes issue a warning if there is an inconsistency.  Also the
data range is validated to be between 25000--48000.
\newline \emph{[MICHELLE/\_CHECK\_WAVEFORM\_, MICHELLE/\_VALIDATE\_RAW\_DATA\_]}

For UFTI there is data validation, such that a warning is issued if the
clipped mean sky level is below 24 counts per second in $K$ band and 32 counts
per second in $H$.
\newline \emph{[UFTI/\_CHECK\_SKY\_COUNTS\_, UFTI/\_VALIDATE\_RAW\_DATA\_]}

For UIST data taken before 2002 December 2 and Michelle, raw data
units are converted from ADU per second to the \UKIRT\ standard of total
ADU per exposure.
\newline \emph{[$<$instrument$>$/\_INSTRUMENT\_HELLO\_, UIST/\_DATA\_UNITS\_TO\_ADU\_]}

A \htmlref{night log}{night_log} is created or appended in {\tt\$ORAC\_DATA\_OUT}
for each frame processed.  This tabulates the main parameters of the
observation having first corrected defective or undefined headers.
\newline \emph{[\_NIGHT\_LOG\_, UIST/\_NIGHT\_LOG\_,
$<$instrument$>$/\_FIX\_HEADERS\_ for Classic~Cam, IRCAM, MICHELLE, NIRI, and UFTI]}

\subsubsection{\xlabel{non-linearity_correction}Non-linearity
Correction\label{non-linearity_correction}}

Detector non-linearity corrections are applied to \ClassicCam, \IRCAM,
and \INGRID.  For IRCAM the correction is $3.3\times10^{-6}$ times the
square of the bias-subtracted signal.  For INGRID the
measured-to-actual counts is given by the expression $1.0 - 1.2247
\times 10^{-6} * M - 7.68045 \times 10^{-11} * M^2$, where \emph{{M}} is
the measured ADU count, although it is actually applied after the
pre-exposure readout is subtracted from the post-exposure integration.
For Classic~Cam the correction is 1.625$\times10^{-6}$ $*$ (1 $+$
overhead$/$exposure\_time), where the overhead is 2 $*$ speed $*$
number of pre-exposure reads $+$ (speed $+$ readout time ) $*$ number
of post-exposure reads.  The various parameters in this expression are
either read from the headers or taken verbatim from an IRAF script cited
in the user manual.
\newline \emph{[CLASSICCAM/\_CORRECT\_NONLINEARITY\_,\\
IRCAM/\_CORRECT\_NONLINEARITY\_,\\
INGRID/\_CORRECT\_NONLINEARITY\_PRE\_POST\_]}

\subsubsection{\xlabel{electronic_ghosting}Electronic Ghosting\label{electronic_ghosting}}

For \ISAAC\ there is a correction applied for electronic ghosting. The
ghosts consist ``of an additional signal, which, on one row, is
proportional to the sum of the intensity along this row and the row
512 rows away.'' according to the \htmladdnormallink{\emph{ISAAC Data
Reduction Guide}}{http://www.eso.org/instruments/isaac/drg/html/drg.html}.
Recipes combine the two halves adding the bottom half to the top and
vice versa, collapse this image along rows, scale by the documented
correction factor of 1.35E-5 to form the ghost flux per row, which is
then subtracted from the original image.
\newline \emph{[ISAAC/\_REMOVE\_ELECTRONIC\_GHOSTING\_]}

\subsubsection{\xlabel{bad_pixels}Bad pixels\label{bad_pixels}}

The recipes apply a predetermined bad-pixel mask with the aim of
removing the bulk of `hot' and `cold' pixels.  The approximate
percentages of pixels masked for each instrument is as follows:
\ClassicCam 1.1,  \INGRID\ 1.0, \IRCAM\ 0.1, \IRIS\ 0.1,
\ISAAC\ 0.4, \UFTI\ 0.7, and \UIST\ 0.4.

The Michelle bad pixel mask is time dependent; initially 12 aberrant
pixels were identified, but when the new detector returned on UKIRT in
2004, the mask merely ignored the top sixth of the array.

For the test data available, \NACO\ had large numbers of very noisy
pixels to the foot and sides of the detector, hence the default
bad-pixel mask has 9.9\% bad pixels.  If your NACO data do not show
this, you can form your own mask from a long-exposure dark frame,
looking for the highly deviant pixels.   See


\begin{latexonly}
the notes ``Creating a bad-pixel mask'' below
\end{latexonly}
for suggestions.
\newline \emph{[\_MASK\_BAD\_PIXELS\_]}

There are two problems.  First, the pre-calculated mask only accounts
for 95\% of UFTI's problem pixels.  The \htmladdnormallink{other 5\%
are occasionally deviant on timescales of
days}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/ufti/badpixels.html}.
The variability of IRCAM, Michelle, UIST, and IRIS2 bad pixels is
unknown at the time of writing.  In addition the bad-pixel masks have
not been regularly monitored prior to 2000 August.  The result is that
non-physical values could appear in the processed data, some as
extreme as $-10^{-31}$ causing automatic registration and image
display to go awry.

Therefore, after \htmlref{dark subtraction}{dark_subtraction}, recipes
apply thresholding which flags non-physical values as bad, meaning
undefined.  This is just augmenting the bad-pixel mask, and no valid
data are lost.  The upper limit is above the nominal saturation
levels: 16000 for Classic~Cam; 30000 for INGRID; 20000 for IRCAM in
STARE or NDSTARE mode, and 33000 using the Deepwell; 200000 for IRIS2
and ISAAC; 100000 for Michelle; 4300 for NACO in FowlerNsamp and
Double\_RdRstRd modes, but 12400 for Uncorrelated reads except for the
$M^\prime$ band where it is 28000; 17000 times the number of coadds
for NIRI; 15000 for UFTI; and 20000 for UIST.  The lower limit is the
2-, 3-, 3-$\sigma$-clipped mean, approximating to the mode, less five
times the clipped standard deviation, $\sigma$.  While a positive
threshold looks attractive, small negative values, while appearing
non-physical, can arise through noise.  Therefore, to avoid a bias
(mainly in the $J$ band), a further constraint is that the lower limit
lies in the range $-$100 to 1.
\newline \emph{[\_SUBTRACT\_DARK\_, $<$instrument$>$/\_GET\_SATURATION\_LEVEL\_]}

Recipes issue warnings if the dark-subtracted frame's mode is
negative, allowing for the error in the mode.  It aborts with an error
message if the modal dark-subtracted signal is more than one standard
deviation negative.  These states usually arise because of an aberrant
dark.

\paragraph{\xlabel{create_bad-pixel_mask}Creating a bad-pixel
mask\label{create_bad-pixel_mask}}

The easiest way to create your own bad-pixel mask for use with the
calibration system, is to run the \htmlref{MAKE\_BPM}{MAKE\_BPM}
recipe on a long-exposure dark (at least 20 seconds integration).  It
is possible to change the symmetric $\sigma$-clipping bounds in the
recipe (see primitive {\tt\_MAKE\_BPM\_BY\_SIGMA\_THRESHOLDING\_}).
You can tailor this primitive if you want more control, say to have
asymmetric rejection or more sophisticated definitions.
\newline \emph{[\_MAKE\_BPM\_BY\_SIGMA\_THRESHOLDING\_]}

For better results, use the average of long dark frames taken across
two or three nights.  First, produce QUICK\_LOOK versions of the
long-exposure dark to flatten the NDF structure or convert the FITS
file.  Flag all pixels that are 5 standard deviations ($\sigma$) above
and below the 3-$\sigma$ clipped mean of the dark as ``bad'', then
multiply the resulting frame by zero so that the resulting bad-pixel
mask has data values of \texttt{0} and \texttt{bad} only.  You can choose your
own thresholds.  Here is an example, using data from two nights of
UFTI data and Starlink software.

\begin{terminalv}
      % oracdr_ufti 20010101
      % setenv ORAC_DATA_OUT `pwd`
      % oracdr -list 4:4 QUICK_LOOK -nodisplay
      % oracdr_ufti 20010102
      % setenv ORAC_DATA_OUT `pwd`
      % oracdr -list 4:4 QUICK_LOOK -nodisplay

      % kappa
      % add f20010101_00004_raw f20010102_00004_raw add_darks
      % cmult add_darks 0.5 av_darks
      % stats av_dark clip=3
      % thresh av_darks av_darks_thresh -49 58 bad bad
      % cmult av_darks_thresh 0 avbpm title=\"UFTI bpm, January 2001\"
\end{terminalv}

In the above example the 3-$\sigma$ clipped mean was 4.27 and the standard deviation
was 10.727, resulting in $-$49 and 58 as the lower and upper thresholds.

Then you specify the bad-pixel mask on the command line.
\begin{terminalv}
      % oracdr -calib mask=avbpm ...
\end{terminalv}

\UIST\ has its own slightly different formula; see \htmlref{DARK\_AND\_BPM}{DARK\_AND\_BPM}
for details.

\emph{[UIST/\_FIND\_BAD\_PIXELS\_, UIST/\_FILE\_BAD\_PIXELS\_, \_FILE\_MASK\_]}

\subsubsection{\xlabel{data_variance}Data Variance\label{data_variance}}

There is optional data variance creation for all instruments.  By
default only the polarimetry and mid-infra-red NOD\_CHOP family of
recipes have variance processing enabled.  To switch on variance
calculations for the other recipes is a simple edit of the recipe.  See
\begin{latexonly}
Section~\ref{switch_on_data_variance} for instructions.
\end{latexonly}



The initial variance is calculated as follows.

\begin{itemize}
\item
First the readnoise variance for the instrument is applied.  It is
currently a constant for all pixels, which takes the gain, the number
of exposures, and the number of array reads per exposure into account.
For more than one read, $n$, the noise scales by the following factor,

\[   \sqrt{(n(n+1))/(12(n-1))} \]

which is derived from linear-regression theory.
The read noise reduces by the factor $1/\sqrt{\rm{number~of~exposures}}$.
\newline \emph{[\_ADD\_READNOISE\_VARIANCE\_]}

The raw read noise in units of electrons comes from the readnoise calibration
(set within the \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS}) recipe, or
should one not exist, \ORACDR\ selects a representative default.
The \UFTI\ and \IRCAM\ defaults come from the instrument Web pages such as


\begin{latexonly}
\texttt{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/ufti/PARAMETERS.html}
\end{latexonly}
and depend on speed, gain, and read type.  Typical values are as
follows: \ClassicCam\ 40$e^{-}$, \INGRID\ 25$e^{-}$, \IRCAM\ 47$e^{-}$,
\IRIS\ 15$e^{-}$, \ISAAC\ 18.5$e^{-}$, \NACO\ 53$e^{-}$, \NIRI\
50$e^{-}$, \UFTI\ 26$e^{-}$, and \UIST\ 40$e^{-}$.  \Michelle\
reductions merely use an estimate of 1000$e^{-}$.
\newline \emph{[$<$instrument$>$/\_GET\_READNOISE\_]}

The gain---the number of electrons per analogue-to-digital
unit---comes from the data headers.  If for some unusual reason, the
header is absent, the recipe subsitutes suitable time-dependent
defaults.  The gain is 7.5$e^{-}$ for Classic~Cam, 4.1$e^{-}$ for
INGRID,  $\sim$6$e^{-}$ for UFTI and IRCAM, 5.2$e^{-}$ for IRIS2,
4.6$e^{-}$ for ISAAC, 500$e^{-}$ for Michelle, 10$e^{-}$ for NACO,
12.3$e^{-}$ for NIRI, and 15$e^{-}$ for UIST.
\newline \emph{[$<$instrument$>$/\_GET\_GAIN\_]}

\item
The second step is to add the Poisson variance.  This simply adds the
data array to the variance component taking into account the gain of
the detector and the number of exposures.

For read modes where the bias level is not removed, such as CHOP or
STARE, a bias \htmlref{calibration}{calibration_information} frame
must be subtracted first.  If no suitable bias is found, the bias is
deemed to be zero; \ORACDR\ issues a warning that the variance is
wrong, likely overestimated.

The calculations also derive the ratio of the read noise to the Poisson
noise, and reports the percentage of background-limited pixels, \emph{i.e.}\ those where the Poisson noise is greater than the read noise.
\newline \emph{[\_ADD\_POISSON\_VARIANCE\_]}
\end{itemize}

\subsubsection{\xlabel{bias_subtraction}Bias subtraction\label{bias_subtraction}}

In most cases there is no bias to subtract.  Recipes attempt to remove
a bias frame only if the data have variance information and were taken
using a non-ND mode (\emph{{i.e.}}\ where the bias has not already been
subtracted in the instrument data system), whereupon a bias frame, if
available, is subtracted; if, however, there is no bias calibration
the recipe issues a warning issued that the computed variances may be
wrong.  This step occurs between the creation of the readnoise
variance and adding the Poisson variance.
\newline \emph{[\_REMOVE\_BIAS\_]}

\subsubsection{\xlabel{bias_creation}Bias creation\label{bias_creation}}

The Michelle ARRAY\_TESTS recipe averages two bias frames, sets the
observation type to BIAS for the result, and files the mean bias frame
in the calibration system.  The filed frame includes the observation
number in its name.
\newline \emph{[MICHELLE/\_ARRAY\_TEST\_STATISTICS\_, \_FILE\_BIAS\_]}

Likewise the UIST ARRAY\_TESTS recipe averages a group of bias frames
and sets its variance to a population variance estimate.  The mean
bias frame filed with the calibration system includes the group number
in its name.
\newline \emph{[UIST/\_BIAS\_GROUP\_]}

\subsubsection{\xlabel{chopping}Chopping\label{chopping}}

In the thermal and mid-infra-red regimes the sky is varying so rapidly
normal reduction methods are inappropriate.  Instead sky subtraction
is achieved either by frequently oscillating the secondary mirror
between two beams (mid-infra-red), called A and B; or moving the
telescope offsets (thermal) after a short exposure.  The generic term
is \emph{chopping}.  The former are reduced by the
\htmlref{NOD\_CHOP}{NOD\_CHOP} recipes, and the latter by the
\htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK} recipes.

Both methods produce frames with the target image at different
positions on the detector.  The aforementioned recipes difference
these pairs of frames, so that the result has both a positive and
negative image, and a background level close to zero.  The sense of
the subtraction is always the same.  \ORACDR\ subtracts the B beam
from the A beam, and the normal sequence is ABBA.  For the thermal
data, the chopped beam is only notional, but the same terminology
and subtraction sense is used.
\newline \emph{[\_DIFFERENCE\_PAIR\_, \_DIFFERENCE\_PAIR\_SIMPLE\_,\\
\_DIFFERENCE\_CHOP\_BEAMS\_]}

If the telescope is further offset (nodded), the final mosaic of the
differenced frames can have two positive and two negative
representations of the source.  In practice the thermal reductions
register and co-add the nodded frames to compensate for flat-field
errors in \IRCAM.

\subsubsection{\xlabel{post-pre_subtraction}Post-pre subtraction\label{post-pre_subtraction}}

Raw \INGRID\ data comprise a pre-exposure image and a post-exposure
integration.  The pipeline subtracts the former from the latter to
give the measured signal.
\newline \emph{[INGRID/\_DIFFERENCE\_PRE\_POST\_]}

\subsubsection{\xlabel{fits_headers}FITS headers\label{fits_headers}}

For historical reasons, \IRCAM\ headers prior to
\htmladdnormallink{ORAC}{http://www.stsci.edu/stsci/meetings/adassVII/bridgera.html}
were somewhat jumbled, disorganised, and some violated the
\htmladdnormallink{FITS standard}{http://archive.stsci.edu/fits/fits_standard/}.
The pipeline corrects, orders and structures the headers to help
the human reader locate information quickly, and allow complete
conversion to FITS.

For IRCAM, \Michelle, and \UFTI, even since ORAC came online, the raw
headers do not provide a sky co-ordinate system.  \IRIS\ also has an
incomplete sky co-ordinate system supplied in the raw headers.  Using
information in the raw headers, the pipeline creates a FITS world
co-ordinate system using a tangent plane projection in the
\htmladdnormallink{AIPS
convention}{http://www.cv.nrao.edu/fits/documents/wcs/aips27.ps}---this
is quite adequate given the small fields of
view---which it imports into the NDF's WCS component.  Thus
\xref{\GAIA}{sun214}{} and \xref{\KAPPA}{sun95}{} can display these
co-ordinates on overlay grids and axes.  For all these, such as
{\KAPPA}'s \textbf{display} with axes, you may need to select the
appropriate astrometric Frame like this.

\begin{terminalv}
     % wcsframe <your_NDF> frame=sky
\end{terminalv}
where you substitute your NDF's name for {\tt$<$your\_NDF$>$}.  The
mosaics from the pipeline should already have the sky domain set.
\INGRID\ headers are also revised by the pipeline into an AIPS system.
\newline \emph{[$<$instrument$>$/\_CREATE\_WCS\_, $<$instrument$>$/\_GET\_PLATE\_SCALE\_]}

Note that the reference pixel of the equatorial co-ordinates in the
raw headers was until recently only known to a few arcseconds, but now
should be of the order of 0.5 arcseconds.  The pipeline sets empirical
reference pixels now matched by the telescope control system; see
primitive \_CREATE\_WCS\_ for details.  For critical work, you should
tie in your frames with online catalogues, as available through \GAIA.

\subsection{\xlabel{dark_subtraction}Dark subtraction\label{dark_subtraction}}

This is as simple as it sounds.  The dark frame selected through the
\htmlref{calibration system}{calibration_information} must have the same
exposure time and read type as the object frames.  There is no dark
subtraction for chopped data as processed by the
\htmlref{NOD\_CHOP}{NOD\_CHOP} collection of recipes, as the differencing
of nodded pairs of frames makes the operation unnecessary.
\newline \emph{[\_SUBTRACT\_DARK\_, \_GET\_DARK\_NAME\_]}

\subsubsection{\xlabel{dark_creation}Dark creation\label{dark_creation}}
After the preliminary steps including addition of variance, the dark is
merely filed in the calibration system, using the frame number and the
exposure time in the name.

When multiple darks of the same exposure time form part of the same
grouped observation, these darks are averaged before filing with the
calibration system.  Such averaged darks have the group number instead
of the observation number in their names.
\newline \emph{[\_AVERAGE\_DARKS\_ and IRCAM, UFTI, and UIST variants;
\_GET\_DARK\_NAME\_]}

\subsection{\xlabel{flat-fielding}Flat-fielding\label{flat-fielding}}

Some recipes create their own flats from the observations themselves,
called a self flat, or sky frames within a sequence that dithers to
sky, or use a separate observation of a jitter on sky.  (There is no
support for internal calibrations or dome flats in the recipes.)
Whenever a flat is required, recipes access the flat calibration index
to find the most recent flat matching the required attributes such as
filter.

The current recipes for Michelle mid-infra-red observations do not
create or use flat fields.

Creating a flat can be an iterative procedure, involving cleaning,
making a first guess, object masking, proper normalisation, and making
an improved flat.  There are some primitives to bundle the operations
including division by the flat field.
\newline \emph{[\_FLAT\_FIELD\_MASKED\_GROUP\_, \_FLAT\_FIELD\_QUADRANT\_JITTER\_,\\
\_FLAT\_FIELD\_NCOLOUR\_,  \_DIVIDE\_BY\_FLAT\_,
\_DIVIDE\_BY\_FLAT\_FROM\_GROUP\_]}

There are variants for certain families of recipes, which marshall the
various required subgroups of frames before dividing by the flat field.
\newline \emph{[\_DIVIDE\_BY\_FLAT\_CHOP\_SKY\_, \_DIVIDE\_BY\_FLAT\_FROM\_EXTENDED\_,\\
\_DIVIDE\_BY\_FLAT\_NOD\_PAIRS\_]}

\subsubsection{\xlabel{flat_creation}Flat creation\label{flat_creation}}

Frames are optionally cleaned to remove extreme outliers ($\pm$3 or
6$\sigma$ about the mean in 15$\times$15-pixel neighbourhood) iterated
three times, except for thermal recipes
\begin{latexonly}
NOD\_SELF\_FLAT\_NO\_\-MASK
\end{latexonly}


and variants, and \htmlref{NOD\_SKY\_FLAT\_THERMAL}{NOD\_SKY\_FLAT\_THERMAL}.
The data are then normalised, combined pixel by pixel using a broadened median,
and the combined array normalised to a have a mean of one.  It is possible to
use another statistic for the combination, such as a clipped median.
\newline \emph{[\_MAKE\_FLAT\_FROM\_GROUP\_,
\_MAKE\_FLAT\_FROM\_NORMALISED\_GROUP\_,\\
\_MASK\_DEVIANTS\_]}

There are variants for certain families of recipes, which marshall the
various required subgroups of frames.
\newline \emph{[\_MAKE\_FLAT\_CHOP\_SKY\_,
\_MAKE\_FLAT\_FROM\_NORMALISED\_CHOP\_SKY\_, \\
\_MAKE\_FLAT\_EXTENDED\_, \_MAKE\_FLAT\_FROM\_NORMALISED\_EXTENDED\_,\\
\_MAKE\_FLAT\_QUADRANT\_JITTER\_]}

Flats are filed with the calibration system.  \newline \emph{[\_FILE\_FLAT\_]}

\subsubsection{\xlabel{object_masking}Object masking\label{object_masking}}

In recipes which make a flat using the frames taken of the targets,
the so-called self flat, any sources present can bias the flat field,
and result in blotchy mosaics.  The full versions of such recipes, as
opposed to the \_BASIC versions, and
\htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED} greatly reduce
these artifacts using the following algorithm.  After the application
of the approximate self-flat field, an \EXTRACTOR\ inventory is made
of objects having at least 12 connected pixels above 1.0 $\sigma$
above sky.  (The thresholds can be changed in
{\tt\$ORAC\_DATA\_CAL/extractor\_mask.sex} through the DETECT\_MINAREA
and DETECT\_THRESH parameters.) The locations, shapes, orientations and
sizes are used to make a mask. The mask is applied to the
dark-subtracted frames and a new flat created.  As the outer parts of
bright objects often leave residual unmasked blobs, a circular central
occulting mask is used. The diameter is normally 7 arcseconds, but it
can be adjusted through the OCCULT argument of primitive
\_MAKE\_OBJECTS\_MASK\_.  In the
\htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER} recipe the central mask's
diameter equals the length of the shorter side of a quadrant.  The
disadvantage is that the noise is higher within the occulted circle,
and its variance is non-uniform across the central ninth of the mosaic.
You can modify the the central mask size and shape; see primitives
\_FLAT\_FIELD\_QUADRANT\_JITTER\_ and \_MAKE\_OBJECTS\_MASK\_.
\newline \emph{[\_MAKE\_OBJECTS\_MASK\_, \_MASK\_OBJECTS\_,
\_DEFINE\_QUADRANT\_MASKS\_,\\
\_MASK\_QUADRANT\_]}

After masking biases can be introduced as the objects or masks move to
different locations on the detector each with a different response in
the flat field.  This is most pronounced for QUADRANT\_JITTER where a
quadrant of the detector is masked, and IRCAM2 which had a strongly
sloping response. in which the mean flat is considerably different
from the remaining quadrants.  Merely taking a median at each pixel
will preferentially select values from certain frames.  Thus there has
to be an allowance for these systematic differences before the data
are combined to give representative relative intensities.  The first
frame becomes a reference frame against which the recipes scales the
modal values of the other frames.
\newline \emph{[\_NORMALISE\_TO\_MODE\_, \_NORMALISE\_TO\_MODE\_EXTENDED\_,\\
\_CLIPPED\_STATS\_]}

The improved flat typically shows a uniformity at $\sim$0.02\% of the
sky. It is this flat which produces the flat-field frames for
mosaicking.  Systematic errors in the sky---a major uncertainty in
infra-red point-source photometry---are also reduced significantly by
this algorithm.

\xref{\EXTRACTOR}{sun226}{} on occasions underestimate the sizes of objects,
so there is an enlargement factor from 1.0--1.5, defaulting to 1.0,
applied in primitive \_MAKE\_OBJECTS\_MASK\_.  If at high contrast you
find residual dark rings in your flat-fielded images, try adjusting
the ENLARGE argument either in the recipe or the primitive default.  See
\begin{latexonly}
Section~\ref{customising_recipes}
\end{latexonly}


and in particular
\begin{latexonly}
Section~\ref{recipe_primitives}
\end{latexonly}


on how to tailor primitives.

\subsection{\xlabel{field-distortion_correction}Field-distortion Correction
\label{field-distortion_correction}}

The \ISAAC\ instrument exhibits \htmladdnormallink{field distortion}
{http://www.eso.org/instruments/isaac/problems_tips.html} amounting to
2.5 pixels in the corners of the detector.  If not corrected, mosaics
with large dithers have multiple images in the overlap regions.
Therefore recipes resample the image applying the published polynomial
mapping.  This correction also improves the registration.  The sky
co-ordinates are also corrected for the distortion.
\newline \emph{[ISAAC/\_DEFINE\_DISTORTION\_TRANSFORMATION\_,\\
ISAAC/\_APPLY\_DISTORTION\_TRANSFORMATION\_]}

\subsection{\xlabel{bias_variation}Bias variation\label{bias_variation}}

The bias in the ISAAC short-wavelength camera depends upon the detected
flux.  Thus in target frames there is a residual bias not fully
corrected by bias subtraction evident as two steepening ramps
downwards to rows 1 and 513.  An ISAAC-variant recipe corrects for this
as follows.  First within a flat-fielded frame they locate sources and
mask them (as described in
\begin{latexonly}
Section~\ref{object_masking})
\end{latexonly}


Then it forms a one-dimensional profile by masking objects collapsing
along rows using the median, from which it subtracts a clipped mean of
the profile to form a new profile of the bias variations. The
bias-variation profile is then subtracted from each row of the
original flat-fielded frame.
\newline \emph{[ISAAC/\_BIAS\_CORRECT\_GROUP\_]}

NACO has alternating positive and negative signals in its columns,
most noticeable in longer exposures.  The same filter as ISAAC, except
it collapses along columns and does not mask objects, is applied to
the flat-fielded frames.
\newline \emph{[NACO/\_BIAS\_CORRECT\_GROUP\_, \_REMOVE\_COLUMN\_ROW\_STRUCTURE\_]}

\subsection{\xlabel{sky_subtraction}Sky Subtraction\label{sky_subtraction}}

In general the recipes do not sky-subtract in the literal sense of
pixel-by-pixel subtraction of a sky frame, or better of some median of
jittered sky or even target frames.  Such recipes could readily be
created if there is a demand.  Instead the sky signature is usually
accounted for in the \htmlref{flat-fielding}{flat-fielding}.
Therefore the mosaics generally have the sky signature removed, but
not base level.

The sky varies rapidly in the thermal and mid-infra-red, so dithered
pairs, or nodded and dithered pairs respectively are differenced to
attempt to remove the sky signature.  See Section~\ref{chopping}.
\newline\emph{[\_DIFFERENCE\_PAIR\_]}

Another recipe which performs a pixel-by-pixel sky subtraction is
\htmlref{SKY\_AND\_JITTER}{SKY\_AND\_JITTER}.  It's hardly used and
not recommended because it demands a very stable sky, since only one
sky frame is observed at the start of the observation; and a region of
sky devoid of objects to avoid `holes' appearing in the subtracted
target frames.
\newline \emph{[\_SUBTRACT\_SKY\_SKY\_AND\_JITTER\_]}

Another form of sky subtraction is to remove a representative sky
level.  This benefits imaging of extended sources whose scale exceeds
the dither pattern or even the detector's field of view.  The normal
procedure is to alternate between dithered integrations on target and
a region of sky.  The representative statistic is a multiply clipped
mean at 2, 2.5, 3, then 3 standard deviations, which effectively gives
the mode, and so is not biased by resolved sources.  At present the
\htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER} and
\htmlref{EXTENDED\_$n\times$$m$}{EXTENDED\_5x5} recipes take the average
of the modes of bracketted sky frames.  For offline processing it
would be possible to fit a spline, say, to the modes and provide a
better subtraction.  Under normal conditions, where the sky level is
not varying rapidly or suddenly because of cirrus, the algorithm works
well, especially over longer integrations.
\newline \emph{[\_FORM\_SKY\_LEVELS\_, \_NORMALISE\_TO\_MODE\_EXTENDED\_,
\_CLIPPED\_STATS\_,\\
\_SUBTRACT\_SKY\_CHOP\_SKY\_, ESO/\_SUBTRACT\_SKY\_CHOP\_SKY\_, \\
\_SUBTRACT\_SKY\_EXTENDED\_]}

\subsubsection{\xlabel{polarimetry_extraction_and_sky_subtraction}Polarimetry
Extraction and Sky Subtraction\label{polarimetry_extraction_and_sky_subtraction}}

The polarimetry recipes are designed to work with a Wollaston prism.
This divides the signal into four partitions.  These are ordinary and
extraordinary beams (usually abbreviated to e and o beams) for the
target and a region of nearby sky.  Thus the raw data comprise four
strips with an aspect ratio of about 6.

These partitions are normally separated by a mask, but the recipes do
not depend on having the mask to extract the various regions say by
detecting the edges.  For each instrument the pixel limits of each
region are fixed.  The current target limits are 30\% to 70\% of the
width of the long axis of each region to allow for some reasonable
dithering of point sources, since there are usually only three jitter
positions, while making mosaics with few pixels not derived from all
contributing jittered frames.  For extended sources these limits
change to 10\% to 90\% to include as much object as possible with
smaller dithers and alternating to blank-sky regions.  Thus the limits
define a section 40\% or 80\% of the width of the frame, roughly
centred on the source.  The limits on the sky regions are 1\% to 99\% of
the frame width, mainly to avoid unreliable and pathological pixels at
the detector's edge.
\newline \emph{[$<$instrument$>$/\_DEFINE\_POL\_REGIONS\_]}

The recipes extract the target regions into e- and o-beam frames.  The
modes (the means after clipping at 2, 3, 3 standard deviations) of the
e- and o-beam sky regions are subtracted from their corresponding
target beam, incorporating the uncertainty of each sky level in the
corresponding target beam's variance array.  For an extended-source
observation, the sky levels are determined from the two corresponding
regions for each beam in the following sky frame.
\newline \emph{[\_SUBTRACT\_SKY\_POL, \_SUBTRACT\_SKY\_POL\_EXTENDED\_]}

\subsection{\xlabel{automatic_registration}Automatic
Registration\label{automatic_registration}}

This makes an inventory of the sources above a threshold in each
frame.  It then performs a \xref{pattern
recognition}{sun139}{mosaicing} to identify common features in
jittered frames.  If the fraction of common objects is under 40\% or
the total is fewer than three, the registration fails, and so the
script resorts to reading the telescope offsets stored in the
\FITSref\ headers, or matching a central bright object in certain
recipes.  Using telescope offsets can lead to trailed sources, as
occurred with the \xref{{\footnotesize IRCAMDR} package}{sun41}{}. The
improved registration leads to the detection of fainter sources and
more-accurate measurement thereof.
\newline \emph{[\_GENERATE\_OFFSETS\_ invoked within several wrappers tied to
various families of recipes, \_FIND\_APPROX\_OFFSETS\_, \_TELE\_OFFSETS\_,
\_GENERATE\_TELE\_OFFSETS\_,\\
\_GET\_CARTESIAN\_TELESCOPE\_OFFSETS\_]}

To make use of the best information, registration using more than one
of the above methods is permitted.

There is also a new but not extensively tested option in which
matching is performed only within overlapping regions as specified
from the approximate world co-ordinate system, and a single match
within 12 pixels is allowed to define the offsets between frames. This
modification should allow more registrations using sources than from
telescope offsets, which merely assist in the process.  Since the
robustness is unknown at present, this option is currently disabled by
default.  The easiest way to switch it on, is to change the
the default value of the SKYREG argument primitive \_GENERATE\_OFFSETS\_
to 1.  See
\begin{latexonly}
Section~\ref{customising_recipes}
\end{latexonly}


for generic instructions to make a private \_GENERATE\_OFFSETS\_.

\NACO\ has a tiny plate scale; even with adaptive optics the tolerances
(minimum number of pixels and the percentile threshold) searching for
fiducial sources are increased, and by default the sky registration is
enabled.
\newline \emph{[NACO/\_GENERATE\_OFFSETS\_]}

\subsubsection{\xlabel{moving_targets}Moving Targets\label{moving_targets}}

For a moving target, it is possible to permit the telescope to track
at sidereal rate, and adjust the telescope offsets for the motion of a
slowly moving target, \emph{i.e.}\ one that stays within the field
within an observation group.  Registration uses the revised
offsets and in the mosaic the stars trail while the object does not,
and so can be seen and measured more easily.

At present the ephemeris is via a pre-prepared text file, given by
environment variable \goodbreak \texttt{ORAC\_EPHEMERIS}, if defined, otherwise
{\tt\$ORAC\_DATA\_OUT/target\_ephemeris.dat}.  See one of the
moving-target recipes, say
\htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT}, for
more details.  Once the ephemeris is available as a web service, the
file could become merely a backup; this would automate the process and
so the observer would not have to prepare the file at altitude just
before the epoch of observation.
\newline \emph{[\_ADJUST\_OFFSETS\_TO\_MOVING\_TARGET\_]}

\subsubsection{\xlabel{polarimetry_registration}Polarimetry
Registration\label{polarimetry_registration}}

Registration involves both the dithered observations as normal, but also
the e- and o-beams at each waveplate angle must align.  To aid the
latter an approximate pixel displacement between the e- and o-beams
from empirical data is set for each filter, as the displacement is
wavelength dependent.  Even an approximate offset almost invariably
leads to successful registration using the central source.
\newline\emph{[\_GENERATE\_OFFSETS\_JITTER\_POL\_, \_GENERATE\_OFFSETS\_POL\_]}

\subsection{\xlabel{mosaicking}Mosaicking\label{mosaicking}}

This is fully automated.  No longer do you have to measure
painstakingly centroids and manually tile to form mosaics from the
jittered frames.  The jitter offsets are sufficiently small to permit
shift of Cartesian co-ordinates to register.  The offsets are derived
from the automatic registration.  No correction for the detector
orientation is applied, since it degrades the quality of the data,
despite the small rotation
\begin{latexonly}
($\sim$1$\dgs$)
\end{latexonly}


normally involved.  Allowance for this misalignment with the cardinal
directions will be through the \htmladdnormallink{FITS world co-ordinate
system}{http://fits.gsfc.nasa.gov/documents.html\#WCS}. In the meantime
should you need the rotation angle, pipe the output of KAPPA's
\xref{\textbf{fitslist}}{sun95}{FITSLIST} function into grep.

\begin{terminalv}
      % fitslist <your_frame> | grep CROTA2
\end{terminalv}

The flat-fielded frame can either be resampled to give sub-pixel
registration, or to the nearest pixel.  The latter is much faster and
is adequate for most uses of \UFTI, \UIST, thermal \IRCAM, and \Michelle.  It also
has the advantage of not smoothing the data and introducing covariance
into the data errors.  For older
undersampled IRCAM3 data
\begin{latexonly}
(0.$\uarcs$286
\end{latexonly}


per pixel) and for INGRID
\begin{latexonly}
(0.$\uarcs$235)
\end{latexonly}


resampling has some merit.

The mosaicking uses the \xref{\CCDPACK\ algorithm}{sun139}{mosaicing}
of its \xref{\textbf{makemos}}{sun139}{MAKEMOS} command.  Only zero-point
shifts of intensity are applied to the resampled frames to create the
mosaic.  For most cases the comparison is of the sky levels as sky
pixels dominate.  This comparison is repeated for all pairs.  \textbf{makemos} then finds the most mutually consistent set of additive
corrections, weighting appropriately, to make the smoothest mosaic
given the data. The first frame, which for the \UFTI\ execs is the
central (offset 0,0) frame, has no additive correction applied.  The
mosaic generation adjusts the zero-point of the jittered frames.
Another way of looking at it is that mosaicking attempts to remove the
sky variations.  The additive corrections are normally quite small,
like a few tenths of a count to a few counts.  However, over longer
integrations or in the thermal regime they can amount to a few score.
A mosaic pixel value is the mean of all the adjusted contributing
pixel values at that location.  It is possible to select other
statistics for the contributing pixels, such as the median, through
the METHOD argument of the \_MAKE\_MOSAIC\_ family of primitives.

There is no normalisation to counts per second in the mosaic. The
mosaic's signal corresponds to that of the first frame, thus the
exposure time of the mosaic is that of one individual frame.  The
recipes assume that you have used their corresponding `execs'
or`sequences', and hence have not changed the exposure time during a
jitter.  The exposure time (header EXP\_TIME [UFTI/UIST/Michelle],
EXPOSED [IRIS2], EXPTIME [Classic Cam/INGRID/ISAAC/NACO/-NIRI] or
DEXPTIME [IRCAM]) is propagated from the first frame to the mosaic.
Where multiple frames combined to create a mosaic pixel the
signal-to-noise ratio corresponds to the combined integration time.
The integration time (keyword INT\_TIME [UFTI], TOTALEXP [IRIS2], or
EXPOSED [IRCAM]) is the number of coadds times the exposure time per
coadd.

Depending on the recipe, the mosaic may be trimmed to the dimensions
of a raw frame.  Mosaicking removes virtually all the bad pixels for
standard stars where the jitter offsets are small.

A mosaic forms for each cycle of the recipe, \emph{{e.g.}}\ all four
frames in a \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.  For
multiple cycles, an integrated `grand' mosaic forms of improving
signal-to-noise.  To avoid the build up of bad pixels from cosmic
rays, bad pixels are interpolated before the addition.  This may
result in some strange stripes in the top-left corner of UFTI frames
where no interpolation can occur.  Those pixels are bad in all frames
and should be ignored. The exposure-time header for the integrating
mosaic is the sum of the exposure times of the contributing mosaics.
Again the signal is not divided by the exposure time.  \newline
\emph{[\_MAKE\_MOSAIC\_ and invoked within several wrappers (all with
the \_MAKE\_MOSAIC\_ prefix) tied to various families of recipes]}

\subsubsection{\xlabel{polarimetry_resampling}Polarimetry
Resampling\label{polarimetry_resampling}}

To permit the calculation of the Stokes parameters, polarimetry recipes
resamples each frame using non-integer Cartesian offsets, or merely
finds the offsets between frames to the nearest pixel and shifts the
origin.  The mosaic extends to include all pixels in contributing
the frames, however, in practice there should be at most one pixel
variation in dimensions.
\newline\emph{[\_RESAMPLE\_MOSAICS\_]}

\subsection{\xlabel{polarimetry_parameters}Polarimetry
Parameters\label{polarimetry_parameters}}

These are outlined in the ``Output Data'' section of the polarimetry
recipes such as \htmlref{POL\_JITTER}{POL\_JITTER}, and are calculated
using standard formulae and the methods of \xref{\POLPACK}{sun223}{}.
A calibration correction (polrefang) measured in degrees clockwise is
applied to the vector direction for the orientation of the analyser
with respect to north based upon {\UKIRT}'s
\htmladdnormallink{IRPOL}{http://www.jach.hawaii.edu/JACpublic/UKIRT/instruments/irpol/irpol.html}
instrument.  Current values are $-24$ for Michelle and UIST, $-9$ for
UFTI, and $-96.3$ for IRCAM.  For other instruments, the offset can be
determined using polarimetric-standard-star calibrations.
\newline\emph{[\_CALC\_STOKES\_, MICHELLE/\_CALC\_STOKES\_NOD\_CHOP\_]}

\subsection{\xlabel{near_infra-red_aperture_photometry}Near Infra-red Aperture
Photometry\label{near_infra-red_aperture_photometry}}

The recipes with an \_APHOT suffix (except
\htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT}) perform aperture
photometry on the mosaic and the contributing flat-fielded frames.
The method assumes that the target, usually a standard star, is
approximately centrally located after allowing for the jitter offsets.
If you have data where the star lies outside the aperture, it is
possible to apply an offset.  See the RAOFF and DECOFF arguments of
primitive \_FIXED\_APERTURE\_PHOTOMETRY\_ in \_APHOT\_MAG\_ to adjust
the aperture's position.  The thermal
\htmlref{chopped}{chopping} data have sources displaced from the centre, but
the reductions allow for the symmetric offsets about the mean jitter
position.  For UIST thermal data, the search algorithm does not assume
a central or centrally symmetric distribution of the positive and
negative signals.

Residual bad pixels (usually in the individual flat-fielded frames
are removed by median filtering.  This does leave a bias in the wings
of stars, but certainly the underestimate is far less than ignoring
the bad pixels, and is typically far less than the other photometric
errors.

The photometry is through a circular aperture located at the centroid
of the source, with the sky measured from a concentric annulus outside
the aperture.  The default aperture size is 5 arcseconds (3 arcseconds
for NACO).  The annulus diameters are 6.5 to 10 arcseconds (all
instruments but UFTI and NACO), 6.5 to 12.5 arcseconds for \UFTI, and
3.9 to 6 arcseconds for \NACO.  The default estimator of the sky flux is
the mode calculated from $3*{\rm median}-2*{\rm mean}$ and Chauvenet's
rejection criterion.  The photometry accounts for fractional pixels at
the aperture edge but without allowance for the local gradient.

The magnitudes are given by the expression $-2.5 $\lsk$
$log10(abs(counts) per second exposure time).  Therefore negative
sources can be measured too, as presented by the thermal photometry
recipe \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}.
The photometry also yields an internal error determined from
the sky variance.

A case- and space-insensitive comparison of the object name with the
entries in a table provides a catalogue magnitude for a standard star
in $I$, $Z$, $J$, $H$, or $K$ for all instruments, and in $L$ or $M$
for \IRCAM\ and \ISAAC.  Also a mean extinction is applied for the
mean of the start and end airmasses.  Thus the primitive calculates an
approximate zero point.  Note that ISAAC and NACO standard stars
include additional objects not present in the \htmladdnormallink{UKIRT
faint-standard list}{http://www.jach.hawaii.edu/JACpublic/UKIRT/astronomy/calib/faint_stds.html}
or \htmladdnormallink{Persson's HST
list;}{http://www.ociw.edu/lco/dupont/instruments/manuals/ir/standards/hst.html}
for these the magnitude and derived zero point will not be determined
automatically.  For accurate photometry the actual extinction
coefficients should be determined. As the output from the photometry
is a \xref{small text list}{sun190}{STLREF}, you can use
\xref{\textbf{catphotomfit} command}{sun190}{PHOTCAL} of the \CURSA\ package
to achieve this.  The units and meanings of the columns are documented
within each small text list.

The seeing is estimated for each frame and the mosaic by fitting a
two-dimensional Gaussian to the star, although in good seeing the
UKIRT images are more centrally concentrated than a Gaussian.  The
full-width-half-maximum so derived is also tabulated in the small text
list.
\newline \emph{[\_APHOT\_MAG\_, \_APHOT\_MAG\_NCOLOUR\_, \_NOD\_APHOT\_MAG\_
(plus NACO and UIST variants), \_FIXED\_APERTURE\_PHOTOMETRY\_,
\_MAKE\_PHOTOMETRY\_TABLE\_, \\
\_GET\_FILTER\_PARAMETERS\_ (and several instrument variants), \\
\_PERSSON\_STANDARD\_MAGNITUDE\_, \_UKIRT\_STANDARD\_MAGNITUDE\_, \\
\_STANDARD\_MAGNITUDE\_ (and instrument-specific variants),
\_CLIPPED\_STATS\_, \\
\_FIND\_SOURCE\_CENTROID\_, \_GET\_FRAME\_CENTRE\_]}

\subsection{\xlabel{mid-infra-red_aperture_photometry}Mid-infra-red Aperture
Photometry\label{mid-infra-red_aperture_photometry}}

This is similar to \htmlref{near infra-red aperture
photometry}{near_infra-red_aperture_photometry}.  The main difference
is the source measured.  Rather than measuring each positive and
negative image, \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT}
integrates the average flux of the one or two pairs of positive and
negative images in the chopped and nodded mosaic.  The number of pairs
depends on the chop-and-nod orientations and the nod throw.  The four
(or two) images are first registered using their centroids; extracted
with a symmetric neighbouring background, but without any duplication
of pixels from the original mosaic; and finally combined, averaging to
preserve the flux per unit time.  The exposure-time header, therefore,
remains that of the mosaic.

The aperture size is 5 arcseconds.  The background is determined
from an annulus with an inner diameter of 7.5 arcseconds and an
outer diameter of 15 arcseconds enclosing the source.  The Michelle chip
characteristics and the UKIRT chop throw limit the area of this
combined-image mosaic---normally a 15-arcsecond square---leaving
comparatively little background.  Recommended apertures and background
regions may change in the light of experience with Michelle.  Already
in below-average seeing, it's evident that a 6-arcsecond circle will
leave some signal in the background.

The object name is compared with a 28-member \htmladdnormallink{catalogue of 10- and
20-micron standards}{http://www.jach.hawaii.edu/JACpublic/UKIRT/astronomy/calib/IRTF_NQ.html},
a handful of which are known optical semi-regular variable stars.  In
addition to deriving magnitudes, the recipe calculates an approximate
flux in Janskys.  It is approximate because being an \emph{absolute}
measurement, it does require a magnitude zero point to be applied to
the \emph{relative} instrumental magnitude. At the time of writing this
zero-point is only roughly known, so the default fluxes should be
taken with a pinch of salt.  The flux is not yet written to the
results file.  If you have determined the zero point from standards,
you can rerun the pipeline for your target observations with that zero
point assigned to argument ZP of primitive \_NOD\_CHOP\_APHOT\_MAG\_
invoked within recipe NOD\_CHOP\_APHOT.  See
\begin{latexonly}
Section~\ref{customising_recipes}
\end{latexonly}


for instructions to make and use a private version of a recipe.

There is an approximate extinction correction applied using a
coeeficient of 0.18, because the coefficients for all but one of the
various $N$ and $Q$ filters have yet to be determined.
\newline \emph{[\_NOD\_CHOP\_APHOT\_MAG\_, \_FIXED\_APERTURE\_MIDIR\_PHOTOMETRY\_,\\
\_MAKE\_PHOTOMETRY\_TABLE\_, \_GET\_FILTER\_PARAMETERS\_,\\
\_UKIRT\_MIDIR\_STANDARD\_MAGNITUDE\_, MICHELLE/\_STANDARD\_MAGNITUDE\_,
\_FIND\_SOURCE\_CENTROID\_, \_CLIPPED\_STATS\_]}

\subsection{\xlabel{improving_the_signal-to-noise_of_mid-infra-red_data}Improving
the signal-to-noise of Mid-infra-red
Data\label{improving_the_signal-to-noise_of_mid-infra-red_data}}

The Michelle electronics can leave an uneven mosaic with vertical
banding from bias variations and horizontal ripple patterns from
electronic pickup.  Therefore, Michelle NOD\_CHOP recipes subtract the
median along each column of the mosaic, then subtracts the median
along each row.  This cleaning aids the visibility of faint sources.

In the mid-infra-red, the sky signal is vastly greater than the signal
than even the brightest sources.  While the nodding removes the bulk
of the sky signal, the sky noise remains, still swamping the signal
from a faint source.  Integrating over many nod-chop cycles is needed,
and the real-time display of \ORACDR\ does permit interactive review
of the signal-to-noise in \GAIA\ so observers can curtail data collection
when the required contrast is achieved.  Averaging the positive and
negative signals and neighbourhoods into a combined signal (\emph{{cf.}}\
\begin{latexonly}
Section~\ref{mid-infra-red_aperture_photometry}
\end{latexonly}


only helps by a factor of two (or $\sqrt{2}$ for a single positive and
negative pair).  Recipe \htmlref{NOD\_CHOP\_FAINT}{NOD\_CHOP\_FAINT}
smooths the combined quadrant with a 4-by-4-pixel neighbourhood
running average filter to help reveal faint sources.  Note that the
source centroids are not used for registration as the signal is
usually too weak.

While smoothing reveals the sources, it is not sufficient. There is
also a confusion issue.  The chopping can bring positive and negative
sources actually located beyond the final quadrant to within it.
There is an option of the \_COMBINE\_CHOPPED\_SOURCE\_ primitive,
called by recipe NOD\_CHOP recipes, which attempts to clarify which
sources are actually present in the quadrant by forming a quality map.
Each quality pixel is the sum of the four corresponding pixel values
divided by their absolute values, after changing sign for the
quadrants containing the negative images.  In the map +4 indicates
that a pixel had positive contributions from the positive quadrants
and negative signals from the negative quadrants.  A quality of +4
strongly implies that the signal is really at the sky location
indicated.  Thus it helps to discriminate from sources which have been
chopped into view, for which there are no positive or negative
counterparts (values +/$-$2) or noise (0, +/$-$2).  Around the sky (which
should be near zero) noise randomises the quality measurement,
therefore smoothing should be used in conjunction with the quality
map.
\newline \emph{[\_COMBINE\_CHOPPED\_SOURCE\_, \_REMOVE\_COLUMN\_ROW\_STRUCTURE\_,\\
\_REMOVE\_COLUMN\_ROW\_STRUCTURE\_SCAN\_, FIND\_SOURCE\_CENTROID\_,\\
\_GET\_CHOP\_OFFSETS\_, \_GET\_FRAME\_CENTRE\_]}

To create a quality map at each cycle, you should set argument QMAP=1
and SMOOTH$>1$.  For example in NOD\_CHOP\_FAINT, append \texttt{" QMAP=1"}
to the line

\begin{terminalv}
      _COMBINE_CHOPPED_SOURCE_ METHOD=median CENTROID=0 SMOOTH=4 CLEAN=1
\end{terminalv}

\subsection{\xlabel{catalogue_generation}Catalogue Generation\label{catalogue_generation}}

The recipes with a \_CATALOGUE suffix create a source catalogue from
the mosaic using \EXTRACTOR.  The catalogue includes objects having at
least 12 connected pixels above 1.0 $\sigma$ above sky.  The catalogue
is written in \htmladdnormallink{ARK Cluster
format}{http://www.astro.ex.ac.uk/people/timn/Catalogues/format.html},
with a field ID in column 0 (this value is typically zero); an object
ID in column 1; right ascension in columns 2, 3, and 4; declination in
columns 5, 6, and 7; x and y positions in columns 8 and 9;
uncalibrated magnitude in column 10; the error in magnitude in column
11; and a quality flag in column 12 (this value is typically zero).
The magnitudes are given by the expression $-2.5 \lsk$log10(counts)
per second exposure time.

As the final mosaic has varying noise characteristics, with higher noise
regions at the edges, the detection limit varies across the mosaic.
Fainter objects can be detected in the central region than near the edges and
corners.
\newline \emph{[\_CREATE\_SOURCE\_CATALOGUE\_, \_GET\_CATALOGUE\_NAME\_]}

\subsection{\xlabel{estar_integration}eSTAR Integration\label{estar_integration}}

\ORACDR\ is also integrated with the eScience Telescopes for Astronomical
Research (\eSTAR) project, which is designed to automatically detect and
follow up on transient astronomical objects using manned and robotic
telescopes. Using the catalogue generated in
\begin{latexonly}
Section~\ref{catalogue_generation}
\end{latexonly}


\ORACDR\ will automatically send a trigger to the \eSTAR\ network
containing a FITS file of the final mosaic and the catalogue.  This
step is only done when an observation is taken as part of an \eSTAR\
project, {\tt{i.e.}} there is a RMTAGENT header and its value is ESTAR.
\newline \emph{[general/\_TRIGGER\_ESTAR\_, \_SET\_REMOTE\_AGENT\_HEADER\_]}

\subsection{\xlabel{tidying}Tidying\label{tidying}}

Each recipe has a tidy procedure, which removes unnecessary
intermediate frames when the recipe no longer requires them.  Retained
are the raw data, flat-fielded frames, differenced pairs (for chopped
data), and the mosaics.  Most of the intermediate small text files are
removed in individual primitives, but some registration-related files
do persist until the tidy script cleans up.  If you need to retain the
intermediate files, comment out (\#) the final instruction of the recipe,
which calls the tidy primitive, and follow the instructions in
\begin{latexonly}
Section~\ref{customising_recipes}
\end{latexonly}


to make and use a private version of a recipe, or set the {\tt\$ORAC\_KEEP}
environment variable to 1.
\newline \emph{[$<$recipe\_family$>$\_TIDY\_, such as \_EXTENDED\_TIDY\_,
\_JITTER\_SELF\_FLAT\_TIDY\_,\\
\_NOD\_CHOP\_TIDY\_, \_REDUCE\_DARK\_TIDY\_; general/\_DELETE\_A\_FRAME\_,\\
general/\_DELETE\_INTERMEDIATE\_GROUP\_FILES\_,
general/\_DELETE\_TEMP\_FILES\_,\\
general/\_DELETE\_TEMP\_GROUP\_FILES\_, \_IMAGING\_GOODBYE\_]}

\section{\xlabel{customising_recipes}Customising
Recipes\label{customising_recipes}}

If you wish to write your own data-reduction recipes, you should
consult the \emph{\ORACDR\ Programmer's Guide\/}
(\xref{SUN/233}{sun233}{}).  However, for most purposes, observers
wishing to modify existing scripts can get by without this document.

A easier-to-use tailoring system to control parameters and primitive
arguments from the command line and `personal' style files is under
consideration.

\subsection{\xlabel{search_paths}Search paths\label{search_paths}}

\ORACDR\ allows you to create your own recipes and primitives, or
modify those provided as part of the package.  In either case you must
tell \ORACDR\ where your recipes and/or primitives are stored.  This
is achieved through two environment variables.  {\tt\$ORAC\_RECIPE\_DIR}
should equate to the directory containing your recipes.
\texttt{\$ORAC\_PRIMITIVE\_DIR} specifies the directory containing your
primitives.  Here's an example.

\begin{terminalv}
      % setenv ORAC_RECIPE_DIR /home/user/drmoan/recipes
      % setenv ORAC_PRIMITIVE_DIR /home/user/drmoan/primitives
\end{terminalv}

Once these environment variables are defined, \ORACDR\ first looks in
\texttt{\$ORAC\_RECIPE\_DIR} or \texttt{\$ORAC\_PRIMITIVE\_DIR} to find a recipe or
primitive respectively.  If the script is absent, \ORACDR\ looks in
the standard \texttt{\$ORAC\_DIR} directories.

\subsection{\xlabel{anatomy_of_an_imaging_recipe}Anatomy of an imaging recipe}

There are documentation modules---a Starlink style between \verb/#+/ and
\verb/#-/ delimiters at the head, and a Perl POD (Plain Old
Documentation) at the foot.  Between these is the code.  This consists
of calls to primitives, sometimes with arguments.  Primitives have
uppercase names preceded and terminated by underscores, such as
\_DIVIDE\_BY\_FLAT\_.

\subsubsection{\xlabel{hello_primitives}Hello
primitives\label{hello_primitives}}

The first of these primitives is \_IMAGING\_HELLO\_.
It contains instrument-specific code and initialisation.  It is
best left alone.  See


\begin{latexonly}
Section~\ref{preliminaries}
\end{latexonly}
for a description of what this primitive does for each instrument.

Second there is a recipe-specific primitive such as
\_JITTER\_SELF\_FLAT\_HELLO\_.  This sets up \CCDPACK,
\htmlref{sets directives}{steering_primitive} when to perform certain
operations, optionally \htmlref{create variances}{data_variance},
removes any bias, and \htmlref{edits the FITS headers}{fits_headers}.

Two things you might wish to change in the recipe {\tt\_HELLO} script are
listed below.

\begin{itemize}

\item Change the extent of the images.  If there is an instrumental
defect in some peripheral rows you might not want to use the full
bounds as given by headers \texttt{ORAC\_X\_LOWER\_BOUND},
\texttt{ORAC\_X\_UPPER\_BOUND}, \texttt{ORAC\_Y\_LOWER\_BOUND},
\texttt{ORAC\_Y\_UPPER\_BOUND}.  Suppose you wanted to trim off the top
three rows you could change the line.

\begin{terminalv}
    my $y2 = $Frm->uhdr( "ORAC_Y_UPPER_BOUND" );
\end{terminalv}
to
\begin{terminalv}
    my $y2 = $Frm->uhdr( "ORAC_Y_UPPER_BOUND" ) -3;
\end{terminalv}

\item
\xlabel{switch_on_data_variance}\label{switch_on_data_variance}
Switch on error propagation.  To save time at the telescope, the
pipeline does not keep track of the errors per pixel (except for the
polarimetry recipes with names starting ``POL'' and the NOD\_CHOP
series).  If you wish to know realistic errors for your data, in the
recipe switch on the USEVAR argument for the recipe's {\tt\_HELLO}
primitive.  Here is an example for the
\htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE} recipe.

\begin{terminalv}
    _BRIGHT_POINT_SOURCE_HELLO_ USEVAR=1
\end{terminalv}

\end{itemize}

\subsubsection{\xlabel{steering_primitive}Steering
primitive\label{steering_primitive}}

Within a recipe's {\tt\_HELLO} primitive, a `steering' primitive is invoked.
These are best left well alone.  They control when the various
operations are performed.  See


\begin{latexonly}
Appendix~\ref{steering_headers}
\end{latexonly}
for more details.  What you can safely adjust are the
configurable steering parameters listed in the recipe documentation.
In the main these parameters set the number of frames processed in a
cycle through the recipe.  The parameters are passed by argument
through the recipe's {\tt\_HELLO} script to the steering primitive.

Suppose that for some reason an observation of a nine-point jitter
self flat was aborted after seven positions.  If you try the recipe
stored in the headers some processing will occur, but it will not
include mosaic creation.  The final steps inclusing mosaic creation
occur once all nine frames are dark subtracted.  Now there are no
seven-point recipes to substitute on the command line.  You could make
your own seven-point recipe to reduce those data.  First make a new
recipe by copying the standard one.

\begin{terminalv}
    % cd $ORAC_RECIPE_DIR
    % cp $ORAC_DIR/recipes/imaging/JITTER_SELF_FLAT ./JITTER7_SELF_FLAT
\end{terminalv}
Next edit JITTER7\_SELF\_FLAT and alter the line

\begin{terminalv}
      _JITTER_SELF_FLAT_HELLO_
\end{terminalv}
to become

\begin{terminalv}
      _JITTER_SELF_FLAT_HELLO_ NUMBER=7
\end{terminalv}
The recipe will then generate the self flat, flat field and make the
mosaic once the seventh frame is dark-subtracted.

Recipes are stored in {\tt\$ORAC\_DIR/recipes/imaging}; and for a few
instrument-specific recipes in {\tt\$ORAC\_DIR/recipes/$<$instrument$>$},
where {\tt$<$instrument$>$} is \texttt{IRCAM}, \texttt{MICHELLE}, \texttt{UFTI}. \texttt{IRIS2}, \texttt{ISAAC}, or \texttt{INGRID}.  See


\begin{latexonly}
Appendix~\ref{instrument_recipe_notes}
\end{latexonly}
for some details.

\subsubsection{\xlabel{recipe_primitives}Recipe primitives\label{recipe_primitives}}

After the steering primitive we come to the recipe-specific scripts
that actually perform the recipe.  The most likely and easiest things
you would change are to add arguments or modify argument values of the
primitives in the recipes.  For instance, you might wish to change the
aperture diameter for the aperture photometry.  To alter to a
4-arcsecond aperture, change the APERTURE argument's value of the
\_APHOT\_MAG\_ primitive like below.

\begin{terminalv}
      _APHOT_MAG_ APERTURE=4
\end{terminalv}

To obtain details of a primitive's arguments, use the \textbf{oracman}
or \textbf{perldoc} command.  Thus

\begin{terminalv}
      % oracman _MAKE_MOSAIC_
\end{terminalv}
will display the documentation for primitive \_MAKE\_MOSAIC\_.  Space
does not permit inclusion of the documentation of the many primitives
in this manual.  Most of primitives' source code is stored in \texttt{\$ORAC\_DIR/primitives/imaging}; the instrument-specific ones are
situated within \texttt{\$ORAC\_DIR/primitives/$<$instrument$>$}, where
{\tt$<$instrument$>$} is \texttt{UFTI}, \texttt{UIST}, \texttt{MICHELLE}, \texttt{IRCAM}, \texttt{IRIS2}, \texttt{ISAAC}, or \texttt{INGRID}; and there are a few
general scripts in \goodbreak\texttt{\$ORAC\_DIR/primitives/general}.

While the simplest primitives just invoke a Starlink task, and updates
just that and are amenable to customisation, some are quite complex
especially for the registration.  They may invoke other primitives,
manipulate parameters and small data files so that the various tasks
connect to cope with a variety of circumstances.  The most likely
change you will want to make is to change the parameter values of a
Starlink task.  Armed with the reference documentation for the
application, say with a \texttt{findme $<$application$>$}, it is easy
to change values or append further parameters.

Here is an example.  Let us suppose you wanted to combine frames to
make a self flat, not with the median, since you have heard that a mean
trimmed of the most-extreme tenth of the values gives better results.
First copy \_MAKE\_FLAT\_FROM\_GROUP\_ to your primitives directory.

\begin{terminalv}
      % cp $ORAC_DIR/primitives/imaging/_MAKE_FLAT_FROM_GROUP_ $ORAC_PRIMITIVE_DIR
\end{terminalv}
Using an editor, find the first line in your copy of
\_MAKE\_FLAT\_FROM\_GROUP\_ commencing \texttt{\$hidden}.  It should be
as follows.

\begin{terminalv}
      $hidden = "method=median sigmas=2.0 reset accept";
\end{terminalv}
Change this to

\begin{terminalv}
      $hidden = "method=trimmed alpha=0.1 sigmas=2.0 reset accept";
\end{terminalv}
to effect the change of statistic.  There is in fact a second line
assigning variable \texttt{\$hidden} depending on argument CLEAN, and you
should make the same alteration there too.

If there is demand, additional arguments could be provided for
primitives, to simplify control.  Please contact the author if you
have suggestions for arguments and new recipes, or need help
customising your \ORACDR\ scripts.

\subsection{\xlabel{index_files}Index files\label{index_files}}

Once the pipeline has run for a bit you will find text files in \texttt{\$ORAC\_DATA\_OUT} called \texttt{index.flat}, \texttt{index.dark} amongst
others.  These list the calibration frames.  \ORACDR\ uses these to
find the most-recent, appropriate calibration.  For example, a flat
requires that the filter of the flat matches that of the frame being
flat fielded, and a dark must have the same exposure time as the
target frame; and both must have been taken in the same instrument
mode.

Here is an example of a flat index.

\begin{terminalv}
#FILTER MODE ORACTIME RDOUT_X1 RDOUT_X2 RDOUT_Y1 RDOUT_Y2 WPLANGLE
flat_Lp98_23 Lp98 STARE 13.3484 1 256 1 256 0
flat_K98_pol0_62 K98+pol NDSTARE 7.971 1 1024 1 1024 0.000
flat_K98_pol22_62 K98+pol NDSTARE 7.971 1 1024 1 1024 22.5
flat_K98_pol45_62 K98+pol NDSTARE 7.971 1 1024 1 1024 45
flat_K98_pol67_62 K98+pol NDSTARE 7.971 1 1024 1 1024 67.5
flat_J98_88 J98 flush_read 7.46111E+00 1 1024 1 1024 0
flat_H98_93 H98 flush_read 7.58330E+00 1 1024 1 1024 0
flat_K98_98 K98 flush_read 7.70559E+00 1 1024 1 1024 0
flat_H98_133 H98 flush_read 8.99034E+00 1 1024 1 1024 0
flat_H98_138 H98 flush_read 9.07139E+00 1 1024 1 1024 0
flat_H98_138_c1 H98 flush_read 9.12074E+00 1 1024 1 1024 0
flat_K98_290_row0 K98 flush_read 1.13094E+01 1 1024 1 1024 0
flat_K98_290_row1 K98 flush_read 1.15080E+01 1 1024 1 1024 0
\end{terminalv}
The first line contains the column headings.  ORACTIME is the UT in
decimal hours, and WPLANGLE is the polarisation waveplate angle.

In general you should not manipulate these files.  Mis-editing can
lead to the calibration system breaking down.  If you must edit this
file, say to exclude a poor dark or an uneven flat, restrict yourself
deleting the line corresponding to that calibration file.  It's safer
to remove the calibration file and recreate a new one with the
calibration frames you want by running the pipeline.

If you want to nominate specific calibration frames, overriding those
selected from the calibration indices, there is a \texttt{-calib} option
for the \textbf{oracdr} command to do this.  See
\begin{latexonly}
the section on
\end{latexonly}
\xref{calibration options}{sun230}{calibration_options}
\begin{latexonly}
in SUN/230
\end{latexonly}
for examples.

\section{\xlabel{correcting_headers}Correcting headers\label{correcting_headers}}

There are reasons why you may need to edit some of the FITS headers
used by \ORACDR.

\begin{itemize}
\item  At the summit of Mauna Kea, it's easy to make mistakes.  One of
the common ones is to make an error in the `exec' or `sequence'.  This
can cause, for example, frames to be in the wrong observation groups
or be assigned the wrong data-reduction recipe.  While the ORAC
Observation Tool has reduced the frequency of such errors, they will
not be eliminated.

\item You may have made some trial observations before taking making
a longer integration through several cycles of a recipe.  Now you wish
to combine all the observations of a target to obtain the best
signal-to-noise.
\end{itemize}

The main headers to change are
\begin{description}
\item [\texttt{RECIPE}]---the data-reduction recipe;
\item [\texttt{NOFFSETS}]---the number of offsets;
\item [\texttt{OBSNUM}]---the number of the frame, starting from 1 on
each night;
\item [\texttt{GRPNUM}]---the group number, and should be
given by the frame number (OBSNUM) of its first member; and
\item [\texttt{GRPMEM}]---whether or not the frame participates in group
processing.
\end{description}

For IRCAM, Michelle, UIST, UFTI, and converted ISAC files, it is
possible to edit the NDF's
\xref{FITS extension}{sun95}{se_fitsairlock} using \KAPPA's
\xref{\textbf{fitsmod}}{sun95}{FITSMOD} command.  The command is a bit
long and the author regrets not defining a \textbf{fitsupdate} synonym.
The following changes the GRPNUM keyword to have value 36 in the raw
NDF frame f19991108\_00042.

\begin{terminalv}
      % fitsmod f19991108_00042 grpnum u 36 \$C !
\end{terminalv}

It's possible to edit many files using a \xref{C-shell}{sc4}{} or Perl
script to edit a series of files very quickly.  If you do, it's better
to specify the values by keyword instead of position, like this

\begin{terminalv}
      % fitsmod ndf=f19991108_00042 edit=update keyword=grpnum value=36 \
                position=! comment=\$C
\end{terminalv}
because it is better insulated against change to \textbf{fitsmod}.

If the file being edited is a multi-NDF container file, you can avoid
disconcerting, but harmless error messages if you change the \textbf{fitsmod} command to specify the HEADER NDF.  Here is an example for
Michelle data, which changes the number of offsets.

\begin{terminalv}
      % fitsmod m20011107_00079_raw.header noffsets u 5 \$C !
\end{terminalv}

For Classic~Cam, IRIS2, INGRID, ISAAC, NACO, NIRI, or old UFTI data, you can edit
the raw FITS files.  {\tt\$ORAC\_DIR/bin/fitsmod.pl} is a documented
example Perl script to edit FITS headers.  The intention is for you to
make a copy and edit to suit your particular header-editing
requirements.  For some of these instruments, it may prove easier to
edit the FITS headers in the NDF form of the raw data, especially
the ESO cameras, which have hierarchical headers.

\section{Acknowledgments}

\ORACDR\ was developed at the Joint Astronomy Centre by Frossie
Economou and Tim Jenness in collaboration with the UK Astronomy
Technology Centre as part of the ORAC project.  I should like to
thanks to members of the ORAC team, UKIRT staff and observers who made
suggestions for new or improved recipes.  Special thanks go to Gillian
Wright and Sandy Leggett for defining the initial specifications of
the UFTI scripts, and for subsequent discussions.  Chris Davis kindly
supplied the specifications of the polarimetry and Fabry-Perot
recipes.  Paul Hirst wrote the original versions of the primitives
which create the data variance. Stuart Ryder was instrumental in
getting \ORACDR\ commissioned and installed for use at the AAT.
Thanks also to Frossie Economou and Tim Jenness for answering my
\ORACDR\ and Perl questions, and for incorporating my requested
enhancements into \ORACDR infrastructure.

The application engines used in \ORACDR\ were supplied by the Starlink
Project, which is run by CCLRC on behalf of PPARC.  I should like to
thank the Starlink programmers for their excellent support, especially
for quickly providing enhancements to tasks.

\section{Copyright and License}

\ORACDR\ is copyright \copyright 1998--2003 PPARC (the UK Particle Physics
and Astronomy Research Council).  It is distributed by Starlink
under the GNU General Public License as published by the Free Software
Foundation.

Whenever you have used \ORACDR\ as part of a publication, please give
an acknowledgment to \ORACDR\ in the paper.  This will help us assess
the usage of \ORACDR.

\newpage
\appendix
\section{\xlabel{processing__ukirt_data_obtained_before_2000_august}Processing
UKIRT data obtained before 2000 August\label{
processing_ukirt_data_obtained_before_2000_august}}%
\index{processing_data_obtained_before_2000_august}

Before the introduction of
\htmladdnormallink{ORAC}{http://www.stsci.edu/stsci/meetings/adassVII/bridgera.html}
on 2000 August 1, UFTI raw data were in \FITSref\ format, IRCAM data had a
different naming convention, and there were different default paths for
{\tt\$ORAC\_DATA\_IN} and {\tt\$ORAC\_DATA\_OUT}.  IRCAM's NDFs were
copied to \texttt{\$ORAC\_DATA\_OUT}, and UFTI's raw FITS files were
converted to NDFs in that directory.

To process data from this era, follow the instructions


\begin{latexonly}
of Section~\ref{setting_up_orac-dr}
\end{latexonly}
except you should invoke
\begin{terminalv}
      % oracdr_<instrument>_old <date>
\end{terminalv}
instead of
\begin{terminalv}
      % oracdr_<instrument> <date>
\end{terminalv}
to set up the necessary environment variables.  The rest is the same.

You can use modern jitter-generic recipes too, provided they know how
many frames to process.  The easiest way to do that is make your own
copy of the recipe and set the number frames as an argument to the
steering primitive.  See


\begin{latexonly}
Section~\ref{steering_primitive}
\end{latexonly}
for details.

The standard raw and reduced directories prior to 2000 August were
\linebreak \texttt{$<$instrument$>$\_data/YYYYMMDD/raw/}, and \texttt{$<$instrument$>$\_data/YYYYMMDD/reduced/} respectively, where
{\tt$<$instrument$>$} was either \texttt{ufti} or \texttt{ircam}.

Details of the former naming convention for IRCAM frames is given under
the ``Output Data'' headings in the \htmlref{reference section}{recipes}.

\newpage
\section{\xlabel{file_prefixes}File prefixes}\label{file_prefixes}%
\index{file_prefixes}

The UKIRT-style naming convention comprises a prefix followed by the
eight-digit UT date; underscore; the group or observation number, depending on
whether it is a file associated with the group like a mosaic,
or a single frame; and finally if it has undergone processing, a suffix.


\begin{latexonly}
Section~\ref{file_suffices}
\end{latexonly}
discusses and lists the last of these.

As a rule of thumb, the group prefix is the frame prefix preceded by {\tt{g}}.
Here is a table of the prefixes.
\medskip

\begin{center}
\begin{tabular}{lllp{71mm}}
\hline
           &              &               & \\
Instrument~& Frame Prefix & Group Prefix  & Notes \\
           &              &               & \\ \hline
           &              &               & \\ \medskip
Classic~Cam& {\tt{cc}}    & {\tt{gcc}}    & Applies to raw frames after
                                            processing with {\bf{cc2oracdr}}. \\
INGRID     & {\tt{r}}     & {\tt{gingrid}}& Format is {\tt$<$prefix$><$obs\_number$>$},
                                            for individual frames.  Group files
                                            use the UKIRT convention. \\
IRCAM      & {\tt{i}}     & {\tt{gi}}     & \\ \medskip
           & {\tt{ro}}    & {\tt{rg}}     & Before 2000 August \\ \medskip
IRIS2      &              & {\tt{gi}}     & Format is {\tt$<$date$><$obs\_number$>$},
                                            for individual frames, where {\tt$<$date$>$}
                                            is in the form {\tt{ddmmm}}.   Group files
                                            use the UKIRT convention. \\ \medskip
ISAAC      & {\tt{isaac}} & {\tt{gisaac}} & Applies to raw frames after
                                            processing with {\bf{isaac2oracdr}}. \\ \medskip
Michelle   & {\tt{m}}     & {\tt{gm}}     & \\ \medskip
NACO       & {\tt{naco}}  & {\tt{gnaco}}  & Applies to raw frames after
                                            processing with {\bf{naco2oracdr}}. \\ \medskip
NIRI       & {\tt{N}}     & {\tt{gN}}     & \\ \medskip
UFTI       & {\tt{f}}     & {\tt{gf}}     & \\ \medskip
UIST       & {\tt{u}}     & {\tt{gu}}     & \\
           &              &               & \\ \hline
\end{tabular}
\end{center}
\bigskip

ORAC-DR converts the FITS data for instruments like INGRID and NIRI,
note that the naming convention may be different for the raw FITS data
compared with their raw NDF counterparts.  For example, NIRI files
are named {\tt{N}} followed by the eight-digit UT date, then {\tt{S}} and
the four-digit observation number; and have file extension {\tt{.fits}}.

\newpage
\section{\xlabel{file_suffices}File suffices}\label{file_suffices}%
\index{file_suffices}

Files generated during \ORACDR\ imaging data reduction have suffices
denoting the processing step that created them.  This appendix
contains a list with short descriptions of what they mean.  Most will
be removed once a recipe has finished using them.  So you will
probably only see these files if you list the contents of directory
\texttt{\$ORAC\_DATA\_OUT} while the pipeline is running, or you interrupt the
pipeline with \texttt{CTRL/C}, or something has gone wrong with the the
recipe and pipeline has aborted, or you have commented out the `\_TIDY'
primitive from the recipe, or you have set the \texttt{ORAC\_KEEP} environment
variable to 1.

\subsection*{Frame suffices}%
\index{Frame_suffices}

\begin{tabular}{llp{81mm}}
\hline
  Suffix   & Stands for        & Description \\ \hline
{\tt\_adu} & ADU               & Multiplied by the exposure time to convert
                                 the units to ADU (Michelle) \\
{\tt\_bc}  & Bias Corrected    & Residual bias variations removed (ISAAC) \\
{\tt\_bgl} & BackGround Limited & Whether or not each pixel is background
                                 limited, {\tt{i.e.}}\ Poisson noise exceeds
                                 the read noise \\
{\tt\_bp}  & Bad Pixel         & Co-added with the bad-pixel mask \\
{\tt\_bpc}  & Bad Pixel Cumulative & Cumulative bad-pixel mask (UIST) \\
{\tt\_bpd}  & Bad Pixel Data   & Thresholded bias or dark frame for bad-pixel
                                 mask creation (UIST) \\
{\tt\_cl}  & CLone             & Modifiable copy of IRCAM raw data \\
{\tt\_db}  & De-Biassed        & The bias is actually zero, but it sets
                                 up various \xref{\CCDPACK}{sun139}{}
                                 ancillary data for later processing \\
{\tt\_dcb} & Differenced Chop Beams & The difference of the A- and B-beam signals
                                 of nodded data, as used by NOD\_CHOP recipes \\
{\tt\_dk}  & DarK              & Dark subtracted \\
{\tt\_dp}  & Differenced Pair  & The difference of successive frames in a
                                 NOD recipe \\
{\tt\_dta}  & Distortion Transfomation Applied & Resampled for field distortion \\
{\tt\_ess} & E-beam Sky Subtracted & Polarimetry target e-beam after sky subtraction \\
{\tt\_ff}  & Flat Field        & Divided by the flat field \\
{\tt\_fm}  & Flat Masked       & This has the flagged deviant pixels
                                 detected by the initial flat-field creation
                                 restored after object masking \\
{\tt\_fpm} & Fabry-Perot Masked & After a mask is applied to exclude regions beyond
                                 the circle transmitted by the Fabry-Perot etalon. \\
{\tt\_md}  & Masked Deviants   & Deviant pixels from the neighbourhood (usually
                                 3~$\sigma$ in 15$\times$15-pixel region) flagged as bad \\
{\tt\_nl}  & Non-Linearity     & The standard non-linearity correction has
                                 been applied (IRCAM only) \\
{\tt\_nm}  & Normalised to Mode & Normalised masked frames combined to make
                                 the flat field \\
{\tt\_om } & Objects Masked    & This has sources masked with bad values
                                 so that they do not bias the self flat field \\
{\tt\_oss} & O-beam Sky Subtracted & Polarimetry target o-beam after sky subtraction \\
\end{tabular}

\begin{tabular}{llp{90mm}}
\hline
  Suffix   & Stands for        & Description \\ \hline
{\tt\_qm}  & Quadrant Masked   & One of the quadrants is masked with bad
                                 pixels, created in QUADRANT\_JITTER \\
{\tt\_pov} & POisson Variance  & Poisson variance added \\
{\tt\_raw} & Raw copy          & Copy of the raw data, but in output directory
                                 and has history recording enabled \\
{\tt\_rnv} & Read Noise Variance & Variance created containing the readnoise \\
{\tt\_ss}  & Sky Subtracted    & Global or local sky subtraction applied \\
{\tt\_th}  & THresholded       & Non-physical values set to bad \\
{\tt\_trn} & TRaNsform         & The transformed or resampled data immediately
                                 prior to making a mosaic \\
{\tt\_xpr} & X PRofile         & Median of each row (ISAAC) \\
{\tt\_ypr} & Y PRofile         & Median of each column (ISAAC) \\
\end{tabular}

\subsection*{Group suffices}%
\index{Group_suffices}
\begin{tabular}{llp{79mm}}
\hline
  Suffix   & Stands for             & Description \\ \hline
{\tt\_An}  & A beam Negative        & Extracted negative A-beam source and
                                      region from chopped and nodded mosaic \\
{\tt\_Ap}  & A beam Positive        & Extracted positive A-beam source and
                                      region from chopped and nodded mosaic \\
{\tt\_Bn}  & B beam Negative        & Extracted negative B-beam source and
                                      region from chopped and nodded mosaic \\
{\tt\_Bp}  & B beam Positive        & Extracted Positive B-beam source and
                                      region from chopped and nodded mosaic \\
{\tt\_cab} & Combined A \& B beams  & Combined positive and negative images
                                      extracted from chopped and nodded mosaic \\
{\tt\_cpc} & Column-Profile Corrected  & Removed column pattern, likely arising
                                      from pickup \\
{\tt\_fb}  & Filled Bad pixels      & Bad pixels in the mosaic are filled using
                                      smooth function of the neighbouring good
                                      pixels \\
{\tt\_I}   & Intensity              & Polarisation intensity \\
{\tt\_mos} & Mosaic                 & Final mosaic \\
{\tt\_P}   & Percentage             & Percentage polarisation \\
{\tt\_PI}  & Polarisation Intensity & \\
{\tt\_Q}   & Stokes Q               & Stokes $Q$ parameter \\
{\tt\_qcab} & Quality Combining A \& B beams  & Quality map from combining positive and
                                      negative images extracted from chopped and nodded mosaic \\
{\tt\_rpc} & Row-Profile Corrected  & Removed row pattern, say due to bias
                                      variations \\
{\tt\_scab} & Smoothed Combined A \& B beams & Block-smoothed combined positive and negative
                                      images extracted from chopped and nodded mosaic \\
{\tt\_sp}  & Stokes Parameters      & Data cube of Stokes parameters \\
{\tt\_TH}  & THeta                  & Polarisation angle \\
{\tt\_U}   & Stokes U               & Stokes $U$ parameter \\
{\tt\_w}   & Wavelength             & \FP\ mosaic from different wavelengths \\
{\tt\_xpr} & X PRofile              & Median of each row of the mosaic \\
{\tt\_ypr} & Y PRofile              & Median of each column of the mosaic \\
\end{tabular}

\newpage
\subsection*{Deprecated suffices}%
\index{Deprecated_suffices}

The following frame suffices were present prior to version 3.0 of \ORACDR.

\begin{tabular}{llp{90mm}}
\hline
  Suffix   & Stands for        & Description \\ \hline
{\tt\_dg}  & De-Glitched       & Bad pixels replaced by median of neighbours \\
{\tt\_sbp} & Substitute Bad Pixels & Bad pixels replaced (needed for \PISA) \\
{\tt\_sc}  & SCaled            & Data scaled to lie within the range of values
                                 allowed by \xref{\PISA}{sun109}{} for the object
                                 masking \\
\end{tabular}
\\

The following mosaic suffices were present prior to version 3.0 of \ORACDR.

\begin{tabular}{llp{90mm}}
\hline
  Suffix   & Stands for        & Description \\ \hline
{\tt\_mu}  & Mosaic (Unfiltered)~~~ & Intermediate mosaic (could contain
                                      bad/hot pixels) \\
\end{tabular}


\newpage
\section{\xlabel{recipes}Recipes\label{recipes}}

The original set of recipes and names were prescribed in
G.S. Wright \& S.K. Leggett, 1997, \emph{Scripts for UFTI},
\htmladdnormallink{orac009-ufts, v01}
{http://www.jach.hawaii.edu/JACpublic/UKIRT/software/orac/docs/orac009-ufts-1.html}.

\subsection{\xlabel{classified_recipes}Classified Recipes}

In hindsight you may decide that there was a better recipe for your
data than stored in the RECIPE header.  Also you may have used a
faster variant of a recipe at the telescope, but now want the full
reduction.  Here is a classified list so that you can select an
alternative.  Magnitudes and dimensions apply to UFTI, except for the
NOD\_SELF\_FLAT\_NO\_MASK recipes, whose magnitude ranges are for
IRCAM; and the $\lsk$NOD\_CHOP$\lsk$ recipes which are applicable to
\Michelle.  For \IRCAM, dimensions are 10\% smaller; for \IRIS\ dimensions
are 6.8$\times$ larger; for UIST they are either 33\% smaller or 22\%
larger depending on the camera.  The magnitude ranges are courtesy of Sandy Leggett
and apply to UKIRT.
\bigskip\bigskip\bigskip\bigskip\bigskip\bigskip\bigskip\bigskip\bigskip\bigskip\bigskip

\begin{center}
\begin{tabular}{|l|p{26mm}|p{75mm}|}
\multicolumn{3}{c}{\large\textbf{Calibration Recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} & Array check &
   Calculates read noise and dark current. \\ \hline
\htmlref{DARK\_AND\_BPM}{DARK\_AND\_BPM} & Dark and Mask &
   Measures dark current and creates a new bad-pixel mask for UIST. \\ \hline
\htmlref{DIFFERENCE\_STATS}{DIFFERENCE\_STATS} & Array Check and Mask &
   Calculates statisticd for Michelle darks in a pairwise manner. \\\hline
\htmlref{LAMP\_FLAT}{LAMP\_FLAT} & Mask  &
   Creates and files imaging flat fields derived from a calibration
   lamp for ESO instruments. \\ \hline
\htmlref{MAKE\_BPM}{MAKE\_BPM} & Mask  &
   Creates a bad-pixel mask by standard-deviation thresholding. \\ \hline
\htmlref{MEASURE\_READNOISE}{MEASURE\_READNOISE} & Array check &
   Measures and files the readnoise for UIST from a set of dark frames.\\ \hline
\htmlref{REDUCE\_DARK}{REDUCE\_DARK} & Dark &
   Averages and files observations as the current dark. \\ \hline
\htmlref{REDUCE\_FLAT}{REDUCE\_FLAT} & Flat &
   Reduces an imaging flat field.\\ \hline
\htmlref{SKY\_FLAT}{SKY\_FLAT} & Flat &
   Creates and files a flat field derived from five jittered frames.
   Mostly for use with BRIGHT\_POINT\_SOURCE recipes. Requires a
   dark.\\ \hline
\htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP} & Flat &
   Creates a \FP\ sky flat (from jittered blank-sky exposures)
   FP at on- and off-line wavelengths.  Requires a dark. \\ \hline
\htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED} & Flat &
   As SKY\_FLAT but masks objects to give a better flat field. \\ \hline
\htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL} & Flat &
   Obtain a `master' polarimetry flat field from the median average
   of eight jittered frames; the waveplate is cycled after
   every second frame.  Makes a copy of the flat for each
   waveplate angle. Requires a dark.\\ \hline
\htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE} & Flat &
   Obtain four polarimetry flat fields, one for each waveplate angle,
   from the median average of jittered frames. Requires a dark.\\ \hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{|p{37mm}|l|p{86mm}|}
\multicolumn{3}{c}{\large\textbf{Miscellaneous recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{ADDWCS}{ADDWCS} & &
   Creates the valid WCS in the FITS headers of raw data.\\ \hline
\htmlref{NIGHT\_LOG}{NIGHT\_LOG} & &
   Generates a text-file log of a series of observations.\\ \hline
\end{tabular}
\end{center}
\bigskip

\begin{center}
\begin{tabular}{|p{67mm}|p{24mm}|p{57mm}|}
\multicolumn{3}{c}{\large\textbf{Very-bright-point-source recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE} &
   \mbox{$IZ<13$}, \mbox{$JHK<9$}, and bright \mbox{$13<IZ<17$}, \mbox{$9<JHK<15$} &
   Normally a 5-point jitter but would be usable as 3-point.  Requires a
   separate flat as the background is too low to self flat, and a dark. \\ \hline
\htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT} & &
   As BRIGHT\_POINT\_SOURCE, but also performs aperture photometry of the
   source. \\ \hline
BRIGHT\_POINT\_SOURCE\_\-NCOLOUR & &
   As BRIGHT\_POINT\_SOURCE, but produces filenames that include filters
   for easier identification for multi-colour observations. \\ \hline
\htmlref{BRIGHT\_POINT\_SOURCE\_\-NCOLOUR\_APHOT}{BRIGHT\_POINT\_SOURCE\_NCOLOUR\_APHOT} & &
   As BRIGHT\_POINT\_SOURCE\_\-APHOT, but produces filenames that include filters
   for easier identification for multi-colour observations. \\ \hline
\htmlref{BRIGHT\_POINT\_SOURCE\_TELE}{BRIGHT\_POINT\_SOURCE\_TELE} & &
   As BRIGHT\_POINT\_SOURCE, but uses telescope offsets for registration. \\ \hline
BRIGHT\_POINT\_SOURCE\_TELE\_\-APHOT & &
   As BRIGHT\_POINT\_SOURCE\_\-APHOT, but uses telescope offsets for registration. \\ \hline
\end{tabular}
\end{center}
\bigskip

\begin{center}
\begin{tabular}{|l|p{25mm}|p{51mm}|}
\multicolumn{3}{c}{\large\textbf{Point-source recipes---thermal}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK} &
   Bright $L<10$; or all $M$, faint $L>10$ &
   Nod jitter, self flats of differenced pairs of frames.  Has superior
   and fast sky subtraction.  No object masking.  Requires a dark.
   Use 4-point jitter for $L<10$, and 8-point for fainter $L$ and all
   $M$. \\ \hline
\htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT} & &
   As the previous recipe, but also performs aperture photometry of the
   positive and negative sources.  \\ \hline
\htmlref{NOD\_SKY\_FLAT\_THERMAL}{NOD\_SKY\_FLAT\_THERMAL} & &
   Nod jitter, interspersed sky frames.  Sky subtraction, flat field
   created from sky frames only.  Requires a dark.  4-point jitter (8-point
   sequence). \\ \hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{|p{62mm}|p{25mm}|p{61mm}|}
\multicolumn{3}{c}{\large\textbf{Bright-point-source recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} &
   \mbox{$13<I$,$Z<17$}, \mbox{$9<JHK<15$} & Standard jitter, self
   flats. Normally 5-point jitter.  Requires a dark. \\ \hline
\htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT} & &
   As JITTER\_SELF\_FLAT, but also performs aperture photometry of the
   source. \\ \hline
\htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK} & &
   As JITTER\_SELF\_FLAT but faster as it lacks object masking.  It
   only suitable for uncrowded fields. \\ \hline
\htmlref{JITTER\_SELF\_FLAT\_NCOLOUR\_\-APHOT}{JITTER\_SELF\_FLAT\_NCOLOUR\_APHOT} & &
   As JITTER\_SELF\_FLAT\_APHOT, but produces filenames that include filters
   for easier identification for multi-colour observation sequences. \\ \hline
\htmlref{SKY\_AND\_JITTER}{SKY\_AND\_JITTER} & &
   A sky frame and jitter on target.  The sky is subtracted from the
   target frame before flat fielding.  Requires a separate flat,
   as the background is too low to self flat, and a dark.
   No longer recommended as sky varies too quickly. \\ \hline
\htmlref{SKY\_AND\_JITTER\_APHOT}{SKY\_AND\_JITTER\_APHOT} & &
   As SKY\_AND\_JITTER, but also performs aperture photometry of the
   source.  \\ \hline
\end{tabular}
\end{center}
\bigskip

\begin{center}
\begin{tabular}{|p{61mm}|p{26mm}|p{61mm}|}
\multicolumn{3}{c}{\large\textbf{Faint-point-source recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} & Faint
   $I$,$Z>17$, $JHK>15$ & Standard jitter, self flats.  Normally 9-point
   jitter.  Requires a dark. \\ \hline
\htmlref{JITTER\_SELF\_FLAT\_\-CATALOGUE}{JITTER\_SELF\_FLAT\_CATALOGUE} & &
    As JITTER\_SELF\_FLAT but produces an inventory of the locations and
    brightnesses of sources within the mosaic. \\ \hline
\htmlref{BRIGHT\_POINT\_SOURCE\_\-CATALOGUE}{BRIGHT\_POINT\_SOURCE\_CATALOGUE} & &
    As \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE} but produces an
    inventory of the locations and brightnesses of sources within the mosaic.
    Preferred when a self-flat is not appropriate. \\ \hline
\htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC} & &
   Fastest JITTER\_SELF\_FLAT recipe as it lacks object masking, automatic
   registration and resampling. \\ \hline
\htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK} & &
   As JITTER\_SELF\_FLAT, but faster as it lacks object masking.  It
   only suitable for uncrowded fields. \\ \hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{|l|p{32mm}|p{54mm}|}
\multicolumn{3}{c}{\large\textbf{Extended-source recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER} & Galaxies, quasars and
   nebulae of small ($<$45 arcsec) angular extent & 4-point jitter; masks
   the quadrant containing the target to make the flat, then
   masks the objects. Requires a dark.\\ \hline
\htmlref{QUADRANT\_JITTER\_NO\_MASK}{QUADRANT\_JITTER\_NO\_MASK} & &
   As QUADRANT\_JITTER but without object masking. \\ \hline
\htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC} & &
   Fastest QUADRANT\_JITTER variant as it lacks object masking, automatic
   registration and resampling. \\ \hline
\htmlref{MOVING\_QUADRANT\_JITTER}{MOVING\_QUADRANT\_JITTER} &
   Compact comets ($<$45 arcsec) &
   As QUADRANT\_JITTER, but uses ephemeris data to track the
   non-sidereal source.\\ \hline
\htmlref{QUADRANT\_JITTER\_TELE}{QUADRANT\_JITTER\_TELE} & &
   As QUADRANT\_JITTER but uses telescope offsets for registration.
   Telescope tracks object. \\ \hline
\htmlref{EXTENDED\_3x3}{EXTENDED\_3x3} & Galaxies and nebulae with
   angular extent $<$2 arcminutes & Sky-subtracted 3$\times$3 grid
   mosaic on target.  Frames alternate between sky and target.
   Requires a dark.\\ \hline
\htmlref{EXTENDED\_3x3\_BASIC}{EXTENDED\_3x3\_BASIC} & &
   As EXTENDED\_3x3 but lacks resampling and registers using telescope
   offsets. \\ \hline
\htmlref{EXTENDED\_5x5}{EXTENDED\_5x5} & Galaxies and nebulae with
   angular extent $<$3 arcminutes & Sky-subtracted 5$\times$5 grid
   mosaic of the target.  Frames alternate between sky and target.
   Requires a dark. \\ \hline
\htmlref{EXTENDED\_5x5\_BASIC}{EXTENDED\_5x5\_BASIC} & &
   As EXTENDED\_5x5 but lacks resampling and registers using telescope
   offsets. \\ \hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{|l|p{25mm}|p{82mm}|}
\multicolumn{3}{c}{\large\textbf{Point-source recipes---mid-infra-red}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{NOD\_CHOP}{NOD\_CHOP} &
   Bright $N$ and $Q$ (limits to be determined) &
   Chopped and nodded observations to remove sky background and telescope
   contributions; differences both chopped beams and nodded pairs of frames
   giving a mosaic with two positive and two negative images.  There
   is no masking or flat-fielding.  Requires a bias in CHOP mode,
   \emph{e.g.}\ from recipe ARRAY\_TESTS.  \\ \hline
\htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT} & &
   As the previous recipe, but also performs aperture photometry of the
   combined four images (after extraction and centroid registration). \\ \hline
\htmlref{NOD\_CHOP\_FAINT}{NOD\_CHOP\_FAINT} & &
   As NOD\_CHOP, but removes column and row artifacts from the mosaic, then
   it combines each chopped and nodded image using a median filter to form an
   image of the source with four times the signal.  This image is then smoothed
   to enhance the visibility of faint sources. \\ \hline
\htmlref{NOD\_CHOP\_SCAN}{NOD\_CHOP\_SCAN} & &
   As NOD\_CHOP, but for chopped and nodded observations that are taken in a
   scan pattern.  A mosaic is formed at each scan position. \\ \hline
\end{tabular}
\end{center}
\medskip

\begin{center}
\begin{tabular}{|l|p{14mm}|p{61mm}|}
\multicolumn{3}{c}{\large\textbf{Moving (non-sidereal) source recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT} &
   Minor planets, comets &
   As JITTER\_SELF\_FLAT, but uses ephemeris data to track the non-sidereal
   source. \\ \hline
\htmlref{MOVING\_JITTER\_SELF\_FLAT\_BASIC}{MOVING\_JITTER\_SELF\_FLAT\_BASIC} &  &
   As JITTER\_SELF\_FLAT\_BASIC, but uses ephemeris data to track the
   non-sidereal source.\\ \hline
\htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE} & &
   Standard jitter, using telescope offsets.  This is needed
   when the telescope has tracked on the non-sidereal target. Requires
   a dark.\\ \hline
\htmlref{MOVING\_NOD\_CHOP}{MOVING\_NOD\_CHOP} & &
   As NOD\_CHOP, but uses ephemeris data to track the non-sidereal source
   in the mid-infra-red.\\ \hline
\htmlref{MOVING\_QUADRANT\_JITTER}{MOVING\_QUADRANT\_JITTER} & Compact comets &
   As QUADRANT\_JITTER, but uses ephemeris data to track the
   non-sidereal source.\\ \hline
\htmlref{QUADRANT\_JITTER\_TELE}{QUADRANT\_JITTER\_TELE} & &
   As QUADRANT\_JITTER but uses telescope offsets for registration.  This is
   needed when the telescope has tracked on the non-sidereal target.\\ \hline
\end{tabular}
\end{center}
\bigskip

\begin{center}
\begin{tabular}{|p{48mm}|p{29mm}|p{74mm}|}
\multicolumn{3}{c}{\large\textbf{Polarimetry recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{POL\_ANGLE\_JITTER}{POL\_ANGLE\_JITTER} &
   Polarimetry of point or small ($<\sim35$ arcsec) extended sources &
   Makes a polarisation map from frames at the four waveplate angles at
   each of at least three jittered positions; the waveplate is moved
   before the telescope.  An appropriate dark and separate flat fields
   at each waveplate angle (using SKY\_FLAT\_POL or SKY\_FLAT\_POL\_ANGLE)
   must be obtained. \\ \hline
\htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP} &
   Polarimetry of point or small ($<\sim10$ arcsec) extended sources in
   mid-infra-red &
   Makes a polarisation map from chopped and nodded frames at the four
   waveplate angles at two nod positions; the waveplate is moved before
   the telescope is nodded.  There is no object masking or flat fielding.
   Requires a bias in CHOP mode, \emph{e.g.}\ from recipe ARRAY\_TESTS. \\ \hline
\htmlref{POL\_EXTENDED}{POL\_EXTENDED} &
   Polarimetry of extended sources &
   Makes a polarisation map of an extended source from frames
   nodded between object and blank sky.  The object-sky pairs
   must be taken at each of the four waveplate angles.  Requires
   an appropriate dark and separate flat fields at each waveplate
   angle. \\ \hline
\htmlref{POL\_JITTER}{POL\_JITTER} &
   Polarimetry of point or small ($<\sim35$ arcsec) extended sources &
   Makes a polarimetry map from frames at the four waveplate angles at
   each of at least three jittered positions; the telescope is moved
   before the waveplate.  An appropriate dark and flat fields at each
   waveplate angle must be obtained.\\ \hline
\htmlref{POL\_NOD\_CHOP}{POL\_NOD\_CHOP} &
   Polarimetry of point or small ($<\sim10$ arcsec) extended sources in
   mid-infra-red &
   As \htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP} but
   the telescope is nodded before the waveplate is moved.  \\ \hline
\htmlref{POL\_QU\_FIRST\_NOD\_\-CHOP}{POL\_QU\_FIRST\_NOD\_CHOP} &
   Polarimetry of point or small ($<\sim10$ arcsec) extended sources in
   mid-infra-red &
   It is a hybrid of \htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP}
   and \htmlref{POL\_NOD\_CHOP}{POL\_NOD\_CHOP} as the waveplate angle
   iterates in pairs at each jitter position. \\ \hline
\htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL} & Flat &
   Obtain a `master' polarimetry flat field from the median average
   of eight jittered frames; the waveplate is cycled after
   every second frame.  Makes a copy of the flat for each
   waveplate angle.  Requires a dark.\\ \hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{|l|p{25mm}|p{81mm}|}
\multicolumn{3}{c}{\large\textbf{\FP\ recipes}} \vspace*{1ex} \\
\hline
Recipe Name & Type of Data & Function and Comments \\ \hline
\htmlref{FP}{FP} & Fabry-Perot &
   Uses a sequence of eight frames; object-sky pairs at on-line,
   off-line (blue), on-line and off-line (red) FP settings to make
   a mosaic.  Requires a separate flat field (made by SKY\_FLAT\_FP)
   and a dark. \\ \hline
\htmlref{FP\_JITTER}{FP\_JITTER} & &
   On/Off-line images with nodding to blank sky (as FP), and spatial
   jittering on-source.  Requires a separate flat field and a dark. \\ \hline
\htmlref{FP\_JITTER\_NO\_SKY}{FP\_JITTER\_NO\_SKY} & &
   On/Off-line images without nodding to blank sky (i.e. sequence of
   four frames), and spatial jittering on-source.
   Requires a separate flat field and a dark.  \\ \hline
\htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP} & Flat &
   Creates a Fabry-Perot sky flat (from jittered blank-sky exposures)
   FP at on- and off-line wavelengths.  Requires a dark. \\ \hline
\end{tabular}
\end{center}
\bigskip

\newpage
\subsection{Reference documentation}

The following recipes apply to both UFTI and IRCAM unless otherwise
noted.  Where there are processing differences for the two instruments,
they are noted in the reference specification.  Also there is an
ARRAY\_TESTS recipe for each instrument, of which only UFTI's is
presented below for technical reasons.

In the \textbf{Configurable Steering Parameters} sections the defaults
appear at the end of the parameter's description between \texttt{[~]}.

The non-generic recipes of the original release are not documented
here, but are still available for reducing pre-ORAC (2000 August)
data.  They are listed in the \textbf{Deprecated variants} section of
their generic counterpart.  Each behaves as the generic counterpart,
except the number of jitter points is fixed.  Thus the
JITTER9\_SELF\_FLAT reduces a nine-point jitter.
\bigskip\bigskip\bigskip

%\newpage
\sstroutine{
   ADDWCS
}{
   Creates the valid WCS in the FITS headers of raw data
}{
   \sstdescription{
      This recipe uses the existing hotpotch of UKIRT and AAT imaging headers of raw
      data to make a new set of headers which define a valid world co-ordinate
      system, using the AIPS convention.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The corrected frame in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_raw},
         where $<$i$>$ is \htmlref{the frame prefix.}{file_prefixes}
         For IRIS2, the corrected frame is in
         {\tt$<$date$><$obs\_number$>$}, where {\tt$<$date$>$} is in the form
         {\tt{ddmmm}}.  If the file already exists, it's only updated.
      }
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package KAPPA.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.
      }
   }
}

\sstroutine{
   ARRAY\_TESTS
}{
   Calculates the readout noises and dark current for UFTI
}{
   \sstdescription{
      This script calculates for UFTI the NDSTARE readout noise, and the
      dark current from a series of four engineering frames taken
      with the sequence called array\_tests.  The results are compared with
      the nominal values, and you are notified whether or not the values
      obtained are within limits.  At UKIRT, the results are also logged
      to an engineering file for archival purposes.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         The engineering log contains the UT date and time, the
	 NDSTARE readout noise and the dark current.  The results are
	 normally appended to the log.  If for some reason it does not
	 exist, a new log is created containing the column headings.

         \sstitem
         Multiple array tests are permitted.  A new set of results is
         reported and logged for each cycle.

         \sstitem
         The NDSTARE readout noise is filed in the calibration system.

      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The engineering log {\tt\$ORAC\_DATA\_OUT/ufti\_array\_tests.log}.\\
      }
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.
      }
   }
}

\sstroutine{
   BRIGHT\_POINT\_SOURCE
}{
   Reduces a bright-point-source photometry observation
}{
   \sstdescription{
      This recipe reduces a ``bright standard'' photometry observation.
      It takes an imaging observation comprising
      a series of jittered object frames and a dark frame, and a
      predetermined flat-field frame to make a calibrated, trimmed
      mosaic automatically.

      This recipe performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, feature detection and matching
      between object frames, and resampling.  See the
      \htmlref{``Notes''}{bps_notes} for details.

      As the name implies, it is intended for bright point sources,
      such as standard stars, but also any observation where using its
      own frames to make the flat is not appropriate.
   }
   \label{bps_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or
         \htmlref{SKY\_FLAT\_MASKED }{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Where automatic registration is not possible, the recipe matches
         the centroid of central source, and should that fail, it resorts
         to using the telescope offsets transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         areupdated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If this is not
         set, the number of offsets, as given by FITS header NOFFSETS,
         minus one is used.  If neither is available, 5 is the default.
         An error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{SKY\_FLAT}{SKY\_FLAT},\\
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   BRIGHT\_POINT\_SOURCE\_APHOT
}{
   Reduces a bright-point-source photometry observation and performs
   aperture photometry
}{
   \sstdescription{
      This recipe reduces a ``bright standard'' photometry observation
      It takes an imaging observation comprising
      a series of jittered object frames and a dark frame with a
      predetermined flat-field frame to make a calibrated, trimmed mosaic
      automatically.

      This recipe performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field division, feature detection and matching
      between object frames, and resampling.  See the
      \htmlref{``Notes''}{bpsa_notes} for details.

      Photometry of the point source using a fixed 5-arcsecond aperture
      is calculated for each jitter frame and the mosaic.  The results
      appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in the form of a Starlink
      small text list.  The analysis of each star is appended to this file.

      As the name implies, it is intended for bright point sources,
      such as standard stars, but also any observation of a point
      source where using its own frames to make the flat is not appropriate.
   }
   \label{bpsa_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Where automatic registration is not possible, the recipe matches
         the centroid of central source, and should that fail, it resorts
         to using the telescope offsets transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         are updated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         The photometry tabulation includes the file name, source name,
         time, filter, airmass, the catalogue magnitude and estimates of
         the zero-point with and without the application of a mean
         extinction.  There are headings at the top of each column.

         \sstitem

         The photometry uses the mode calculated from
         \mbox{3 $\lsk$ median $-$ 2 $\lsk$ mean} and Chauvenet's
         rejection criterion to estimate the sky level in an annulus
         about the source. The inner annulus diameter is 1.3 times
         that of the aperture (6.5 arcsec); the outer annulus is 2.5
         times (12.5 arcsec) for UFTI, and twice the aperture (10 arcsec)
         for IRCAM, Michelle, and IRIS2.

         The errors are internal, based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         Results tabulation to log {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If this is not
         set, the number of offsets, as given by FITS header NOFFSETS,
         minus one is used.  If neither is available, 5 is the default.
         An error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE},
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},
      \htmlref{SKY\_FLAT}{SKY\_FLAT},\\
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\PHOTOM}{sun45}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

\sstroutine{
   BRIGHT\_POINT\_SOURCE\_CATALOGUE
}{
   Reduces a bright-point-source photometry observation, producing
   a catalogue of all sources in the field
}{
   \sstdescription{
      This recipe reduces a ``bright standard'' photometry observation.
      It takes an imaging observation comprising
      a series of jittered object frames and a dark frame, and a
      predetermined flat-field frame to make a calibrated, trimmed
      mosaic automatically.

      This recipe performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, feature detection and matching
      between object frames, and resampling.  See the
      \htmlref{``Notes''}{bpsc_notes} for details.

      Source extraction is performed only on the reduced mosaic, and
      uses \EXTRACTOR.  The results appear in
      {\tt\$ORAC\_DATA\_OUT/catalogue\_$<$group\_number$>$.txt}.
      No zero-point or airmass corrections are applied to the
      instrumental magnitudes.

      As the name implies, it is intended for bright point sources,
      such as standard stars, but also any observation where using its
      own frames to make the flat is not appropriate.
   }
   \label{bpsc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or
         \htmlref{SKY\_FLAT\_MASKED }{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Where automatic registration is not possible, the recipe matches
         the centroid of central source, and should that fail, it resorts
         to using the telescope offsets transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         areupdated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         The catalogue includes the right ascension and declination,
         instrumental apparent magnitude (calculated as
         $-2.5 * \log( {\rm{counts}} ))$, and the error in the magnitude.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The catalogue in \texttt{catalogue\_$<$group\_number$>$.txt}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If this is not
         set, the number of offsets, as given by FITS header NOFFSETS,
         minus one is used.  If neither is available, 5 is the default.
         An error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},
      \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE},\\
      \htmlref{JITTER\_SELF\_FLAT\_CATALOGUE}{JITTER\_SELF\_FLAT\_CATALOGUE},
      \htmlref{SKY\_FLAT}{SKY\_FLAT},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

\newpage
\sstroutine{
   BRIGHT\_POINT\_SOURCE\_NCOLOUR\_APHOT
}{
   Reduces a multi-colour bright-point-source
   photometry observation and performs aperture photometry.
}{
   \sstdescription{
      This recipe reduces a "bright standard" photometry observation observed
      through one or more filters. For each filter it takes an imaging
      observation comprising a
      series of jittered object frames and a dark frame with a predetermined
      flat-field frame to make a calibrated, trimmed mosaic automatically.

      This recipe performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field division, feature detection and matching
      between object frames, and resampling.  See the
      \htmlref{``Notes''}{bpsna_notes} for details.

      Photometry of the point source using a fixed 5-arcsecond aperture
      is calculated for each jitter frame and the mosaic.  The results
      appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in the form of a Starlink
      small text list.  The analysis of each star is appended to this file.

      As the name implies, it is intended for bright point sources,
      such as standard stars, but also any observation of a point
      source where using its own frames to make the flat is not appropriate.
   }
   \label{bpsna_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or
         \htmlref{SKY\_FLAT\_MASKED }{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Where automatic registration is not possible, the recipe matches
         the centroid of the central source, and should that fail, it resorts
         to using the telescope offsets transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         areupdated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         The photometry tabulation includes the file name, source name, time,
         filter, airmass, the catalogue magnitude and estimates of the
         zero-point with and without the application of a mean extinction.
         There are headings at the top of each column.

         \sstitem
         The photometry uses the mode calculated from 3*median-2*mean
         and Chauvenet's rejection criterion to estimate the sky level in an
         annulus about the source. The inner annulus diameter is 1.3 times
         that of the aperture (6.5 arcsec); the outer annulus is 2.5 times
         (12.5 arcsec) for UFTI, and twice the aperture (10 arcsec) for IRCAM
         and Michelle.

         The errors are internal, based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$filter$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         Results tabulation to {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If this is not
         set, the number of offsets, as given by FITS header NOFFSETS,
         minus one is used.  If neither is available, 5 is the default.
         An error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE},
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT}, \\
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{SKY\_FLAT}{SKY\_FLAT},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   BRIGHT\_POINT\_SOURCE\_TELE
}{
   Reduces a bright-point-source photometry observation
   using telescope offsets for registration.
}{
   \sstdescription{
      This script reduces a "bright standard" photometry observation with
      UKIRT imaging data.  It takes an imaging observation comprising a
      series of jittered object frames and a dark frame, and a predetermined
      flat-field frame to make a calibrated, trimmed mosaic automatically.

      This recipe performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, registration using telescope offsets,
      and resampling.  See the \htmlref{``Notes''}{bpst_notes} for details.

      As the name implies, it is intended for bright point sources,
      such as standard stars, or any observation where using its own frames to
      make the flat is not appropriate, and where automatic registration fails.

   }
   \label{bpst_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or
         \htmlref{SKY\_FLAT\_MASKED }{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Registration is performed using the telescope offsets transformed
         to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         areupdated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If this is not
         set, the number of offsets, as given by FITS header NOFFSETS,
         minus one is used.  If neither is available, 5 is the default.
         An error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE},
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},\\
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{SKY\_FLAT}{SKY\_FLAT},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   CHOP\_SKY\_JITTER
}{
   Reduction of alternating sky-target jitters using interpolated sky
   subtraction
}{
   \sstdescription{
      This recipe reduces a moderately extended source using near-infrared
      imaging data.  The data comprise alternating blank-sky and target frames
      commencing and ending with a blank sky.  Both the sky and target
      frames are jittered.  The recipe makes a sky-subtracted untrimmed
      mosaic automatically.

      The script performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, sky subtraction, registration,
      resampling, and mosaicking.  The \htmlref{``Notes''}{csj_notes} give
      more details.

      It is suitable for extended objects where the object fills or nearly
      fills the frame, so sky estimation within the frame is impossible or
      unreliable, but the extended mapping of the target is not required.
   }
   \label{csj_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         For INGRID, the pre- and post-exposure images are subtracted.
         A non-linearity correction is then applied.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is derived from the sky frames as follows.  The
         mode (sigma-clipped mean) is used to offset each sky frame's mode
         to that of the first sky frame.  The corrected sky frames are
         combined pixel by pixel using a median of the values in each
         frame.  The resultant frame is normalised by its median to form
         the flat field.  This frame median is subtracted from the source
         frames after they have been flat-fielded.  A flat field is created
         from all the jittered sky frames, and applied to all the target
         frames.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         The sky subtraction comes from linear interpolation of the sky
         modal values of the two flat-fielded sky frames which immediately
         bracket the target frame.

         \sstitem
         The field distortion of ISAAC is corrected in the target frames
         using the mappings documented on the
         \htmladdnormallink{ISAAC problems web page}
         {http://www.eso.org/instruments/isaac/problems_tips.html}.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, it then tries the crosshead offsets.  If these are null,
         the script resorts to the telescope offsets.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The noise will be greater in the mosaic's peripheral areas, having
         received less exposure time.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         At the end of each cycle of sky and object frames the full
         mosaic of target frames is created and displayed.  The mosaic has
         its bad pixels filled by interpolation.  On the second and
         subsequent cycles the full mosaic is added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos},
         where {\tt$<$m$>$} is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered target frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of target frames in the jitter pattern.  If this
         is not set, a value is derived from the number of offsets, as
         given by header NOFFSETS.  The formula is NOFFSETS / 2 $-$ 1.
         An error results should NOFFSETS be odd.  If neither is
         available, 9 is the default.  An error state arises if the
         number of jittered frames is fewer than 3.  For observations
         prior to the availability of full ORAC, header NOFFSETS will
         be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{CHOP\_SKY\_JITTER\_BASIC}{CHOP\_SKY\_JITTER\_BASIC},
      \htmlref{EXTENDED\_3x3}{EXTENDED\_3x3},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   CHOP\_SKY\_JITTER\_BASIC
}{
   Basic reduction of alternating sky-target jitters using interpolated
   sky subtraction
}{
   \sstdescription{
      This recipe reduces a moderately extended source using near-infrared imaging
      data.  The data comprise alternating blank-sky and target frames
      commencing and ending with a blank sky.  Both the sky and target
      frames are jittered.  The recipe makes a sky-subtracted untrimmed
      mosaic automatically.

      The script performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, sky subtraction, registration
      using telescope offsets, and mosaicking.  The
      \htmlref{``Notes''}{csjb_notes} give more details.

      It is suitable for extended objects where the object fills or nearly
      fills the frame, so sky estimation within the frame is impossible or
      unreliable, but the extended mapping of the target is not required.
   }
   \label{csjb_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is derived from the sky frames as follows.  The
         mode (sigma-clipped mean) is used to offset each sky frame's mode
         to that of the first sky frame.  The corrected sky frames are
         combined pixel by pixel using a median of the values in each
         frame.  The resultant frame is normalised by its median to form
         the flat field.  This frame median is subtracted from the source
         frames after they have been flat-fielded.  A flat field is created
         from all the jittered sky frames, and applied to all the target
         frames.

         \sstitem
         The sky subtraction comes from linear interpolation of the sky
         modal values of the two sky frames which immediately bracket the
         target frame.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The noise will be greater in the mosaic's peripheral areas, having
         received less exposure time.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         At the end of each cycle of sky and object frames the full
         mosaic of target frames is created and displayed.  On the second and
         subsequent cycles the full mosaic is added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos},
         where {\tt$<$m$>$} is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of target frames in the jitter pattern.  If this
         is not set, a value is derived from the number of offsets, as
         given by header NOFFSETS.  The formula is NOFFSETS / 2 $-$ 1.
         An error results should NOFFSETS be odd.  If neither is
         available, 9 is the default.  An error state arises if the
         number of jittered frames is fewer than 3.  For observations
         prior to the availability of full ORAC, header NOFFSETS will
         be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{CHOP\_SKY\_JITTER\_BASIC}{CHOP\_SKY\_JITTER\_BASIC},
      \htmlref{EXTENDED\_3x3\_BASIC}{EXTENDED\_3x3\_BASIC},\\
      \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

\sstroutine{
   DARK\_AND\_BPM
}{
   Measures dark current and creates a new bad-pixel mask for UIST
}{
   \sstdescription{
      This recipe is used to measure the dark current for UIST, using a
      long-exposure DARK frame.  It first finds and bad pixels in the
      DARK, then measures and reports the dark current.   The recipe
      appends to a tabulation of the dark current in an engineering log
      file, {\tt\$ORAC\_DATA\_OUT/uist\_array\_tests.log}, which it creates with
      headings if the log does not exist.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The recipe applies thresholds to the dark frame and flags pixels
         outside these limits as bad.  The thresholds are derived from
         3-standard-deviation clipped statistics; pixels more than 5
         standard deviations above the mean are flagged.

         \sstitem
         The bad pixels detected are added into the current bad-pixel mask
         and then this is filed with the calibration system as a new and
         current bad-pixel mask.

         \sstitem
         The new bad-pixel mask is applied to the original dark frame,
         whose unclipped mean scaled by the gain and inverse exposure time
         is the dark current in electrons per second.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The engineering log {\tt\$ORAC\_DATA\_OUT/uist\_array\_tests.log}.
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS},
      \htmlref{MEASURE\_READNOISE}{MEASURE\_READNOISE}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         Error propagation is not used.
      }
   }
}

%\newpage
\sstroutine{
   DARK\_SUBTRACT
}{
   Subtracts a dark frame
}{
   \sstdescription{
      This recipe subtracts a corresponding dark calibration frame,
      then displays the result.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.
      }
   }
}

\sstroutine{
   DIFFERENCE\_STATS
}{
   Calculates statistics for Michelle darks in a pairwise manner
}{
   \sstdescription{
      This recipe is meant to be used in an array tests suite.  It
      takes a group of observations, subtracts successive pairs,
      then calculates and reports the standard deviation for each
      resulting differenced frame in a central 200-pixel-square
      region, and in the four channels of the detector.  It finally
      provides the average of these statistics for the group as a
      whole.
   }
   \sstnotes{
      \sstitemlist{
         \sstitem
         The frames must be in the same group.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the group.  The default is used if
         the number of frames is fewer than 2 or is not even.  {\tt[20]}
      }
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.
      }
   }
}

%\newpage
\sstroutine{
   EXTENDED\_3x3
}{
   Extended-source standard reduction using interpolated sky subtraction
}{
   \sstdescription{
      This recipe reduces an extended source using near-infrared imaging data.
      The data comprise alternating blank-sky and target frames commencing
      and ending with a blank sky.  The target frames are arranged in an
      overlapping (30--50\%) grid of 3$\times$3 frames from which the recipe
      makes a sky-subtracted untrimmed mosaic automatically.

      The script performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, sky subtraction, registration,
      resampling, and mosaicking.  The \htmlref{``Notes''}{e3x3_notes} give
      more details.

      It is suitable for extended objects up to 2 arcminutes across
      with UFTI, 28 arcseconds with IRCAM, and 14 arcminutes across
      with IRIS2.
   }
   \label{e3x3_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is derived from the sky frames as follows.  The
         mode (sigma-clipped mean) is used to offset each sky frame's mode
         to that of the first sky frame.  The corrected sky frames are
         combined pixel by pixel using a median of the values in each
         frame.  The resultant frame is normalised by its median to form
         the flat field.  This frame median is subtracted from the source
         frames after they have been flat-fielded.  A flat field is created
         for each row of the grid of target frames, and applied only to
         that row of target frames.

         \sstitem
         The sky subtraction comes from linear interpolation of the sky
         modal values of the two flat-fielded sky frames which immediately
         bracket the target frame.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, it then tries the crosshead offsets.  If these are null,
         the script resorts to the telescope offsets.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The noise will be greater in the mosaic's peripheral areas, having
         received less exposure time.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         Mosaics are made and displayed for each row, except the last.
         At the end of each cycle of 19 frames the full mosaic of nine target
         frames is created and displayed instead.  On the second and
         subsequent cycles the full mosaic is added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The full mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each row in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$row\_number$>$},
         where {\tt$<$row\_number$>$} is 0 or 1.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NROW = INTEGER
      }{
         The number of target frames in a row of the mosaic.  Its
         minimum is 3 because this number of blank skies are needed to
         form a flat field.  {\tt[3]}
      }
      \sstsubsection{
         NCOL = INTEGER
      }{
         The number of target frames in a column of the mosaic.  Its
         minimum is 2.  {\tt[3]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{EXTENDED\_3x3\_BASIC}{EXTENDED\_3x3\_BASIC},
      \htmlref{EXTENDED\_5x5}{EXTENDED\_5x5},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   EXTENDED\_3x3\_BASIC
}{
   Basic extended-source standard reduction using interpolated sky
   subtraction
}{
   \sstdescription{
      This recipe reduces an extended source using near-infrared imaging data.
      The data comprise alternating blank-sky and target frames commencing
      and ending with a blank sky.  The target frames are arranged in an
      overlapping (30--50\%) grid of 3$\times$3 frames from which the recipe
      makes a sky-subtracted untrimmed mosaic automatically.

      The script performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, sky subtraction, registration
      using telescope offsets, and mosaicking.  The
      \htmlref{``Notes''}{e3x3b_notes} give more details.

      It is suitable for extended objects up to 2 arcminutes across
      with UFTI, 28 arcseconds with IRCAM, and 14 arcminutes with IRIS2.
   }
   \label{e3x3b_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is derived from the sky frames as follows.  The
         mode (sigma-clipped mean) is used to offset each sky frame's mode
         to that of the first sky frame.  The corrected sky frames are
         combined pixel by pixel using a median of the values in each
         frame.  The resultant frame is normalised by its median to form
         the flat field.  This frame median is subtracted from the source
         frames after they have been flat-fielded.  A flat field is created
         for each row of the grid of target frames, and applied only to
         that row of target frames.

         \sstitem
         The sky subtraction comes from linear interpolation of the sky
         modal values of the two flat-fielded sky frames which immediately
         bracket the target frame.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The noise will be greater in the mosaic's peripheral areas, having
         received less exposure time.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         Mosaics are made and displayed for each row, except the last.
         At the end of each cycle of 19 frames the full mosaic of nine target
         frames is created and displayed instead.  On the second and
         subsequent cycles the full mosaic is added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The full mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each row in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$row\_number$>$},
         where {\tt$<$row\_number$>$} is 0 or 1.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NROW = INTEGER
      }{
         The number of target frames in a row of the mosaic.  Its
         minimum is 3 because this number of blank skies are needed to
         form a flat field.  {\tt[3]}
      }
      \sstsubsection{
         NCOL = INTEGER
      }{
         The number of target frames in a column of the mosaic.  Its
         minimum is 2.  {\tt[3]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{EXTENDED\_3x3}{EXTENDED\_3x3},
      \htmlref{EXTENDED\_5x5\_BASIC}{EXTENDED\_5x5\_BASIC},
      \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   EXTENDED\_5x5
}{
   Extended-source standard reduction using interpolated sky subtraction
}{
   \sstdescription{
      This recipe reduces an extended source using near-infrared imaging data.
      The data comprise alternating blank-sky and target frames commencing
      and ending with a blank sky.  The target frames are arranged in an
      overlapping (30--50\%) grid of 5$\times$5 frames from which the recipe
      makes a sky-subtracted untrimmed mosaic automatically.

      The script performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, sky subtraction, registration,
      resampling, and mosaicking.  The \htmlref{``Notes''}{e5x5_notes}
      give more details.

      It is suitable for extended objects up to 3 arcminutes across
      with UFTI, 42 arcseconds with IRCAM, and 20 arcminutes with IRIS2.
   }
   \label{e5x5_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is derived from the sky frames as follows.  The
         mode (sigma-clipped mean) is used to offset each sky frame's mode
         to that of the first sky frame.  The corrected sky frames are
         combined pixel by pixel using a median of the values in each
         frame.  The resultant frame is normalised by its median to form
         the flat field.  This frame median is subtracted from the source
         frames after they have been flat-fielded.  A flat field is created
         for each row of the grid of target frames, and applied only to
         that row of target frames.

         \sstitem
         The sky subtraction comes from linear interpolation of the sky
         modal values of the two flat-fielded sky frames which immediately
         bracket the target frame.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, it then tries the crosshead offsets.  If these are null,
         the script resorts to the telescope offsets.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The noise will be greater in the mosaic's peripheral areas, having
         received less exposure time.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         Mosaics are made and displayed for each row, except the last.
         At the end of each cycle of 51 frames the full mosaic of 25 target
         frames is created and displayed instead.  On the second and
         subsequent cycles the full mosaic is added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The full mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each row in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$row\_number$>$},
         where {\tt$<$row\_number$>$} is 0 to 3.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NROW = INTEGER
      }{
         The number of target frames in a row of the mosaic.  Its
         minimum is 3 because this number of blank skies are needed to
         form a flat field.  {\tt[5]}
      }
      \sstsubsection{
         NCOL = INTEGER
      }{
         The number of target frames in a column of the mosaic.  Its
         minimum is 2.  {\tt[5]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{EXTENDED\_3x3}{EXTENDED\_3x3},
      \htmlref{EXTENDED\_5x5\_BASIC}{EXTENDED\_5x5\_BASIC},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   EXTENDED\_5x5\_BASIC
}{
   Basic extended-source standard reduction using interpolated sky
   subtraction
}{
   \sstdescription{
      This recipe reduces an extended source using near-infrared imaging data.
      The data comprise alternating blank-sky and target frames commencing
      and ending with a blank sky.  The target frames are arranged in an
      overlapping (30--50\%) grid of 5$\times$5 frames from which the recipe
      makes a sky-subtracted untrimmed mosaic automatically.

      The script performs bad-pixel masking, null debiassing, dark
      subtraction, flat-field division, sky subtraction, registration
      using telescope offsets, and mosaicking.  The
      \htmlref{``Notes''}{e5x5b_notes} give more details.

      It is suitable for extended objects up to 3 arcminutes across
      with UFTI, 42 arcseconds with IRCAM, and 20 arcminutes with IRIS2.
   }
   \label{e5x5b_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is derived from the sky frames as follows.  The
         mode (sigma-clipped mean) is used to offset each sky frame's mode
         to that of the first sky frame.  The corrected sky frames are
         combined pixel by pixel using a median of the values in each
         frame.  The resultant frame is normalised by its median to form
         the flat field.  This frame median is subtracted from the source
         frames after they have been flat-fielded.  A flat field is created
         for each row of the grid of target frames, and applied only to
         that row of target frames.

         \sstitem
         The sky subtraction comes from linear interpolation of the sky
         modal values of the two flat-fielded sky frames which immediately
         bracket the target frame.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The noise will be greater in the mosaic's peripheral areas, having
         received less exposure time.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         Mosaics are made and displayed for each row, except the last.
         At the end of each cycle of 51 frames the full mosaic of 25 target
         frames is created and displayed instead.  On the second and
         subsequent cycles the full mosaic is added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The full mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each row in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$row\_number$>$},
         where {\tt$<$row\_number$>$} is 0 to 3.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NROW = INTEGER
      }{
         The number of target frames in a row of the mosaic.  Its
         minimum is 3 because this number of blank skies are needed to
         form a flat field. {\tt[5]}
      }
      \sstsubsection{
         NCOL = INTEGER
      }{
         The number of target frames in a column of the mosaic.  Its
         minimum is 2. {\tt[5]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{EXTENDED\_3x3\_BASIC}{EXTENDED\_3x3\_BASIC},
      \htmlref{EXTENDED\_5x5}{EXTENDED\_5x5},
      \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   FP
}{
   Reduces an 8-frame \FP\ observation
}{
   \sstdescription{
      This script reduces a Fabry-Perot observation with UFTI data.  It takes
      an imaging observation comprising eight object frames and a dark frame
      to make a continuum-subtracted and sky-subtracted, untrimmed mosaic
      automatically.

      The sequence of frames expected in the observations are tabulated
      below.

      \begin{center}
      \begin{tabular}{cll}
      Frame & \multicolumn{1}{c}{Position} & \multicolumn{1}{c}{Wavelength} \\ \hline
        1 & On  source & On  line \\
        2 & Off source & On  line \\
        3 & Off source & Off line, positive offset \\
        4 & On  source & Off line, positive offset \\
        5 & On  source & On  line \\
        6 & Off source & On  line \\
        7 & Off source & Off line, negative offset \\
        8 & On  source & Off line, negative offset \\
      \end{tabular}
      \end{center}

      It performs a null debiassing, bad-pixel masking, dark subtraction,
      pairwise frame differencing, flat-field division, integer shifts of
      origin to register, and mosaicking.  The desired result is given by

      \begin{center}
      \[ \frac{[(F1 - F2)-(F4 - F3)] + [(F5 - F6)-(F8 - F7)]}{\rm Flat field} \]
      \end{center}

      where $Fn$ is the bad-pixel masked and dark subtracted frame $n$.
      In practice, the flat field is applied to each differenced pair,
      such as ($F4 - F3$), when the pair becomes available, rather than
      waiting until all eight frames have been observed.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         You should use \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP} to make the flat field.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of eight, the recipe creates a mosaic, which is
         then added into a master mosaic of improving signal to noise.  The
         exposure time is also summed and stored in the mosaic's corresponding
         header.  Likewise the end airmass and end UT headers are updated to
         match that of the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt{gf}$<$date$>$\_$<$group\_number$>$\_mos}, where
         {\tt$<$date$>$} is the UT date in \emph{yyyymmdd} format.

         \sstitem
         A mosaic for each cycle of eight in \\
         {\tt{gf}$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt{f}$<$date$>$\_$<$obs\_number$>$\_ff}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NPAIRS = INTEGER
      }{
         The number of frame pairs to be differenced.  It must be a multiple
         of 2 otherwise 4 is assumed.  A value of four or more is assumed to
         indicate sky subtraction.  {\tt[4]}
      }
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of spatial jitter positions.  For each spatial position
         there are NPAIRS pairs of frames.  A value of 1 also dictates
         that no jittering has occurred.  To make a master mosaic combining
         spatial positions NUMBER should be at least 3.

         If NUMBER is absent, the number of offsets, as given by internal
         header NOFFSETS, minus one is used.  An error state arises if the
         resulting number of jittered frames is fewer than 3, and a default
         of 3 is assumed.

         If neither NUMBER nor NOFFSETS is defined, 1 is used.  {\tt[1]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP},
      \htmlref{FP\_JITTER}{FP\_JITTER},
      \htmlref{FP\_JITTER\_NO\_SKY}{FP\_JITTER\_NO\_SKY}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   FP\_JITTER
}{
   Reduces spatially jittered sets of 8-frame \FP\ observations
}{
   \sstdescription{
      This script reduces a Fabry-Perot observation with UFTI data.  It
      takes an imaging observation comprising at least three sets of eight
      object frames, each set being for a different telescope position.
      The recipe combines these with a dark frame and a separate flat, to
      make a continuum-subtracted and sky-subtracted, untrimmed mosaic
      automatically.

      Each sequence of eight frames expected in each spatial position are
      tabulated below.

      \begin{center}
      \begin{tabular}{cll}
      Frame & \multicolumn{1}{c}{Position} & \multicolumn{1}{c}{Wavelength} \\ \hline
        1 & On  source & On  line \\
        2 & Off source & On  line \\
        3 & Off source & Off line, positive offset \\
        4 & On  source & Off line, positive offset \\
        5 & On  source & On  line \\
        6 & Off source & On  line \\
        7 & Off source & Off line, negative offset \\
        8 & On  source & Off line, negative offset \\
      \end{tabular}
      \end{center}

      For each spatial set, the recipe performs a null debiassing, bad-pixel
      masking, dark subtraction, pairwise frame differencing, flat-field
      division, integer shifts of origin to register, and mosaicking.  The
      wavelength-shifted mosaic is given by

      \begin{center}
      \[ \frac{[(F1 - F2)-(F4 - F3)] + [(F5 - F6)-(F8 - F7)]}{\rm Flat field} \]
      \end{center}

      where $Fn$ is the bad-pixel masked and dark subtracted frame $n$.
      In practice, the flat field is applied to each differenced pair,
      such as ($F4 - F3$), when the pair becomes available, rather than
      waiting until all eight frames have been observed.

      Finally the recipe registers all the wavelength mosaics spatially, and
      forms a untrimmed mosaic, combined using the median to reduce stellar
      artifacts.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         You should use \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP} to make the flat field.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         For each set of eight, the recipe creates a wavelength mosaic.
         For each cycle of spatial positions the wavelength mosaics are
         registered to form a spatial mosaic.  For repeat cycles the spatial
         mosaic is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the master
         mosaic's corresponding header.  Likewise the end airmass and
         end UT headers are updated to match that of the last-observed
         frame contributing to the mosaic.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         No mosaic is trimmed to the dimensions of a single frame, thus the
         noise will be greater in the peripheral areas of the spatial having
         received less exposure time.  Each mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt{gf}$<$date$>$\_$<$group\_number$>$\_mos}, where
         {\tt$<$date$>$} is the UT date in \emph{yyyymmdd} format.

         \sstitem
         A mosaic for each cycle of eight in \\
         {\tt{gf}$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt{f}$<$date$>$\_$<$obs\_number$>$\_ff}.
      }
    }
    \sstparameters{
      \sstsubsection{
         NPAIRS = INTEGER
      }{
         The number of frame pairs to be differenced.  It must be a multiple
         of 2 otherwise 4 is assumed.  A value of four or more is assumed to
         indicate sky subtraction.  {\tt[4]}
      }
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of spatial jitter positions.  For each spatial position
         there are NPAIRS pairs of frames.  A value of 1 also dictates
         that no jittering has occurred.  To make a master mosaic combining
         spatial positions NUMBER should be at least 3.

         If NUMBER is absent, the number of offsets, as given by internal
         header NOFFSETS, minus one is used.  An error state arises if the
         resulting number of jittered frames is fewer than 3, and a default of
         3 is assumed.

         If neither NUMBER nor NOFFSETS are defined, 1 is used.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{FP}{FP},
      \htmlref{FP\_JITTER\_NO\_SKY}{FP\_JITTER\_NO\_SKY},
      \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   FP\_JITTER\_NO\_SKY
}{
   Reduces a spatially jittered 4-frame \FP\ observation
}{
   \sstdescription{
      This script reduces a Fabry-Perot observation with UFTI data.  It
      takes an imaging observation comprising at least three sets of
      four object frames, each set being for a different telescope position.
      The recipe combines these with a dark frame and a separate flat, to
      make a continuum-subtracted, untrimmed mosaic automatically.

      Each sequence of four frames expected in each spatial position are
      tabulated below.

      \begin{center}
      \begin{tabular}{cll}
      Frame & \multicolumn{1}{c}{Position} & \multicolumn{1}{c}{Wavelength} \\ \hline
        1 & On  source & On  line \\
        2 & On  source & Off line, positive offset \\
        3 & On  source & On  line \\
        4 & On  source & Off line, negative offset \\
      \end{tabular}
      \end{center}

      For each spatial set, the recipe performs a null debiassing, bad-pixel
      masking, dark subtraction, pairwise frame differencing, flat-field
      division, integer shifts of origin to register, and mosaicking.  The
      wavelength-shifted mosaic is given by

      \begin{center}
      \[ \frac{[(F1 - F2) - (F4 - F3)]}{\rm Flat field} \]
      \end{center}

      where $Fn$ is the bad-pixel masked and dark subtracted frame $n$.
      In practice, the flat field is applied to each differenced pair,
      such as ($F1 - F2$), when the pair becomes available, rather than
      waiting until all four frames have been observed.

      Finally the recipe registers all the wavelength mosaics spatially, and
      forms a untrimmed mosaic, combined using the median to reduce stellar
      artifacts.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         You should use \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP} to make the flat field.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         For each set of four, the recipe creates a wavelength mosaic.
         For each cycle of spatial positions the wavelength mosaics are
         registered to form a spatial mosaic.  For repeat cycles the spatial
         mosaic is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the master
         mosaic's corresponding header. Likewise the end airmass and end
         UT headers are updated to match that of the last-observed frame
         contributing to the mosaic.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         No mosaic is trimmed to the dimensions of a single frame, thus the
         noise will be greater in the peripheral areas of the spatial having
         received less exposure time.  Each mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt{gf}$<$date$>$\_$<$group\_number$>$\_mos}, where
         {\tt$<$date$>$} is the UT date in \emph{yyyymmdd} format.

         \sstitem
         A mosaic for each cycle of eight in \\
         {\tt{gf}$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt{f}$<$date$>$\_$<$obs\_number$>$\_ff}.
      }
    }
    \sstparameters{
      \sstsubsection{
         NPAIRS = INTEGER
      }{
         The number of frame pairs to be differenced.  It must be a multiple
         of 2 otherwise 4 is assumed.  A value of four or more is assumed to
         indicate sky subtraction.  {\tt[2]}
      }
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of spatial jitter positions.  For each spatial position
         there are NPAIRS pairs of frames.  A value of 1 also dictates
         that no jittering has occurred.  To make a master mosaic combining
         spatial positions NUMBER should be at least 3.

         If NUMBER is absent, the number of offsets, as given by internal
         header NOFFSETS, minus one is used.  An error state arises if the
         resulting number of jittered frames is fewer than 3, and a default of
         3 is assumed.

         If neither NUMBER nor NOFFSETS are defined, 1 is used.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP},
      \htmlref{FP}{FP},
      \htmlref{FP\_JITTER}{FP\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT
}{
   Reduces a ``standard jitter'' photometry observation using object
   masking
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation
      comprising jittered object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{jsf_notes} for further information.

      This recipe works well for faint sources and for moderately
      crowded fields.
   }
   \label{jsf_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         For INGRID, the pre- and post-exposure images are subtracted.
         A non-linearity correction is then applied.

         \sstitem
         The dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         The field distortion of ISAAC is corrected in the target frames
         using the mappings documented on the
         \htmladdnormallink{ISAAC problems web page}
         {http://www.eso.org/instruments/isaac/problems_tips.html}.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass header and end UT headers are updated to match
         that of the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},
      \htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC},\\
      \htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK},
      \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE},\\
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      JITTER3\_SELF\_FLAT, JITTER5\_SELF\_FLAT, JITTER9\_SELF\_FLAT.
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_APHOT
}{
   Reduces a ``standard jitter'' photometry observation using
   object masking, and performs aperture photometry
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation
      comprising jittered object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{jsfa_notes} for further information.

      Photometry of the point source using a fixed 5-arcsecond aperture
      is calculated for each jitter frame and the mosaic.  The results
      appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in the form of a Starlink
      small text list.  The analysis of each star is appended to this file.

      This recipe works well for faint sources in moderately crowded fields.
   }
   \label{jsfa_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         For INGRID, the pre- and post-exposure images are subtracted.
         A non-linearity correction is then applied.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         The field distortion of ISAAC is corrected in the target frames
         using the mappings documented on the
         \htmladdnormallink{ISAAC problems web page}
         {http://www.eso.org/instruments/isaac/problems_tips.html}.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass header and end UT headers are updated to match that
         of the last-observed frame contributing to the mosaic.

         \sstitem
         The photometry tabulation includes the file name, source name,
         time, filter, airmass, the catalogue magnitude and estimates of
         the zero-point with and without the application of a mean
         extinction.  There are headings at the top of each column.

         \sstitem
         The photometry uses a multiply clipped (2,2,2.5,3 standard
         deviations) mean to estimate the sky mode in an annulus about the
         source.  This is not unduly biased by the presence of the self-flat
         artifact in the pixel histogram.  The inner annulus diameter is 1.3
         times that of the aperture (6.5 arcsec); the outer annulus is 2.5
         times (12.5 arcsec) for UFTI and twice the aperture (10 arcsec) for
         IRCAM and IRIS2.  The errors are internal, based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},\\
      \htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC},
      \htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK},\\
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{},
         \xref{\EXTRACTOR}{sun226}{}, and \xref{\PHOTOM}{sun45}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      JITTER5\_SELF\_FLAT\_APHOT.
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_BASIC
}{
   Reduces a ``standard jitter'' photometry observation using
   just the basic operations for speed
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation
      comprising jittered object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation, flat-field division, integer
      shifts of origin to register, and mosaicking.  See the
      \htmlref{``Notes''}{jsfb_notes} for further information.

      This recipe aims to keep pace with the pipeline's incoming
      data, and is intended for faint sources and for moderately
      crowded fields.
   }
   \label{jsfb_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created by combining normalised object
         frames using the clipped median at each pixel.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to noise.
         The exposure time is also summed and stored in the mosaic's
	 corresponding header.  Likewise the end airmass header and
	 end UT headers are updated to match that of the last-observed
	 frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},\\
      \htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK},
      \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE},\\
      \htmlref{MOVING\_JITTER\_SELF\_FLAT\_BASIC}{MOVING\_JITTER\_SELF\_FLAT\_BASIC},
      \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      JITTER5\_SELF\_FLAT\_BASIC, JITTER9\_SELF\_FLAT\_BASIC.
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_CATALOGUE
}{
   Reduces a ``standard jitter'' photometry observation using object
   masking, and produces a catalogue of all sources in the field
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation
      comprising jittered object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{jsfc_notes} for further information.

      Source extraction is performed only on the reduced mosaic, and
      uses \EXTRACTOR.  The results appear in
      {\tt\$ORAC\_DATA\_OUT/catalogue\_$<$group\_number$>$.txt}.
      No zero-point or airmass corrections are applied to the
      instrumental magnitudes.

      This recipe works well for faint sources and for moderately
      crowded fields.
   }
   \label{jsfc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         For INGRID, the pre- and post-exposure images are subtracted.
         A non-linearity correction is then applied.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         The field distortion of ISAAC is corrected in the target frames
         using the mappings documented on the
         \htmladdnormallink{ISAAC problems web page}
         {http://www.eso.org/instruments/isaac/problems_tips.html}.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass header and end UT headers are updated to match
         that of the last-observed frame contributing to the mosaic.

         \sstitem
         The catalogue includes the right ascension and declination,
         instrumental apparent magnitude (calculated as
         $-2.5 * \log( {\rm{counts}} ))$, and the error in the magnitude.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.

         \sstitem
         The catalogue in \texttt{catalogue\_$<$group\_number$>$.txt}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE\_CATALOGUE}{BRIGHT\_POINT\_SOURCE\_CATALOGUE},
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},\\
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_NCOLOUR
}{
   Reduces a multi-colour ``standard jitter'' photometry observation
   using object masking
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data observed through one or more filters.  For
      each filter it takes an observation comprising jittered object
      frames and a dark frame to make a calibrated, untrimmed mosaic
      automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{jsfnc_notes} for further information.

      This recipe works well for faint sources and for moderately
      crowded fields.
   }
   \label{jsfnc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is
	 also summed and stored in the mosaic's corresponding header.
	 Likewise the end airmass header and end UT headers are
	 updated to match that of the last-observed frame contributing
	 to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames for each filter in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$filter$>$\_mos$<$cycle\_number$>$}, where\\
         {\tt$<$cycle\_number$>$} counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}
         for the first or only cycle, and
         {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}} for subsequent
         cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter.  If absent, the number of
         offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 5 is used.  An error state arises if
         the number of jittered frames is fewer than 3.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{}
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      JITTER5\_SELF\_FLAT\_NCOLOUR.
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_NCOLOUR\_APHOT
}{
   Reduces a multi-colour ``standard jitter'' photometry observation using
   object masking, and performs aperture photometry
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data observed through one or more filters.
      For each filter it takes an imaging observation
      comprising jittered object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{jsfna_notes} for further information.

      Photometry of the point source using a fixed 5-arcsecond aperture
      is calculated for each jitter frame and the mosaic.  The results
      appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in the form of a Starlink
      small text list.  The analysis of each star is appended to this file.

      This recipe works well for faint sources in moderately crowded fields.
   }
   \label{jsfna_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         For INGRID, the pre- and post-exposure images are subtracted.
         A non-linearity correction is then applied.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         The field distortion of ISAAC is corrected in the target frames
         using the mappings documented on the
         \htmladdnormallink{ISAAC problems web page}
         {http://www.eso.org/instruments/isaac/problems_tips.html}.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass header and end UT headers are updated to match that
         of the last-observed frame contributing to the mosaic.

         \sstitem
         The photometry tabulation includes the file name, source name,
         time, filter, airmass, the catalogue magnitude and estimates of
         the zero-point with and without the application of a mean
         extinction.  There are headings at the top of each column.

         \sstitem
         The photometry uses a multiply clipped (2,2,2.5,3 standard
         deviations) mean to estimate the sky mode in an annulus about the
         source.  This is not unduly biased by the presence of the self-flat
         artifact in the pixel histogram.  The inner annulus diameter is 1.3
         times that of the aperture (6.5 arcsec); the outer annulus is 2.5
         times (12.5 arcsec) for UFTI and twice the aperture (10 arcsec) for
         IRCAM and IRIS2.  The errors are internal, based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$filter$>$\_mos$<$cycle\_number$>$}, where \\
         {\tt$<$cycle\_number$>$} counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},\\
      \htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC},
      \htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK},\\
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{},
         \xref{\EXTRACTOR}{sun226}{}, and \xref{\PHOTOM}{sun45}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_NO\_MASK
}{
   Reduces a ``standard jitter'' photometry observation without object
   masking
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation
      comprising jittered object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{jsfn_notes} for further information.

      This recipe works well for faint sources and sparse fields.
   }
   \label{jsfn_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created by combining normalised object
         frames using the clipped median at each pixel.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.
	 Likewise the end airmass header and end UT headers are
	 updated to match that of the last-observed frame contributing
	 to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},\\
      \htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC},
      \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE},\\
      \htmlref{QUADRANT\_JITTER\_NO\_MASK}{QUADRANT\_JITTER\_NO\_MASK}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      JITTER5\_SELF\_FLAT\_NO\_MASK, JITTER9\_SELF\_FLAT\_NO\_MASK.
   }
}

%\newpage
\sstroutine{
   JITTER\_SELF\_FLAT\_TELE
}{
   Reduces a ``standard jitter'' photometry observation using
   object masking, and telescope offsets for registration
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with near-infrared imaging data.  It takes an observation comprising jittered
      object frames and a dark frame to make a calibrated, untrimmed
      mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, registration
      using telescope offsets, and resampling.  See the
      \htmlref{``Notes''}{jsft_notes} for further information.

      This recipe works well for faint sources and for moderately
      crowded fields.  It is also used for observations that track a
      moving object.
   }
   \label{jsft_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.
	 Likewise the end airmass header and end UT headers are
	 updated to match that of the last-observed frame contributing
	 to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},\\
      \htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC},
      \htmlref{JITTER\_SELF\_FLAT\_NO\_MASK}{JITTER\_SELF\_FLAT\_NO\_MASK},\\
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      JITTER9\_SELF\_FLAT\_TELE.
   }
}

\newpage
\sstroutine{
   LAMP\_FLAT
}{
   Creates and files imaging flat fields derived from a calibration lamp
}{
   \sstdescription{
      This recipe makes one or more flats for ESO infrared imaging from
      a series of internal flat frames with the calibration lamp
      alternating on then off.  A new flat is made for each combination
      of filter.

      It performs a null debiassing, bad-pixel masking, then differences
      each pair of frames.  Once all pairs have been so processed,
      these are then treated like sky flats; normalised frames are
      combined pixel by pixel using the median.  Details of each flat are
      filed in the index of flats for future selection and use of the flat.
      See the \htmlref{``Notes''}{lf_notes} for further details.
   }
   \label{lf_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The created flat field in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and
         {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent recipe cycles.  Token {\tt$<$filter$>$} is the
         filter name, {\tt$<$group\_number$>$} is the frame number of the group,
         and {\tt$<$cycle\_number$>$} is the number of the cycle, counting from one.

         \sstitem
         The flats are filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the group.  If absent, the number of
         offsets, as given by header {\tt{HIERARCH.ESO.TPL.NEXP}}.  If neither
         is available, 6 is used.  An error state arises if the number of
         jittered frames is fewer than 6 or is odd numbered.   {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstdiytopic{
      References
   }{
    \htmladdnormallink{\emph{ISAAC Data Reduction Guide
    1.5}}{http://www.eso.org/instruments/isaac/drg/html/drg.html}, P. Amico et al., 2002.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages
         \xref{\CCDPACK}{sun139}{} and \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

\newpage
\sstroutine{
   MAKE\_BPM
}{
   Creates and files a \htmlref{bad-pixel mask}{bad_pixels} from a long-exposure dark
}{
   \sstdescription{
      This recipe reduces a long-exposure dark-frame observation
      of infrared imaging data to create a bad-pixel mask.  It files the
      mask in the mask index file.  Reduction comprises only thresholding
      the pixel values about a clipped mean using a multiple of the
      clipped standard deviation.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The dark must have a minimum exposure of 20 seconds.

         \sstitem
         Clipping is at 2,3,3 standard deviations.

         \sstitem
         Bad values are deemed to be those beyond the range of
         the clipped mean $+$/$-$ 5 standard deviations.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The bad-pixel mask is called \texttt{bpm\_$<$frame\_number$>$}.

         \sstitem
         The bad-pixel mask is filed in {\tt\$ORAC\_DATA\_OUT/index.mask}.
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{DARK\_AND\_BPM}{DARK\_AND\_BPM}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is \texttt{"bpm\_$<$frame\_number$>$"}.

         \sstitem
         Error propagation is not used.
      }
   }
}

\sstroutine{
   MEASURE\_READNOISE
}{
   Measures and files the readnoise for UIST from a set of dark
   frames
}{
   \sstdescription{
      This recipe measures the readnoise for a group of five
      short-exposure UIST DARK frames and files that measurement with the
      calibration system.  It also determines the readnoise variance.
      The readnoise result is compared with the nominal value; you are
      notified whether or not the value is within acceptable limits.
      The recipe appends a tabulation of the readnoise and its variance
      in a log file, {\tt\$ORAC\_DATA\_OUT/uist\_array\_tests.log}, which it
      creates with headings if the log does not exist.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The first dark frame is used to `clean up' the array before statistics
         are done on the remaining frames.

         \sstitem
         The recipe calculates the readnoise as follows.  It first derives
         the population variance estimate (PVE) of the dark frames, calculated
         on a per-pixel basis.  It then finds the square root of the mean of this
         PVE image.  If the images were taken before UT 2002 December 2, the
         readnoise is calculated as the product of the square root of the mean of
         the PVE, the number of reads minus one, the read interval, and the
         the gain, divided by the number of multiple reads.  Otherwise, the
         readnoise is formed by multiplying the gain by the square root of the
         mean.

         \sstitem
         The readnoise is nominal if it falls between 38 and 45 e-/second.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The engineering log {\tt\$ORAC\_DATA\_OUT/uist\_array\_tests.log}.
      }
   }
   \sstparameters{
      \sstsubsection{
         DARK\_FRAMES = INTEGER
      }{
         The number of dark frames to combine.  The maximum allowed is 9. [5]
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS},
      \htmlref{DARK\_AND\_BPM}{DARK\_AND\_BPM}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages KAPPA and
         CCDPACK.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         Error propagation is not used.
      }
   }
}

%\newpage
\sstroutine{
   MOVING\_JITTER\_SELF\_FLAT
}{
   Reduces a ``standard jitter'' photometry observation of a
   moving target using object masking
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with UKIRT imaging data.  It takes an observation comprising
      jittered object frames of a moving target and a dark frame to
      make automatically a calibrated, untrimmed mosaic in the
      reference frame of the target.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, feature
      detection and matching between object frames, and resampling.
      See the \htmlref{``Notes''}{mjsf_notes} for further information.

      Registration is adjusted to track the motion of the moving
      target using ephemeris data stored in file \texttt{target\_ephem.dat}.
      See \htmlref{``Ephemeris-file Format''}{mjsf_ephem_format} for details
      of this file's format.

      This recipe works well for faint moving sources and in moderately
      crowded fields.  It should not be used for frames where the
      telescope guided on the moving object.  In that case reduction
      should be performed by \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE} which registers
      using the telescope offsets alone.
   }
   \label{mjsf_notes}
   \sstnotes{
      \sstitemlist{
         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat field is created by combining normalised object frames using
         the median at each pixel.  This flat field is applied to the object
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.  Once the offsets are determined, they
         are adjusted for the motion of the target, so that the final
         mosaic registers the target, not the background stars.

         \sstitem
         The ephemeris file is specified by environment variable
         {\tt{ORAC\_EPHEMERIS}}, defaulting to {\tt\$ORAC\_DATA\_OUT/target\_ephem.dat}.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.
	 Likewise the end airmass header and end UT headers are
	 updated to match that of the last-observed frame contributing
	 to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \label{mjsf_ephem_format}
   \sstdiytopic{
      Ephemeris-file Format
   }{
      The current format of the ephemeris file is one line per object
      comprising three space-separated fields in the following order:
      \ssthitemlist{

         \sstitem
           the objectname, which may contain embedded spaces;

         \sstitem
           the motion in the plane of the sky in arcsec/second for right
           ascension then declination.

      }
      Note that the right ascension motion is the change in right ascension
      multiplied by the cosine of the declination.  The format will change
      to include UT and possibly date.
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE},\\
      \htmlref{MOVING\_JITTER\_SELF\_FLAT\_BASIC}{MOVING\_JITTER\_SELF\_FLAT\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      MOVING\_JITTER9\_SELF\_FLAT.
   }
}

%\newpage
\sstroutine{
   MOVING\_JITTER\_SELF\_FLAT\_BASIC
}{
   Reduces a ``standard jitter'' photometry observation of a
   moving target using just the basic operations for speed
}{
   \sstdescription{
      This script reduces a ``standard jitter'' photometry observation
      with UKIRT imaging data.  It takes an observation comprising
      jittered object frames of a moving target and a dark frame to make
      automatically a calibrated, untrimmed mosaic in the reference
      frame of the target.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, flat-field creation and division, amd integer shifts
      of pixel origin to register to fixed sky co-ordinates.   See the
      \htmlref{``Notes''}{mjsfb_notes} for further information.

      The registration is adjusted to track the motion of the moving
      target using ephemeris data stored in file \texttt{target\_ephem.dat}.
      See \htmlref{``Ephemeris-file Format''}{mjsfb_ephem_format} for details
      of this file's format.

      This recipe aims to keep pace with the pipeline's incoming data.
      It works well for faint moving sources and in moderately
      crowded fields.  It should not be used for frames where the
      telescope guided on the moving object.  In that case reduction
      should be performed by \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE} which registers
      using the telescope offsets alone.
   }
   \label{mjsfb_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created by combining normalised object
         frames using the median at each pixel.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.  Once the offsets are determined, they
         are adjusted for the motion of the target, so that the final
         mosaic registers the target, not the background stars.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The ephemeris file is specified by environment variable
         {\tt{ORAC\_EPHEMERIS}}, defaulting to \texttt{\$ORAC\_DATA\_OUT/target\_ephem.dat}.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the
	 mosaic's corresponding header.  Likewise the end airmass
	 header and end UT headers are updated to match that of the
	 last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \label{mjsfb_ephem_format}
   \sstdiytopic{
      Ephemeris-file Format
   }{
      The current format of the ephemeris file is one line per object
      comprising three space-separated fields in the following order:
      \ssthitemlist{

         \sstitem
           the objectname, which may contain embedded spaces; and

         \sstitem
           the motion in the plane of the sky in arcsec/second for right
         ascension then declination.

      }
      Note that the right-ascension motion is the change in right ascension
      multiplied by the cosine of the declination.  The format may change
      to include UT and possibly date.
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of jittered frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern.  If not supplied
         the number of offsets, as given by FITS header NOFFSETS, minus
         one is used.  If neither is available, 9 is the default.  An
         error state arises if the number of jittered frames is fewer
         than 3.  For observations prior to the availability of full
         ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT\_BASIC}{JITTER\_SELF\_FLAT\_BASIC},
      \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE},\\
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      MOVING\_JITTER9\_SELF\_FLAT\_BASIC.
   }
}


%\newpage
\sstroutine{
   MOVING\_NOD\_CHOP
}{
   Reduces a chopped and nodded observation of a moving target
}{
   \sstdescription{
      This script reduces a chopped and nodded observation, currently
      just for Michelle data.  It takes an imaging observation
      comprising a multiple-of-four object frames to make automatically
      a calibrated, untrimmed mosaic in the reference frame of a moving
      target.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic.  See the \htmlref{``Notes''}{mnc_notes}
      for further information.

      Registration is adjusted to track the motion of the moving
      target using ephemeris data stored in file \texttt{target\_ephem.dat}.
      See \htmlref{``Ephemeris-file Format''}{mnc_ephem_format} for details
      of this file's format.
   }
   \label{mnc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each beam, first using the read
         noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The ARRAY\_TESTS
         recipe files a suitable short-exposure dark as a bias in the
         calibration system.

         \sstitem
         The integrations of the two beams are differenced, the first
         subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixel, adjusted for the motion of the target, so
         that the final mosaic registers the target, not the background stars.

         \sstitem
         The ephemeris file is specified by environment variable
         \texttt{ORAC\_EPHEMERIS}, defaulting to {\tt\$ORAC\_DATA\_OUT/target\_ephem.dat}.

         \sstitem
         The resampling applies integer shifts of origin.   There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass and end UT headers are updated to match that of the
         last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \label{mnc_ephem_format}
   \sstdiytopic{
      Ephemeris-file Format
   }{
      The current format of the ephemeris file is one line per object
      comprising three space-separated fields in the following order:
      \ssthitemlist{

         \sstitem
           the objectname, which may contain embedded spaces;

         \sstitem
           the motion in the plane of the sky in arcsec/second for right
           ascension then declination.

      }
      Note that the right ascension motion is the change in right ascension
      multiplied by the cosine of the declination.  The format will change
      to include UT and possibly date.
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$},
         where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{NOD\_CHOP}{NOD\_CHOP},
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT},
      \htmlref{MOVING\_QUADRANT\_JITTER}{MOVING\_QUADRANT\_JITTER}.

   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

\sstroutine{
   MOVING\_QUADRANT\_JITTER
}{
   Reduces a ``Quadrant Jitter'' observation, of a moving target including
   object masking
}{
   \sstdescription{
      This script reduces a ``quadrant jitter'' photometry observation
      with UKIRT imaging data.  It takes an imaging observation comprising
      one or more series of four object frames where the target is
      approximately centred in each quadrant; and a dark frame to make
      automatically a calibrated, untrimmed mosaic in the reference
      frame of the moving target.

      It performs bad-pixel masking, null debiassing, dark subtraction,
      flat-field creation and division, feature detection and matching
      between object frames, and resampling.   See the
      \htmlref{``Notes''}{mqj_notes} for further information.

      Registration is adjusted to track the motion of the moving
      target using ephemeris data stored in file \texttt{target\_ephem.dat}.
      See \htmlref{``Ephemeris-file Format''}{mqj_ephem_format} for details
      of this file's format.

      This recipe works well for extended moving sources (comets), whose
      extent does not exceed 45 arcseconds for UFTI or 10 arcseconds
      for IRCAM, in moderately crowded fields.  Sources may include
      those with a comparatively bright core embedded in faint extended
      emission.  The object need not be isolated, as the recipe masks
      objects within the other quadrants, and hence does not introduce
      significant artifacts into the flat field.  This recipe should not
      be used for frames where the telescope guided on the moving object.
      In that case reduction should be performed by
      \htmlref{QUADRANT\_JITTER\_TELE}{QUADRANT\_JITTER\_TELE},
      which registers using the telescope offsets alone.
   }
   \label{mqj_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First the quadrant
         containing the object is masked in each object frame.  Second an
         approximate flat field is created by combining the normalised
         and masked object frames using the clipped median at each pixel.
         This flat field is applied to the object frames.  Sources within
         the flat-fielded frames are detected, and masked in the
         dark-subtracted frames.  The second stage is repeated but applied
         to the masked frames to create the final flat field.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, it matches the centroid of the central source.  If this
         fails, the script resorts to using the telescope offsets
         transformed to pixels.  Once the offsets are determined, they
         are adjusted for the motion of the target, so that the final
         mosaic registers the target, not the background stars.

         \sstitem
         The ephemeris file is specified by environment variable
         {\tt{ORAC\_EPHEMERIS}}, defaulting to {\tt\$ORAC\_DATA\_OUT/target\_ephem.dat}.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame.  Thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The full signal will be in the central ninth
         containing the main object.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of four, the recipe creates a mosaic, which has
         its bad pixels filled and is then added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \label{mqj_ephem_format}
   \sstdiytopic{
      Ephemeris-file Format
   }{
      The current format of the ephemeris file is one line per object
      comprising three space-separated fields in the following order:
      \ssthitemlist{

         \sstitem
           the objectname, which may contain embedded spaces;

         \sstitem
           the motion in the plane of the sky in arcsec/second for right
           ascension then declination.

      }
      Note that the right ascension motion is the change in right ascension
      multiplied by the cosine of the declination.  The format will change
      to include UT and possibly date.
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of four in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is {\tt{f}} for UFTI and {\tt{i}} for IRCAM, and {\tt{u}} for UIST.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER},
      \htmlref{QUADRANT\_JITTER\_TELE}{QUADRANT\_JITTER\_TELE}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   NIGHT\_LOG
}{
   Produces a text file log of a night's observations
}{
   \sstdescription{
      This recipe takes a night's observations, and creates a text file
      containing a headed tabulation of parameters for each frame.

      The parameters are: observation number, object name, observation type,
      UT start time, exposure time, number of coadds, read mode and speed,
      filter, start airmass, frame dimensions in pixels, base equatorial
      co-ordinates, and data-reduction recipe name.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         Run with \texttt{oracdr -noeng -nodisplay -from 1 -skip}  for efficiency.

         \sstitem
         The \texttt{$<$date$>$} comes from the header keyword DATE.

         \sstitem
         Specification provided by Sandy Leggett.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The text log file \texttt{\$ORAC\_DATA\_IN/$<$date$>$.nightlog}, where
         \texttt{$<$date$>$} is the UT date.
      }
   }
}

%\newpage
\sstroutine{
   NOD\_CHOP
}{
   Reduces a chopped and nodded observation
}{
   \sstdescription{
      This script reduces a chopped and nodded observation, currently
      just for Michelle data.  It takes an imaging observation comprising
      a multiple-of-four object frames to make a calibrated, untrimmed
      mosaic automatically.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic.  See the \htmlref{``Notes''}{nc_notes}
      for further information.
   }
   \label{nc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each beam, first using the read
         noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The ARRAY\_TESTS
         recipe files a suitable short-exposure dark as a bias in the
         calibration system.

         \sstitem
         The integrations of the two beams are differenced, the first
         subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.   There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass and end UT headers are updated to match that of the
         last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$},
         where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   NOD\_CHOP\_APHOT
}{
   Reduces a chopped and nodded observation, and performs aperture
   photometry
}{
   \sstdescription{
      This script reduces a chopped and nodded observation, currently
      just for Michelle data.  It takes an imaging observation comprising
      a multiple-of-four object frames to make a calibrated, untrimmed
      mosaic automatically.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic.  See the \htmlref{``Notes''}{nca_notes}
      for further information.

      The script combines and registers the various chopped and nodded
      images of the point source and neighbouring background to form
      to form a single image with four times the signal.  Photometry of
      the point source using a fixed 5-arcsecond aperture is then
      calculated.  The results appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in
      the form of a Starlink small text list.  The analysis of each star is
      appended to this file.
   }
   \label{nca_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each beam, first using the read
         noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The
         \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} recipe files a suitable
         short-exposure dark as a bias in the calibration system.

         \sstitem
         The integrations of the two beams are differenced, the first
         subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.  There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass and end UT headers are updated to match that of the
         last-observed frame contributing to the mosaic.

         \sstitem
         The combined source image is made by taking symmetrical areas
         about each source, such that no pixels are duplicated.  Thus the
         divisions occur at midpoints of the chop throw and the nod
         separations.  These are registered using the source centroids.

         \sstitem
         The photometry tabulation includes the file name, source name,
         time, filter, airmass, the catalogue magnitude and estimates of
         the zero-point with and without the application of a mean
         extinction.  There are headings at the top of each column.

         \sstitem
         The photometry uses a multiply clipped (2,2,2.5,3 standard
         deviations) mean to estimate the sky mode in an annulus about the
         source.  The inner annulus diameter is 1.5 times that of the
         aperture (7.5 arcsec); the outer annulus is 3.0 times (15 arcsec)
         for Michelle.  The errors are internal, based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$},
         where {\tt$<$cycle\_number$>$} \\
         counts from 0.

         \sstitem
         The combined source image and neighbourhoods in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_cab}.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{NOD\_CHOP}{NOD\_CHOP},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT},\\
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and
         \xref{\PHOTOM}{sun45}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   NOD\_CHOP\_FAINT
}{
   Reduces a chopped and nodded observation of a faint source, combining
   images and smoothing
}{
   \sstdescription{
      This script reduces a chopped and nodded observation of a faint
      point or compact source, currently just for Michelle data.  It
      takes an imaging observation comprising a multiple-of-four object
      frames to make a calibrated, smoothed combined image of the source
      automatically.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic containing positive and negative images
      of the source.  Column and row patterns are filtered.

      The script extracts the various chopped and nodded images of the
      source and neighbouring background from the mosaic.  It combines
      them using a median filter at each pixel to form to form a single
      image of the source with four times the signal.  This combined
      frame is smoothed to enhance the visibility of faint sources.

      See the \htmlref{``Notes''}{ncf_notes} for further information.
   }
   \label{ncf_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each beam, first using the read
         noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The
         \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} recipe files a suitable
         short-exposure dark as a bias in the calibration system.

         \sstitem
         The integrations of the two beams are differenced, the first
         subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.   There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass and end UT headers are updated to match that of the
         last-observed frame contributing to the mosaic.

         \sstitem
         Pickup and bias variation patterns, evident as ripples in the
         rows or bands in the columns respectively, are removed by
         subtracting the median along each column or row from the pixels
         in that column or row.

         \sstitem
         The combined source image is made by taking symmetrical areas
         about the expected position of each source (derived from the
         chop throw and the nod separations), corrected for a shift
         of the base location from its nominal position.  The shift comes
         from centroiding on bright sources with recipe
         \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT}.
         The areas extend such that no pixels are duplicated.  Thus the
         divisions occur at midpoints between the four images.

         \sstitem
         The combined source image is smoothed using a 4-by-4 pixel
         block-average filter.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix), and the bias- and pickup-corrected frames
         ({\tt\_cpc} and {\tt\_rpc} suffices).
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$},
         where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The combined source image and neighbourhoods in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_cab}.  The smoothed combined image in\\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_scab}.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{NOD\_CHOP}{NOD\_CHOP},
      \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   NOD\_CHOP\_SCAN
}{
   Reduces a chopped and nodded observation in a scan pattern
}{
   \sstdescription{
      This script reduces chopped and nodded observation, currently
      just for Michelle data.  It takes an imaging observation comprising
      a multiple-of-four object frames at a series of scan offset
      positions to make calibrated, untrimmed mosaics at each scan
      position automatically.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic at each scan position.  See the
      \htmlref{``Notes''}{ncs_notes} for further information.
   }
   \label{ncs_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each beam, first using the read
         noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The
         \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} recipe files a suitable
         short-exposure dark as a bias in the calibration system.

         \sstitem
         The integrations of the two beams are differenced, the first
         subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         The telescope offsets of the first frame in each multiple-of-four
         frames define scan position.  The recipe creates a mosaic at each
         distinct pair of offsets.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.   There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames at each distinct scan position,
         the recipe creates a mosaic, which has its bad pixels filled and is
         then added into a master mosaic of improving signal to noise for
         that scan position.  The exposure time is also summed and stored in
         the mosaic's corresponding header.  Likewise the end airmass and end
         UT headers are updated to match that of the last-observed frame
         contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem

         The integrated mosaics in
	 {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_o$<$scan$>$\_mos},
	 where {\tt$<$m$>$} is the instrument's \htmlref{group prefix}{file_prefixes},
         {\tt$<$group\_number$>$} is the number of group, and
	 {\tt$<$scan$>$} is the index number of the distinct scan
	 position counting from 0.

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_o$<$scan$>$\_mos$<$cycle\_number$>$}, where \\
         {\tt$<$cycle\_number$>$} counts from 0.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{NOD\_CHOP}{NOD\_CHOP},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT},\\
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   NOD\_SELF\_FLAT\_NO\_MASK
}{
   Reduces a ``nod jitter'' observation
}{
   \sstdescription{
      This script reduces a ``nod jitter'' observation with UKIRT imaging
      data.  It takes an imaging observation comprising a
      multiple-of-four object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, difference adjacent pairs, flat-field creation and
      division, feature detection and matching between object frames,
      and resampling.  See the \htmlref{``Notes''}{nsfnm_notes} for further
      information.

      This recipe works well for faint sources in moderately crowded fields.
   }
   \label{nsfnm_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created by combining normalised object
         frames using the median at each pixel.  There is no cleaning
         of extreme outliers.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         is then added into a master mosaic of improving signal to noise.
         The exposure time is also summed and stored in the mosaic's corresponding
         header.  Likewise the end airmass header and end UT headers are
	 updated to match that of the last-observed frame contributing
	 to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      NOD4\_SELF\_FLAT\_NO\_MASK, NOD8\_SELF\_FLAT\_NO\_MASK.
   }
}

%\newpage
\sstroutine{
   NOD\_SELF\_FLAT\_NO\_MASK\_APHOT
}{
   Reduces a ``nod jitter'' photometry observation, and performs
   aperture photometry
}{
   \sstdescription{
      This script reduces a ``nod jitter'' photometry observation with
      UKIRT imaging data.  It takes an imaging observation comprising a
      multiple-of-four object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, difference adjacent pairs, flat-field creation and
      division, feature detection and matching between object frames,
      and resampling.  See the \htmlref{``Notes''}{nsfnma_notes} for
      further information.

      Photometry of the point source using a fixed 5-arcsecond aperture
      is calculated for each jitter frame and the mosaic.  The results
      appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in the form of a Starlink
      small text list.  The analysis of each star is appended to this file.

      This recipe works well for faint sources in moderately crowded fields.
   }
   \label{nsfnma_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created by combining normalised object
         frames using the median at each pixel.  There is no cleaning
         of extreme outliers.

         \sstitem
         For ISAAC, residual bias variations along the columns are
         largely removed from each flat-fielded frame.  The recipe first
         masks the sources, then collapses the frame along its rows to form
         a profile, whose clipped mean is subtracted.  The resultant profile
         reflects the bias variations.  The recipe subtracts this profile
         from each column of the flat-fielded frame.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         is then added into a master mosaic of improving signal to noise.
         The exposure time is also summed and stored in the mosaic's corresponding
         header.  Likewise the end airmass header and end UT headers are
	 updated to match that of the last-observed frame contributing
	 to the mosaic.

         \sstitem
         The photometry tabulation includes the file name, source
         name, time, filter, airmass, the catalogue magnitude and
         estimates of the zero-point with and without the application
         of a mean extinction.  To discriminate between the various
         results, the positive images have suffix \texttt{\_pos} after the
         frame name and the negative images have a \texttt{\_neg} suffix.
         There are headings at the top of each column.

         \sstitem
         The photometry uses a multiply clipped (2,2,2.5,3 standard
         deviations) mean to estimate the sky mode in an annulus about
         the source.  This is not unduly biased by the presence of the
         self-flat artifact in the pixel histogram. The inner annulus
         diameter is 1.3 times that of the aperture (6.5 arcsec); the
         outer annulus is 2.5 times (12.5 arcsec) for UFTI and twice
         the aperture (10 arcsec) for IRCAM.  The errors are internal,
         based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         For ISAAC, the individual bias-corrected frames in
         {\tt{isaac}$<$date$>$\_$<$obs\_number$>$\_bc}.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      NOD4\_SELF\_FLAT\_NO\_MASK\_APHOT, NOD8\_SELF\_FLAT\_NO\_MASK\_APHOT.
   }
}

\sstroutine{
   NOD\_SKY\_FLAT\_THERMAL
}{
   Reduces a ``nod jitter'' observation creating a flat from sky frames
}{
   \sstdescription{
      This script reduces a ``nod jitter'' observation with UKIRT imaging
      data.  It takes an imaging observation comprising a
      multiple-of-eight object frames and a dark frame to make a
      calibrated, untrimmed mosaic automatically.

      It performs a null debiassing, bad-pixel masking, dark
      subtraction, difference adjacent pairs, flat-field creation and
      division, feature detection and matching between object frames,
      and resampling.  See the \htmlref{``Notes''}{nsft_notes} for further information.

      This recipe works well for faint sources in moderately crowded fields.
   }
   \label{nsft_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created by combining normalised sky
         frames using the median at each pixel.  There is no cleaning
         of extreme outliers.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of object frames, the recipe creates a mosaic,
         which has its bad pixels filled and is then added into a master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in the mosaic's corresponding header.  Likewise
         the end airmass and end UT headers are updated to match that of the
         last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of object frames in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
        NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 8 is used.  An error state arises if
         the number of jittered frames is fewer than 8 and not a
         multiple of 8.   {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   POL\_ANGLE\_JITTER
}{
   Reduces an imaging polarimetry observation, where waveplate angle
   iterates at each jitter position
}{
   \sstdescription{
      This script reduces a polarimetry observation with UKIRT imaging
      data.  It takes an imaging observation comprising object frames
      at the four waveplate angles 0, 45, 22.5, 67.5 degrees for each of
      of a series of jitter positions offset in Right Ascension; and a
      dark frame to make calibrated polarisation images and vectors
      automatically.  See \htmlref{``Output Data''}{paj_data} for a
      list of these images.

      It performs a null debiassing, bad-pixel masking, dark subtraction
      and flat-field division on all frames.  Next the sections of the frame
      representing the e- and o-beam target and sky regions are extracted,
      and the target frames sky-subtracted.  The resultant frames undergo
      registration and resampling to form a mosaic for each waveplate angle
      and beam.  Once all eight mosaics are formed they are registered and
      resampled, and then combined to form the various polarisation images.
      The polarisation data are binned and noisy data excluded from
      a final catalogue of vectors.  See the \htmlref{``Notes''}{paj_notes}
      for details.

      This recipe works well for point sources, and for extended sources
      whose sizes in Right Ascension and Declination are less than about
      35 and 15 arcseconds respectively for UFTI, or 9 and 4 arcseconds
      for IRCAM.  Objects which would appear in both the target and
      sky regions, \emph{{i.e.}}\ Declination extents south of the centre
      larger than 35 arcseconds (UFTI) or 8 arcseconds (IRCAM), should
      use recipe \htmlref{POL\_EXTENDED}{POL\_EXTENDED} for best results.
   }
   \label{paj_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         Data errors are propagated through all processing steps.
         The initial values are found by applying the nominal ADU conversion
         and read noise.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         You should use \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL} or
         \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE} to make the
         flat fields.

         \sstitem
         The target regions are 30\% to 70\% of the frame width about
         the Right-ascension centre, \emph{{i.e.}}\ roughly centred on the source.
         The current sky limits are 1\% to 99\% of the frame width along the
         Right-ascension axis.  The Declination pixel limits are instrument
         dependent, and are as follows.  For UFTI, o sky: 69--264;
         e sky: 320--484; o target: 601--764; e target: 824--988.  For
         IRCAM, o sky: 12--52; e sky: 67--107; o target: 152--192;
         e target: 207--247.

         \sstitem
         The sky subtraction for a beam uses a constant modal sky level
         from the corresponding sky region.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects for automatic registration, the recipe matches the centroid
         of central source within an 8-arcsecond box.  Should that fail for
         the jittered e- and o-beam sections, the recipe resorts to using the
         telescope offsets transformed to pixels.  However, the final option
         for registering the e and o-beam mosaics at different waveplate
         angles, uses the beam offsets in arcseconds for the current filter
         converted to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the few pixels in the peripheral areas
         having received less exposure time.  The mosaic is not normalised by
         its exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of twelve frames, the recipe creates mosaics
         for each beam and waveplate angle.  Each mosaic has its bad pixels
         filled and after the first cycle is then added into its own master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in each master mosaic's corresponding
	 header. Likewise the end airmass header and end UT headers
	 are updated to match that of the last-observed frame
	 contributing to the mosaic.

         \sstitem
         The polarised intensity is corrected for the statistical bias
         of the noise by subtracting the variance of $Q$ or $U$.

         \sstitem
         An offset of 6.3 degrees clockwise is applied to the rotation
         angle for the orientation of the analyser with respect to north.
         A non-null value will be applied once it is determined.

         \sstitem
         The polarisation data for each pixel are also stored in
         catalogues.  See \htmlref{``Output Data''}{paj_data}.

         \sstitem
         The intensity image may be displayed with vectors overlaid.
         Steps are taken to reduce the number of noisy or insignificant
         pixels, as well as clutter.  First, the polarisation catalogue data
         are averaged in 3-by-3-pixel bins.  Second, a binned pixel is
         rejected if its polarisation is greater than 50\% or is not positive,
         or its polarisation signal to noise less than 3, or its polarisation
         error is greater 5\%.  The bin size and thresholds can readily be
         changed by supplying arguments to the \_CALC\_STOKES\_ primitive.

         \sstitem
         At the end of each cycle, the grand mosaics are registered, and
         new polarisation maps and catalogues constructed.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames and the mosaics ({\tt\_mos} or
         {\tt\_mos\_c$<$cycle\_number$>$} suffix).
      }
   }
   \label{paj_data}
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaics in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$beam$>$$<$angle$>$\_mos},
         where {\tt$<$m$>$} the instrument's \htmlref{group prefix.}{file_prefixes}  Token {\tt$<$beam$>$} is {\tt{e}} or {\tt{o}};
         and {\tt$<$angle$>$} is {\tt{0}}, {\tt{22}}, {\tt{45}}, or {\tt{67}}.

         \sstitem
         A mosaic for each cycle of jittered frames per beam and angle in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$beam$>$$<$angle$>$\_mos\_c$<$cycle\_number$>$}, where
         {\tt$<$cycle\_number$>$} counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         Polarisation frames {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$suffix$>$}, each with a
         different suffix for the each parameter.  The suffices are:\\
         \begin{tabular}{cl}
             I &  intensity \\
             P &  percentage polarisation \\
             PI &  polarisation intensity \\
             Q  &  Stokes $Q$ \\
             TH & polarisation angle \\
             U  &  Stokes $U$ \\
         \end{tabular}

         \sstitem
         A FITS binary-table catalogue of the binned and culled
         polarisation data, called {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_I.FIT}.
         For each point it tabulates the $x$-$y$ co-ordinates, the total intensity,
         the Stokes parameters, the percentage polarisation, the polarisation
         angle and intensity.  There are additional columns giving the
         standard deviation on each of the tabulated values (excluding the
         co-ordinates).  Likewise \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_all.FIT} and \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_bin.FIT} store the
         full and binned catalogues respectively.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern, per waveplate angle.
         If this is not set, the number of offsets, as given by FITS
         header NOFFSETS, minus one is used.  If neither is available, 3
         is the default.  An error state arises if the number of jittered
         frames is fewer than 3.  For observations prior to the
         availability of full ORAC, header NOFFSETS will be absent. {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{POL\_EXTENDED}{POL\_EXTENDED},
      \htmlref{POL\_JITTER}{POL\_JITTER},
      \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL},
      \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\POLPACK}{sun223}{},
         \xref{\FIGARO}{sun86}{}, and \xref{\CURSA}{sun190}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaics.  The polarisation maps have new titles as follows
         using the suffices described in {\tt{Output Data}}.  I: {\tt{Intensity}};
         P: {\tt{Polarisation}}; PI: {\tt{Polarised Intensity}}; Q: {\tt{Stokes Q}};
         TH: {\tt{Polarisation Angle}}; U: {\tt{Stokes U}}.

         \sstitem
         The origins of the generated polarisation maps are set to [1,1].
         The WCS current frame is unchanged.

         \sstitem
         The units are set for the frames with suffices (see \htmlref{``Output Data''}{paj_data})
         {\tt{P}} to {\tt{\%}}, and {\tt{TH}} to {\tt{degrees}}.
      }
   }
}

\sstroutine{
   POL\_ANGLE\_NOD\_CHOP
}{
   Reduces a chopped and nodded polarimetry observation, where waveplate
   angle iterates at each jitter position
}{
   \sstdescription{
      This script reduces a chopped and nodded single-beam polarimetry
      observation, currently just for Michelle data.  The imaging
      observation should comprise chopped object frames at the four
      waveplate angles 0, 45, 22.5, 67.5 degrees for each of a
      multiple-of-two pairs of nod positions.  For each waveplate angle
      the recipe makes automatically a calibrated, untrimmed mosaic.  The
      recipe combines the multiple images of the source within each of
      these mosaics into new frames, and uses those four combined frames to
      calculate automatically calibrated polarisation images and vectors
      of the source.  See \htmlref{``Output Data''}{panc_data} for a list
      of these images.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop-beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic.  See the \htmlref{``Notes''}{panc_notes} for
      further information.
   }
   \label{panc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each chop beam, first using the
         read noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The ARRAY\_TESTS
         recipe files a suitable short-exposure dark as a bias in the
         calibration system.

         \sstitem
         The integrations of the two chop beams are differenced, the
         first subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.   There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of frames, the recipe creates mosaics for each
         chop beam and waveplate angle (modulo 180 degrees).  Each mosaic
         has its bad pixels filled and after the first cycle is then added
         into its own master mosaic of improving signal to noise.  The
         exposure time is also summed and stored in each master mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         are updated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         For each waveplate angle, the combined source image is made by
         taking symmetrical areas about each source, such that no pixels
         are duplicated.  Thus the divisions occur at midpoints of the chop
         throw and the nod separations.  These are registered using the
         source centroids.

         \sstitem
         The polarised intensity is corrected for the statistical bias
         of the noise by subtracting the variance of $Q$ or $U$.

         \sstitem
         An offset of 0.0 degrees clockwise is applied to the rotation
         angle for the orientation of the analyser with respect to north.
         A non-null value will be applied once it is determined.

         \sstitem
         The polarisation data for each pixel are also stored in
         catalogues.  See \htmlref{``Output Data''}{panc_data}.

         \sstitem
         The intensity image may be displayed with vectors overlaid.
         Steps are taken to reduce the number of noisy or insignificant
         pixels, as well as clutter.  First, the polarisation catalogue data
         are averaged in 3-by-3-pixel bins.  Second, a binned pixel is
         rejected if its polarisation is greater than 50\% or is not positive,
         or its polarisation signal to noise less than 3, or its polarisation
         error is greater 5\%.  The bin size and thresholds can readily be
         changed by supplying arguments to the \_CALC\_STOKES\_NOD\_CHOP\_
         primitive.

         \sstitem
         At the end of each cycle, the grand mosaics are registered, and
         new polarisation maps and catalogues constructed.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \label{panc_data}
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaics in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_mos},
	 where {\tt$<$m$>$} is the instrument's \htmlref{group prefix}{file_prefixes}; and
	 {\tt$<$angle$>$} is {\tt{0}}, {\tt{22}}, {\tt{45}}, or {\tt{67}}.

         \sstitem
         A mosaic for each cycle of chopped and nodded frames per waveplate angle in
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_mos\_c$<$cycle\_number$>$},
         where \\
         \texttt{$<$cycle\_number$>$} counts from 0.

         \sstitem
         The combined source image and neighbourhoods at each waveplate
         angle in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_cab}.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}

         \sstitem
         Polarisation frames {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$suffix$>$},
         each with a different suffix for the each parameter.  The suffices are:\\
         \begin{tabular}{cl}
             I &  intensity \\
             P &  percentage polarisation \\
             PI &  polarisation intensity \\
             Q  &  Stokes $Q$ \\
             TH & polarisation angle \\
             U  &  Stokes $U$ \\
         \end{tabular}

         \sstitem
         A FITS binary-table catalogue of the binned and culled
         polarisation data, called {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_I.FIT}.
         For each point it tabulates the $x$-$y$ co-ordinates, the total intensity,
         the Stokes parameters, the percentage polarisation, the polarisation
         angle and intensity.  There are additional columns giving the
         standard deviation on each of the tabulated values (excluding the
         co-ordinates).  Likewise \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_all.FIT} and \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_bin.FIT} store the
         full and binned catalogues respectively.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{POL\_NOD\_CHOP}{POL\_NOD\_CHOP},
      \htmlref{POL\_QU\_FIRST\_NOD\_CHOP}{POL\_QU\_FIRST\_NOD\_CHOP},
      \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT},\\
      \htmlref{POL\_ANGLE\_JITTER}{POL\_ANGLE\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\POLPACK}{sun223}{},
         \xref{\FIGARO}{sun86}{}, and \xref{\CURSA}{sun190}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaics.  The polarisation maps have new titles as follows
         using the suffices described in {\tt{Output Data}}.  I: {\tt{Intensity}};
         P: {\tt{Polarisation}}; PI: {\tt{Polarised Intensity}}; Q: {\tt{Stokes Q}};
         TH: {\tt{Polarisation Angle}}; U: {\tt{Stokes U}}.

         \sstitem
         The origins of the generated polarisation maps are set to [1,1].
         The WCS current frame is unchanged.

         \sstitem
         The units are set for the frames with suffices (see \htmlref{``Output Data''}{panc_data})
         {\tt{P}} to {\tt{\%}}, and {\tt{TH}} to {\tt{degrees}}.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   POL\_EXTENDED
}{
   Reduces an imaging polarimetry observation of an extended source
}{
   \sstdescription{
      This script reduces a polarimetry observation with UKIRT imaging
      data.  It takes an imaging observation comprising alternating
      object and sky frames at the four waveplate angles 0, 45,
      22.5, 67.5 degrees in turn, then jittered to at least three
      positions; and a dark frame to make calibrated polarisation images
      and vectors automatically.  See \htmlref{``Output Data''}{pe_data}
      for a list of these images.

      It performs a null debiassing, bad-pixel masking, dark subtraction
      and flat-field division on all frames.  Next the sections of the
      target frame representing the e- and o-beam target regions are
      extracted and sky-subtracted.  The sky levels are determined from
      the two corresponding regions for each beam in the following sky
      frame.   The resultant frames undergo registration and resampling
      to form a mosaic for each waveplate angle and beam.  Once all eight
      mosaics are formed they are registered and resampled, and then
      combined to form the various polarisation images.  The polarisation
      data are binned and noisy data excluded from a final catalogue of
      vectors.  See the \htmlref{``Notes''}{pe_notes} for details.

      This recipe is intended for extended sources whose sizes are more
      than about 35 arcseconds respectively for UFTI, or 8 arcseconds for
      IRCAM.
   }
   \label{pe_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         Data errors are propagated through all processing steps.
         The initial values are found by applying the nominal ADU conversion
         and read noise.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         You should use \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL} or
         \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE} to make the
         flat fields.

         \sstitem
         The target regions are 10\% to 90\% of the frame width about
         the Right-ascension centre, \emph{{i.e.}}\ roughly centred on the source.
         The current sky limits are 1\% to 99\% of the frame width along the
         Right-ascension axis.  The Declination pixel limits are instrument
         dependent, and are as follows.  For UFTI, o sky: 69--264;
         e sky: 320--484; o target: 601--764; e target: 824--988.  For
         IRCAM, o sky: 12--52; e sky: 67--107; o target: 152--192;
         e target: 207--247.

         \sstitem
         The sky subtraction for a beam uses a constant modal sky level
         from the corresponding sky regions.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects for automatic registration, the recipe matches the centroid
         of central source within an 8-arcsecond box.  Should that fail for
         the jittered e- and o-beam sections, the recipe resorts to using the
         telescope offsets transformed to pixels.  However, the final option
         for registering the e and o-beam mosaics at different waveplate
         angles, uses the beam offsets in arcseconds for the current filter
         converted to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the few pixels in the peripheral areas
         having received less exposure time.  The mosaic is not normalised by
         its exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of twelve frames, the recipe creates mosaics
         for each beam and waveplate angle.  Each mosaic has its bad pixels
         filled and after the first cycle is then added into its own master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in each master mosaic's corresponding
	 header.  Likewise the end airmass header and end UT headers
	 are updated to match that of the last-observed frame
	 contributing to the mosaic.

         \sstitem
         The polarised intensity is corrected for the statistical bias
         of the noise by subtracting the variance of $Q$ or $U$.

         \sstitem
         An offset of 6.3 degrees clockwise is applied to the rotation
         angle for the orientation of the analyser with respect to north.

         \sstitem
         The polarisation data for each pixel are also stored in
         catalogues.  See \htmlref{``Output Data''}{pe_data}.

         \sstitem
         The intensity image may be displayed with vectors overlaid.
         Steps are taken to reduce the number of noisy or insignificant
         pixels, as well as clutter.  First, the polarisation catalogue data
         are averaged in 3-by-3-pixel bins.  Second, a binned pixel is
         rejected if its polarisation is greater than 50\% or is not positive,
         or its polarisation signal to noise less than 3, or its polarisation
         error is greater 5\%.  The bin size and thresholds can readily be
         changed by supplying arguments to the \_CALC\_STOKES\_ primitive.

         \sstitem
         At the end of each cycle, the grand mosaics are registered, and
         new polarisation maps and catalogues constructed.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames and the mosaics ({\tt\_mos} or
         {\tt\_mos\_c$<$cycle\_number$>$} suffix).
      }
   }
   \label{pe_data}
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaics in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$beam$>$$<$angle$>$\_mos},
         where {\tt$<$m$>$} the instrument's \htmlref{group prefix.}{file_prefixes}  Token {\tt$<$beam$>$} is {\tt{e}} or {\tt{o}};
         and {\tt$<$angle$>$} is {\tt{0}}, {\tt{22}}, {\tt{45}}, or {\tt{67}}.

         \sstitem
         A mosaic for each cycle of jittered frames per beam and angle in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$beam$>$$<$angle$>$\_mos\_c$<$cycle\_number$>$}, where
         {\tt$<$cycle\_number$>$} counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         Polarisation frames {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$suffix$>$}, each with a
         different suffix for the each parameter.  The suffices are:\\
         \begin{tabular}{cl}
             I &  intensity \\
             P &  percentage polarisation \\
             PI &  polarisation intensity \\
             Q  &  Stokes $Q$ \\
             TH & polarisation angle \\
             U  &  Stokes $U$ \\
         \end{tabular}

         \sstitem
         A FITS binary-table catalogue of the binned and culled
         polarisation data, called {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_I.FIT}.  For
         each point it tabulates the $x$-$y$ co-ordinates, the total intensity,
         the Stokes parameters, the percentage polarisation, the polarisation
         angle and intensity.  There are additional columns giving the
         standard deviation on each of the tabulated values (excluding the
         co-ordinates).  Likewise \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_all.FIT} and \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_bin.FIT} store the full
         and binned catalogues respectively.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern, per waveplate angle.
         If this is not set, the number of offsets, as given by FITS
         header NOFFSETS, minus one is used.  If neither is available, 3
         is the default.  An error state arises if the number of jittered
         frames is fewer than 3.  For observations prior to the
         availability of full ORAC, header NOFFSETS will be absent. {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{POL\_ANGLE\_JITTER}{POL\_ANGLE\_JITTER},
      \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL},
      \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\POLPACK}{sun223}{},
         \xref{\FIGARO}{sun86}{}, and \xref{\CURSA}{sun190}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaics.  The polarisation maps have new titles as follows
         using the suffices described in {\tt{Output Data}}.  I: {\tt{Intensity}};
         P: {\tt{Polarisation}}; PI: {\tt{Polarised Intensity}}; Q: {\tt{Stokes Q}};
         TH: {\tt{Polarisation Angle}}; U: {\tt{Stokes U}}.

         \sstitem
         The origins of the generated polarisation maps are set to [1,1].
         The WCS current frame is unchanged.

         \sstitem
         The units are set for the frames with suffices (see \htmlref{``Output Data''}{pe_data})
         {\tt{P}} to {\tt{\%}}, and {\tt{TH}} to {\tt{degrees}}.
      }
   }
}

%\newpage
\sstroutine{
   POL\_JITTER
}{
   Reduces an imaging polarimetry observation jittered at each angle
}{
   \sstdescription{
      This script reduces a polarimetry observation with UKIRT imaging
      data.  It takes an imaging observation comprising object frames
      jittered in Right Ascension at the four waveplate angles 0, 45,
      22.5, 67.5 degrees in turn; and a dark frame to make calibrated
      polarisation images and vectors automatically.  See
      \htmlref{``Output Data''}{pj_data} for a list of these images.

      It performs a null debiassing, bad-pixel masking, dark subtraction
      and flat-field division on all frames.  Next the sections of the frame
      representing the e- and o-beam target and sky regions are extracted,
      and the target frames sky-subtracted.  The resultant frames undergo
      registration and resampling to form a mosaic for each waveplate angle
      and beam.  Once all eight mosaics are formed they are registered and
      resampled, and then combined to form the various polarisation images.
      The polarisation data are binned and noisy data excluded from
      a final catalogue of vectors.  See the
      \htmlref{``Notes''}{pj_notes} for details.

      This recipe works well for point sources, and for extended sources
      whose sizes in Right Ascension and Declination are less than about
      35 and 15 arcseconds respectively for UFTI, or 9 and 4 arcseconds
      for IRCAM.  Objects which would appear in both the target and
      sky regions, \emph{{i.e.}}\ Declination extents south of the centre
      larger than 35 arcseconds (UFTI) or 8 arcseconds (IRCAM), should
      use recipe \htmlref{POL\_EXTENDED}{POL\_EXTENDED} for best results.
   }
   \label{pj_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         Data errors are propagated through all processing steps.
         The initial values are found by applying the nominal ADU conversion
         and read noise.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         You should use \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL} or
         \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE} to make the
         flat fields.

         \sstitem
         The target regions are 30\% to 70\% of the frame width about
         the Right-ascension centre, \emph{{i.e.}}\ roughly centred on the source.
         The current sky limits are 1\% to 99\% of the frame width along the
         Right-ascension axis.  The Declination pixel limits are instrument
         dependent, and are as follows.  For UFTI, o sky: 69--264;
         e sky: 320--484; o target: 601--764; e target: 824--988.  For
         IRCAM, o sky: 12--52; e sky: 67--107; o target: 152--192;
         e target: 207--247.

         \sstitem
         The sky subtraction for a beam uses a constant modal sky level
         from the corresponding sky region.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects for automatic registration, the recipe matches the centroid
         of central source within an 8-arcsecond box.  Should that fail for
         the jittered e- and o-beam sections, the recipe resorts to using the
         telescope offsets transformed to pixels.  However, the final option
         for registering the e and o-beam mosaics at different waveplate
         angles, uses the beam offsets in arcseconds for the current filter
         converted to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the few pixels in the peripheral areas
         having received less exposure time.  The mosaic is not normalised by
         its exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of twelve frames, the recipe creates mosaics
         for each beam and waveplate angle.  Each mosaic has its bad pixels
         filled and after the first cycle is then added into its own master
         mosaic of improving signal to noise.  The exposure time is also
         summed and stored in each master mosaic's corresponding
	 header.  Likewise the end airmass header and end UT headers
	 are updated to match that of the last-observed frame
	 contributing to the mosaic.

         \sstitem
         The polarised intensity is corrected for the statistical bias
         of the noise by subtracting the variance of $Q$ or $U$.

         \sstitem
         An offset of 6.3 degrees clockwise is applied to the rotation
         angle for the orientation of the analyser with respect to north.

         \sstitem
         The polarisation data for each pixel are also stored in
         catalogues.  See \htmlref{``Output Data''}{pj_data}.

         \sstitem
         The intensity image may be displayed with vectors overlaid.
         Steps are taken to reduce the number of noisy or insignificant
         pixels, as well as clutter.  First, the polarisation catalogue data
         are averaged in 3-by-3-pixel bins.  Second, a binned pixel is
         rejected if its polarisation is greater than 50\% or is not positive,
         or its polarisation signal to noise less than 3, or its polarisation
         error is greater 5\%.  The bin size and thresholds can readily be
         changed by supplying arguments to the \_CALC\_STOKES\_ primitive.

         \sstitem
         At the end of each cycle, the grand mosaics are registered, and
         new polarisation maps and catalogues constructed.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames and the mosaics ({\tt\_mos} or
         {\tt\_mos\_c$<$cycle\_number$>$} suffix).
      }
   }
   \label{pj_data}
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaics in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$beam$>$$<$angle$>$\_mos},
         where {\tt$<$m$>$} the instrument's \htmlref{group prefix.}{file_prefixes}  Token {\tt$<$beam$>$} is {\tt{e}} or {\tt{o}};
         and {\tt$<$angle$>$} is {\tt{0}}, {\tt{22}}, {\tt{45}}, or {\tt{67}}.

         \sstitem
         A mosaic for each cycle of jittered frames per beam and angle in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$beam$>$$<$angle$>$\_mos\_c$<$cycle\_number$>$}, where
         {\tt$<$cycle\_number$>$} counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         Polarisation frames {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$suffix$>$}, each with a
         different suffix for the each parameter.  The suffices are:\\
         \begin{tabular}{cl}
             I &  intensity \\
             P &  percentage polarisation \\
             PI &  polarisation intensity \\
             Q  &  Stokes $Q$ \\
             TH & polarisation angle \\
             U  &  Stokes $U$ \\
         \end{tabular}

         \sstitem
         A FITS binary-table catalogue of the binned and culled
         polarisation data, called {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_I.FIT}.  For
         each point it tabulates the $x$-$y$ co-ordinates, the total intensity,
         the Stokes parameters, the percentage polarisation, the polarisation
         angle and intensity.  There are additional columns giving the
         standard deviation on each of the tabulated values (excluding the
         co-ordinates).  Likewise \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_all.FIT} and \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_bin.FIT} store the full and
         binned catalogues respectively.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter pattern, per waveplate angle.
         If this is not set, the number of offsets, as given by FITS
         header NOFFSETS, minus one is used.  If neither is available, 3
         is the default.  An error state arises if the number of jittered
         frames is fewer than 3.  For observations prior to the
         availability of full ORAC, header NOFFSETS will be absent.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{POL\_ANGLE\_JITTER}{POL\_ANGLE\_JITTER},
      \htmlref{POL\_EXTENDED}{POL\_EXTENDED},
      \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL},\\
      \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, \xref{\POLPACK}{sun223}{},
         and \xref{\CURSA}{sun190}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaics.  The polarisation maps have new titles as follows
         using the suffices described in {\tt{Output Data}}.  I: {\tt{Intensity}};
         P: {\tt{Polarisation}}; PI: {\tt{Polarised Intensity}}; Q: {\tt{Stokes Q}};
         TH: {\tt{Polarisation Angle}}; U: {\tt{Stokes U}}.

         \sstitem
         The origins of the generated polarisation maps are set to [1,1].
         The WCS current frame is unchanged.

         \sstitem
         The units are set for the frames with suffices (see \htmlref{``Output Data''}{pj_data})
         {\tt{P}} to {\tt{\%}}, and {\tt{TH}} to {\tt{degrees}}.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      POL\_JITTER3.
   }
}

\sstroutine{
   POL\_NOD\_CHOP
}{
   Reduces a chopped and nodded polarimetry observation nodded at each
   angle
}{
   \sstdescription{
      This script reduces a chopped and nodded single-beam polarimetry
      observation, currently just for Michelle data.  The imaging
      observation should comprise a multiple-of-four object frames nodded
      and chopped, and integrated at the four waveplate angles 0, 45, 22.5,
      67.5 degrees in turn.  For each waveplate angle the recipe makes
      automatically a calibrated, untrimmed mosaic.  The recipe combines the
      multiple images of the source within each of these mosaics into new
      frames, and uses those four combined frames to calculate automatically
      calibrated polarisation images and vectors of the source.  See
      \htmlref{``Output Data''}{pnc_data} for a list of these images.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop-beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic.  See the \htmlref{``Notes''}{pnc_notes}
      for further information.
   }
   \label{pnc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each chop beam, first using the
         read noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The ARRAY\_TESTS
         recipe files a suitable short-exposure dark as a bias in the
         calibration system.

         \sstitem
         The integrations of the two chop beams are differenced, the
         first subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.  There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of frames, the recipe creates mosaics for each
         chop beam and waveplate angle (modulo 180 degrees).  Each mosaic
         has its bad pixels filled and after the first cycle is then added
         into its own master mosaic of improving signal to noise.  The
         exposure time is also summed and stored in each master mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         are updated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         For each waveplate angle, the combined source image is made by
         taking symmetrical areas about each source, such that no pixels
         are duplicated.  Thus the divisions occur at midpoints of the chop
         throw and the nod separations.  These are registered using the
         source centroids.

         \sstitem
         The polarised intensity is corrected for the statistical bias
         of the noise by subtracting the variance of $Q$ or $U$.

         \sstitem
         An offset of 0.0 degrees clockwise is applied to the rotation
         angle for the orientation of the analyser with respect to north.
         A non-null value will be applied once it is determined.

         \sstitem
         The polarisation data for each pixel are also stored in
         catalogues.  See \htmlref{``Output Data''}{pnc_data}.

         \sstitem
         The intensity image may be displayed with vectors overlaid.
         Steps are taken to reduce the number of noisy or insignificant
         pixels, as well as clutter.  First, the polarisation catalogue data
         are averaged in 3-by-3-pixel bins.  Second, a binned pixel is
         rejected if its polarisation is greater than 50\% or is not positive,
         or its polarisation signal to noise less than 3, or its polarisation
         error is greater 5\%.  The bin size and thresholds can readily be
         changed by supplying arguments to the \_CALC\_STOKES\_NOD\_CHOP\_
         primitive.

         \sstitem
         At the end of each cycle, the grand mosaics are registered, and
         new polarisation maps and catalogues constructed.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \label{pnc_data}
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaics in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_mos},
	 where {\tt$<$m$>$} is the \htmlref{group prefix}{file_prefixes}; and
	 {\tt$<$angle$>$} is {\tt{0}}, {\tt{22}}, {\tt{45}}, or {\tt{67}}.

         \sstitem
         A mosaic for each cycle of chopped and nodded frames per waveplate angle in
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_mos\_c$<$cycle\_number$>$},
         where \\
         \texttt{$<$cycle\_number$>$} counts from 0.

         \sstitem
         The combined source image and neighbourhoods at each waveplate
         angle in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_cab}.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}

         \sstitem
         Polarisation frames {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$suffix$>$},
         each with a different suffix for the each parameter.  The suffices are:\\
         \begin{tabular}{cl}
             I &  intensity \\
             P &  percentage polarisation \\
             PI &  polarisation intensity \\
             Q  &  Stokes $Q$ \\
             TH & polarisation angle \\
             U  &  Stokes $U$ \\
         \end{tabular}

         \sstitem
         A FITS binary-table catalogue of the binned and culled
         polarisation data, called {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_I.FIT}.
         For each point it tabulates the $x$-$y$ co-ordinates, the total intensity,
         the Stokes parameters, the percentage polarisation, the polarisation
         angle and intensity.  There are additional columns giving the
         standard deviation on each of the tabulated values (excluding the
         co-ordinates).  Likewise \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_all.FIT} and \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_bin.FIT} store the
         full and binned catalogues respectively.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP},
      \htmlref{POL\_QU\_FIRST\_NOD\_CHOP}{POL\_QU\_FIRST\_NOD\_CHOP},
      \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT},\\
      \htmlref{POL\_JITTER}{POL\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\POLPACK}{sun223}{},
         \xref{\FIGARO}{sun86}{}, and \xref{\CURSA}{sun190}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaics.  The polarisation maps have new titles as follows
         using the suffices described in {\tt{Output Data}}.  I: {\tt{Intensity}};
         P: {\tt{Polarisation}}; PI: {\tt{Polarised Intensity}}; Q: {\tt{Stokes Q}};
         TH: {\tt{Polarisation Angle}}; U: {\tt{Stokes U}}.

         \sstitem
         The origins of the generated polarisation maps are set to [1,1].
         The WCS current frame is unchanged.

         \sstitem
         The units are set for the frames with suffices (see \htmlref{``Output Data''}{pnc_data})
         {\tt{P}} to {\tt{\%}}, and {\tt{TH}} to {\tt{degrees}}.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   POL\_QU\_FIRST\_NOD\_CHOP
}{
   Reduces a chopped and nodded polarimetry observation, where waveplate
   angle iterates in pairs at each jitter position
}{
   \sstdescription{
      This script reduces a chopped and nodded single-beam polarimetry
      observation, currently just for Michelle data.  The imaging
      observation should comprise chopped object frames at the
      angles 0, 45 degrees for each of a multiple-of-two pairs of nod
      positions, followed by frames at waveplate angles 22.5, 67.5 degrees
      also for each of a multiple-of-two pairs of nod positions.

      For each waveplate angle the recipe makes automatically a calibrated,
      untrimmed mosaic.  The recipe combines the multiple images of the
      source within each of these mosaics into new frames, and uses those
      four combined frames to calculate automatically calibrated
      polarisation images and vectors of the source.  See
      \htmlref{``Output Data''}{pqfnc_data} for a list of these images.

      It performs a null debiassing, creation and propagation of data
      variance, difference the integrations for each AB chop-beam pair,
      bad-pixel masking, difference adjacent nodded pairs, registers the
      frames, and forms a mosaic.  See the \htmlref{``Notes''}{pqfnc_notes} for
      further information.
   }
   \label{pqfnc_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A variance array is created for each chop beam, first using the
         read noise, and once the bias is removed, Poisson noise is added.

         \sstitem
         A bias frame selected from the calibration system is removed from
         each beam in CHOP read mode.  If no bias frame is available
         in the CHOP mode, the recipe subtracts a null bias, so the errors
         will be overestimated in the CHOP read mode; the data array will
         be unaffected once the beams are differenced.  The ARRAY\_TESTS
         recipe files a suitable short-exposure dark as a bias in the
         calibration system.

         \sstitem
         The integrations of the two chop beams are differenced, the
         first subtracted from the second in each pair.

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies integer shifts of origin.   There is no
         rotation to align the Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame, thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The mosaic is not normalised by its exposure
         time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of frames, the recipe creates mosaics for each
         chop beam and waveplate angle (modulo 180 degrees).  Each mosaic
         has its bad pixels filled and after the first cycle is then added
         into its own master mosaic of improving signal to noise.  The
         exposure time is also summed and stored in each master mosaic's
         corresponding header.  Likewise the end airmass and end UT headers
         are updated to match that of the last-observed frame contributing
         to the mosaic.

         \sstitem
         For each waveplate angle, the combined source image is made by
         taking symmetrical areas about each source, such that no pixels
         are duplicated.  Thus the divisions occur at midpoints of the chop
         throw and the nod separations.  These are registered using the
         nominal chop throws and telescope offsets.

         \sstitem
         The polarised intensity is corrected for the statistical bias
         of the noise by subtracting the variance of $Q$ or $U$.

         \sstitem
         An offset of 0.0 degrees clockwise is applied to the rotation
         angle for the orientation of the analyser with respect to north.
         A non-null value will be applied once it is determined.

         \sstitem
         The polarisation data for each pixel are also stored in
         catalogues.  See \htmlref{``Output Data''}{pqfnc_data}.

         \sstitem
         The intensity image may be displayed with vectors overlaid.
         Steps are taken to reduce the number of noisy or insignificant
         pixels, as well as clutter.  First, the polarisation catalogue data
         are averaged in 3-by-3-pixel bins.  Second, a binned pixel is
         rejected if its polarisation is greater than 50\% or is not positive,
         or its polarisation signal to noise less than 3, or its polarisation
         error is greater 5\%.  The bin size and thresholds can readily be
         changed by supplying arguments to the \_CALC\_STOKES\_NOD\_CHOP\_
         primitive.

         \sstitem
         At the end of each cycle, the grand mosaics are registered, and
         new polarisation maps and catalogues constructed.

         \sstitem
         Intermediate frames are deleted except for the differenced pairs
         ({\tt\_dp} suffix) frames.
      }
   }
   \label{pqfnc_data}
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaics in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_mos},
	 where {\tt$<$m$>$} is the instrument's \htmlref{group prefix}{file_prefixes}; and
	 {\tt$<$angle$>$} is {\tt{0}}, {\tt{22}}, {\tt{45}}, or {\tt{67}}.

         \sstitem
         A mosaic for each cycle of chopped and nodded frames per waveplate angle in
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_mos\_c$<$cycle\_number$>$},
         where \\
         \texttt{$<$cycle\_number$>$} counts from 0.

         \sstitem
         The combined source image and neighbourhoods at each waveplate
         angle in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_p$<$angle$>$\_cab}.

         \sstitem
         The differenced pairs in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_dp},
         where {\tt$<$i$>$} is the \htmlref{frame prefix.}{file_prefixes}

         \sstitem
         Polarisation frames {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_$<$suffix$>$},
         each with a different suffix for the each parameter.  The suffices are:\\
         \begin{tabular}{cl}
             I &  intensity \\
             P &  percentage polarisation \\
             PI &  polarisation intensity \\
             Q  &  Stokes $Q$ \\
             TH & polarisation angle \\
             U  &  Stokes $U$ \\
         \end{tabular}

         \sstitem
         A FITS binary-table catalogue of the binned and culled
         polarisation data, called {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_I.FIT}.
         For each point it tabulates the $x$-$y$ co-ordinates, the total intensity,
         the Stokes parameters, the percentage polarisation, the polarisation
         angle and intensity.  There are additional columns giving the
         standard deviation on each of the tabulated values (excluding the
         co-ordinates).  Likewise \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_all.FIT} and \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_bin.FIT} store the
         full and binned catalogues respectively.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the nod pattern.  If absent, the number
         of offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 4 is used.  An error state arises if
         the number of jittered frames is fewer than 4 and not a
         multiple of 4.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays.  {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{POL\_NOD\_CHOP}{POL\_NOD\_CHOP},
      \htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP},
      \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\POLPACK}{sun223}{},
         \xref{\FIGARO}{sun86}{}, and \xref{\CURSA}{sun190}{}.

         \sstitem
         Uses the Starlink NDF format and multi-NDF HDS container files.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaics.  The polarisation maps have new titles as follows
         using the suffices described in {\tt{Output Data}}.  I: {\tt{Intensity}};
         P: {\tt{Polarisation}}; PI: {\tt{Polarised Intensity}}; Q: {\tt{Stokes Q}};
         TH: {\tt{Polarisation Angle}}; U: {\tt{Stokes U}}.

         \sstitem
         The origins of the generated polarisation maps are set to [1,1].
         The WCS current frame is unchanged.

         \sstitem
         The units are set for the frames with suffices (see \htmlref{``Output Data''}{pqfnc_data})
         {\tt{P}} to {\tt{\%}}, and {\tt{TH}} to {\tt{degrees}}.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}


%\newpage
\sstroutine{
   QUADRANT\_JITTER
}{
   Reduces a ``Quadrant Jitter'' observation, including object masking
}{
   \sstdescription{
      This script reduces a ``quadrant jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation comprising
      one or more series of four object frames where the target is
      approximately centred in each quadrant; and a dark frame to make
      a calibrated, untrimmed mosaic automatically.

      It performs bad-pixel masking, null debiassing, dark subtraction,
      flat-field creation and division, feature detection and matching
      between object frames, and resampling.   See the
      \htmlref{``Notes''}{qj_notes} for further information.

      This recipe is suitable for faint objects or objects within
      a comparatively bright core embedded in faint extended emission,
      \emph{e.g.}\ a quasar; or extended objects less than 45 arcseconds across
      with UFTI, 10 arcseconds with IRCAM, and 2 arcminutes with IRIS2.
      The object need not be
      isolated, as the recipe masks objects within the other quadrants,
      and hence does not introduce significant artifacts into the flat
      field.  For isolated objects use \htmlref{QUADRANT\_JITTER\_NO\_MASK}{QUADRANT\_JITTER\_NO\_MASK}; or where
      speed is critical, use \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC} instead.
   }
   \label{qj_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First the quadrant
         containing the object is masked in each object frame.  Second an
         approximate flat field is created by combining the normalised
         and masked object frames using the clipped median at each pixel.
         This flat field is applied to the object frames.  Sources within
         the flat-fielded frames are detected, and masked in the
         dark-subtracted frames.  The second stage is repeated but applied
         to the masked frames to create the final flat field.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, it matches the centroid of the central source.  If this
         fails, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame.  Thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The full signal will be in the central ninth
         containing the main object.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of four, the recipe creates a mosaic, which has
         its bad pixels filled and is then added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of four in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC},
      \htmlref{QUADRANT\_JITTER\_NO\_MASK}{QUADRANT\_JITTER\_NO\_MASK},
      \htmlref{EXTENDED\_3x3}{EXTENDED\_3x3},\\
      \htmlref{EXTENDED\_5x5}{EXTENDED\_5x5}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   QUADRANT\_JITTER\_BASIC
}{
   Reduces a ``Quadrant Jitter'' observation, using just the basic
   operations for speed
}{
   \sstdescription{
      This script reduces a ``quadrant jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation comprising
      one or more series of four object frames where the target is
      approximately centred in each quadrant; and a dark frame to make
      a calibrated, untrimmed mosaic automatically.

      It performs bad-pixel masking, null debiassing, dark subtraction,
      flat-field creation and division, and registration using telescope
      offsets.  See the \htmlref{``Notes''}{qjb_notes} for further information.

      This recipe aims to keep pace with the pipeline's incoming
      data and many options which improve the final mosaic are omitted.
      This recipe is suitable for faint objects or objects within
      a comparatively bright core embedded in faint extended emission,
      \emph{e.g.}\ a quasar; or extended objects less than 45 arcseconds across
      with UFTI, 10 arcseconds with IRCAM, and 2 arcminutes with IRIS2.
      If the object is not
      isolated, there will be artifacts introduced into the flat field.
      These arise from the contribution of sources outside the quadrant
      containing the primary object.  This variant of
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER} is
      best for isolated objects or where speed is critical.  Use
      QUADRANT\_JITTER itself if object masking is required instead.
   }
   \label{qjb_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created in two steps.  The quadrant
         containing the object is masked in each object frame.  Then the
         recipe combines the normalised and quadrant-masked object frames
         using the median at each pixel.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         There is no resampling, merely integer shifts of origin.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame.  Thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The full signal will be in the central ninth
         containing the main object.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of four, the recipe creates a mosaic, which is
         added into a master mosaic of improving signal to noise.  The
         exposure time is also summed and stored in the mosaic's
	 corresponding header.  Likewise the end airmass header and
	 end UT headers are updated to match that of the last-observed
	 frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of four in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER},
      \htmlref{QUADRANT\_JITTER\_NO\_MASK}{QUADRANT\_JITTER\_NO\_MASK},
      \htmlref{EXTENDED\_3x3\_BASIC}{EXTENDED\_3x3\_BASIC},\\
      \htmlref{EXTENDED\_5x5\_BASIC}{EXTENDED\_5x5\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   QUADRANT\_JITTER\_NO\_MASK
}{
   Reduces a ``Quadrant Jitter'' observation without object masking
}{
   \sstdescription{
      This script reduces a ``quadrant jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation comprising
      one or more series of four object frames where the target is
      approximately centred in each quadrant; and a dark frame to make
      a calibrated, untrimmed mosaic automatically.

      It performs bad-pixel masking, null debiassing, dark subtraction,
      flat-field creation and division, feature detection and matching
      between object frames, and resampling.   See the
      \htmlref{``Notes''}{qjnm_notes} for further information.

      This recipe is suitable for faint objects or objects within
      a comparatively bright core embedded in faint extended emission,
      \emph{e.g.}\ a quasar; or extended objects less than 45 arcseconds across
      with UFTI, 10 arcseconds with IRCAM, and 2 arcminutes with IRIS2.
      If there are other objects
      of comparable brightness to the principal target in other quadrants,
      they will introduce artifacts into the flat field.  Use
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER} for those.
   }
   \label{qjnm_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created in two steps.  The quadrant
         containing the object is masked in each object frame.  Then the
         recipe combines the normalised and quadrant-masked object frames
         using the median at each pixel.

         \sstitem
         Registration is performed using common point sources in the
         overlap regions.  If the recipe cannot identify sufficient common
         objects, it matches the centroid of the central source.  If this
         fails, the script resorts to using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame.  Thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The full signal will be in the central ninth
         containing the main object.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of four, the recipe creates a mosaic, which has
         its bad pixels filled and is then added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of four in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER},
      \htmlref{QUADRANT\_JITTER\_BASIC}{QUADRANT\_JITTER\_BASIC},
      \htmlref{EXTENDED\_3x3\_BASIC}{EXTENDED\_3x3\_BASIC},\\
      \htmlref{EXTENDED\_5x5\_BASIC}{EXTENDED\_5x5\_BASIC}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   QUADRANT\_JITTER\_TELE
}{
   Reduces a ``Quadrant Jitter'' observation, using object masking,
   and telescope offsets for registration
}{
   \sstdescription{
      This script reduces a ``quadrant jitter'' photometry observation
      with near-infrared imaging data.  It takes an imaging observation comprising
      one or more series of four object frames where the target is
      approximately centred in each quadrant; and a dark frame to make
      a calibrated, untrimmed mosaic automatically.

      It performs bad-pixel masking, null debiassing, dark subtraction,
      flat-field creation and division, registration using telescope
      offsets, and resampling.  See the \htmlref{``Notes''}{qjt_notes}
      for further information.

      This recipe is intended for extended moving sources (comets)
      tracked by the telescope.  The source extent should not exceed 45
      arcseconds for UFTI or 10 arcseconds for IRCAM, in moderately
      crowded fields.  Sources may include those with a comparatively
      bright core embedded in faint extended emission.  The object need
      not be isolated, as the recipe masks objects within the other
      quadrants, and hence does not introduce significant artifacts into
      the flat field.  This recipe should not be used for frames where
      the telescope has not guided on the moving object.  In that case
      reduction should be performed by
      \htmlref{MOVING\_QUADRANT\_JITTER}{MOVING\_QUADRANT\_JITTER}, which
      registers using the telescope offsets alone.
   }
   \label{qjt_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range -100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First the quadrant
         containing the object is masked in each object frame.  Second an
         approximate flat field is created by combining the normalised
         and masked object frames using the clipped median at each pixel.
         This flat field is applied to the object frames.  Sources within
         the flat-fielded frames are detected, and masked in the
         dark-subtracted frames.  The second stage is repeated but applied
         to the masked frames to create the final flat field.

         \sstitem
         Registration is performed using the telescope offsets
         transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaics by applying offsets in intensity
         to give the most consistent result amongst the overlapping regions.
         The mosaic is not trimmed to the dimensions of a single frame.  Thus
         the noise will be greater in the peripheral areas having received
         less exposure time.  The full signal will be in the central ninth
         containing the main object.  The mosaic is not normalised by its
         exposure time (that being the exposure time of a single frame).

         \sstitem
         For each cycle of four, the recipe creates a mosaic, which has
         its bad pixels filled and is then added into a master mosaic of
         improving signal to noise.  The exposure time is also summed and
         stored in the mosaic's corresponding header.  Likewise the end
         airmass header and end UT headers are updated to match that of
         the last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The integrated mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         A mosaic for each cycle of four in \\
         {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos$<$cycle\_number$>$}, where {\tt$<$cycle\_number$>$}\\
         counts from 0.

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent cycles.

      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT\_TELE}{JITTER\_SELF\_FLAT\_TELE},
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT},\\
      \htmlref{MOVING\_QUADRANT\_JITTER}{MOVING\_QUADRANT\_JITTER},
      \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is not used.
      }
   }
}

%\newpage
\sstroutine{
   REDUCE\_DARK
}{
   Averages and files observations as the current dark
}{
   \sstdescription{
      This recipe reduces dark-frame observations with infrared imaging
      data.  Multiple darks of the same exposure time are averaged.  It
      files the single or averaged dark in the dark index file.  Other
      reduction steps comprise bad-pixel masking, optional creation of
      data errors.

            This recipe reduces a dark-frame observation with infrared imaging
      data.  It files the dark in the dark index file.  Reduction
      comprises bad-pixel masking, and optional creation of data errors.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The dark called {\tt{dark\_$<$exposure\_time$>$\_$<$frame\_number$>$}}.
         For single frames the group number is the same as the frame number.
         The decimal point in the time is replaced by {\tt{p}}.

         \sstitem
         The dark is filed in {\tt\$ORAC\_DATA\_OUT/index.dark}.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink package \xref{\KAPPA}{sun95}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the dark.
      }
   }
}

\sstroutine{
   REDUCE\_FLAT
}{
   Reduces an imaging flat field
}{
   \sstdescription{
      This reduces a flat field in the conventional manner consisting of
      bad-pixel masking, dark subtraction, and normalisation by the
      mean of the image.  It also files the normalised flat-field frame
      for use by subsequent flat-fielding operations.
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         This recipe will reduce any image passed to it.  Care must
         be taken to ensure that a proper flat-field image will be reduced.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         The flat field is normalised using a clipped mean, where
         the clipping levels are 2, 3, and 3 standard deviationss.  This
         value is effectively the mode of the image.  The entire image is
         divided by this value to normalise it.

         \sstitem
         Intermediate frames are deleted.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The flat is called \texttt{flat\_$<$frame\_number$>$}.

         \sstitem
         The flat is filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages
         \xref{\KAPPA}{sun95}{} and \xref{\CCDPACK}{sun139}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Variance information is not supported.
      }
   }
}

%\newpage
\sstroutine{
   SKY\_AND\_JITTER
}{
   Reduces a ``combined jitter'' photometry observation
}{
   \sstdescription{
      This script reduces a ``combined jitter'' photometry observation
      with UKIRT imaging data.  It takes an imaging observation
      comprising one or more sets of frames, each set containing a sky
      frame, followed by jittered object frames; and a pre-determined
      flat-field frame to make a calibrated, trimmed mosaic automatically.

      This recipe performs bad-pixel masking, null debiassing, sky
      subtraction, flat-field division, feature detection and matching
      between object frames, and resampling.  See the
      \htmlref{``Notes''}{saj_notes} for details.

      This recipe is suitable for moderately faint point sources.
   }
   \label{saj_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or
         \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The most-recent sky frame is used for the sky subtraction.

         \sstitem
         Where automatic registration is not possible, the recipe matches
         the centroid of central source, and should that fail, it resorts
         to using the telescope offsets transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the
	 mosaic's corresponding header.  Likewise the end airmass
	 header and end UT headers are updated to match that of the
	 last-observed frame contributing to the mosaic.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter, excluding the sky frame.
         If absent, the number of offsets, as given by header NOFFSETS,
         minus two is used.  If neither is available, 5 is used.  An
         error state arises if the number of jittered frames is fewer
         than 3.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK},
      \htmlref{SKY\_AND\_JITTER\_APHOT}{SKY\_AND\_JITTER\_APHOT},\\
      \htmlref{SKY\_FLAT}{SKY\_FLAT},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      SKY\_AND\_JITTER5.
   }
}

%\newpage
\sstroutine{
   SKY\_AND\_JITTER\_APHOT
}{
   Reduces a ``combined jitter'' photometry observation, and
   performs aperture photometry
}{
   \sstdescription{
      This script reduces a ``combined jitter'' photometry observation
      with UKIRT imaging data.  It takes an imaging observation
      comprising one or more sets of frames, each set containing a sky
      frame, followed by jittered object frames; and a pre-determined
      flat-field frame to make a calibrated, trimmed mosaic automatically.

      This recipe performs bad-pixel masking, null debiassing, sky
      subtraction, flat-field division, feature detection and matching
      between object frames, and resampling.  See the
      \htmlref{``Notes''}{saja_notes} for details.

      Photometry of the point source using a fixed 5-arcsecond aperture
      is calculated for each jitter frame and the mosaic.  The results
      appear in {\tt\$ORAC\_DATA\_OUT/aphot\_results.txt} in the form of a Starlink
      small text list.  The analysis of each star is appended to this file.

      This recipe is suitable for moderately faint point sources.
   }
   \label{saja_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         You may use \htmlref{SKY\_FLAT}{SKY\_FLAT} or \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED} to make the flat field.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The most-recent sky frame is used for the sky subtraction.

         \sstitem
         Where automatic registration is not possible, the recipe matches
         the centroid of central source, and should that fail, it resorts
         to using the telescope offsets transformed to pixels.

         \sstitem
         The resampling applies non-integer shifts of origin using
         bilinear interpolation.  There is no rotation to align the
         Cartesian axes with the cardinal directions.

         \sstitem
         The recipe makes the mosaic by applying offsets in intensity to
         give the most consistent result amongst the overlapping regions.
         The mosaic is trimmed to the dimensions of an input frame.  The
         mosaic is not normalised by its exposure time (that being the
         exposure time of a single frame).

         \sstitem
         For each cycle of jittered frames, the recipe creates a mosaic,
         which is then added into a master mosaic of improving signal to
         noise.  The exposure time is also summed and stored in the
	 mosaic's corresponding header.  Likewise the end airmass
	 header and end UT headers are updated to match that of the
	 last-observed frame contributing to the mosaic.

         \sstitem
         The photometry tabulation includes the file name, source
         name, time, filter, airmass, the catalogue magnitude and
         estimates of the zero-point with and without the application
         of a mean extinction.  There are headings at the top of each
         column.

         \sstitem
         The photometry uses the mode calculated from
         \mbox{3 $\lsk$ median $-$ 2 $\lsk$ mean} and Chauvenet's
         rejection criterion to estimate the sky level in an annulus
         about the source.  The inner annulus diameter is 1.3 times
         that of the aperture (6.5 arcsec); the outer annulus is 2.5
         times (12.5 arcsec) for UFTI and twice the aperture (10 arcsec)
         for IRCAM. The errors are internal, based on the sky noise.

         \sstitem
         Intermediate frames are deleted except for the flat-fielded ({\tt\_ff}
         suffix) frames.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The resultant mosaic in {\tt$<$m$>$$<$date$>$\_$<$group\_number$>$\_mos}, where {\tt$<$m$>$}
         is the instrument's \htmlref{group prefix.}{file_prefixes}

         \sstitem
         The individual flat-fielded frames in {\tt$<$i$>$$<$date$>$\_$<$obs\_number$>$\_ff},
         where {\tt$<$i$>$} is \htmlref{the frame prefix.}{file_prefixes}  The
         \htmlref{naming format}{file_prefixes} is slightly different for some non-UKIRT
         instruments.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter, excluding the sky frame.
         If absent, the number of offsets, as given by header NOFFSETS,
         minus two is used.  If neither is available, 5 is used.  An
         error state arises if the number of jittered frames is fewer
         than 3.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT},\\
      \htmlref{SKY\_AND\_JITTER}{SKY\_AND\_JITTER},
      \htmlref{SKY\_FLAT}{SKY\_FLAT}, \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages: \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, AND \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through intermediate files
         to the mosaic.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
   \sstdiytopic{
      Deprecated Variants
   }{
      SKY\_AND\_JITTER5\_APHOT.
   }
}

%\newpage
\sstroutine{
   SKY\_FLAT
}{
   Creates and files a flat field derived from jittered frames
}{
   \sstdescription{
      This recipe makes a sky flat for UKIRT imaging from a series of sky
      or object frames which are combined using one of a selection of
      statistics.  It expects one dark frame followed by jittered sky frames.

      It performs a null debiassing, bad-pixel masking, and dark subtraction
      before combining normalised frames pixel by pixel using the median.
      Details of the flat are filed in the index of flats for future
      selection and use of the flat.  See the
      \htmlref{``Notes''}{sf_notes} for further details.

      For best results the field observed should contain few stars and no
      bright ones.  In contaminated sky regions, recipe \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED} will
      greatly reduce artifacts appearing in the resultant flat.
   }
   \label{sf_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent recipe cycles.  Token {\tt$<$filter$>$} is the filter name,
         {\tt$<$group\_number$>$} is the frame number of the group, and {\tt$<$cycle\_number$>$}
         is the number of the cycle, counting from one.

         \sstitem
         The flats are filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter.  If absent, the number of
         offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 5 is used.  An error state arises if
         the number of jittered frames is fewer than 3.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED},
      \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, and \xref{\FIGARO}{sun86}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   SKY\_FLAT\_FP
}{
   Creates and files a flat field derived from multiples of four frames using
   object masking to reduce artifacts
}{
   \sstdescription{
      This recipe make a sky flat for UFTI from a series of four
      (or multiples of four) sky or object frames combined using one of a
      selection of statistics.  It is intended to be used to make a flat for
      Fabry-Perot data.

      It performs a null debiassing, bad-pixel and non-signal region masking,
      and dark subtraction before combining the sky frames pixel by pixel
      to make the flat.  See the \htmlref{``Notes''}{sff_notes} for
      further details.  The parameters of the flat are filed in the
      index of flats for future selection and use of the flat.

      For best results the field observed should contain few stars and no
      bright ones.
   }
   \label{sff_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         Applies a mask about the Fabry-Perot's transmitted circular
         region on the detector.  If the centre is not known through the
         fpcentre calibration, it is determined using profiles of the
         surrounding ring.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat field is created by combining normalised sky frames using
         the median at each pixel.  This flat field is applied to the sky
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The created flat field in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent recipe cycles.  Token {\tt$<$filter$>$} is the filter name,
         {\tt$<$group\_number$>$} is the frame number of the group, and {\tt$<$cycle\_number$>$}
         is the number of the cycle, counting from one.

         \sstitem
         The flats are filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT}{SKY\_FLAT},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   SKY\_FLAT\_MASKED
}{
   Creates and files a flat field derived from jittered frames using
   object masking to reduce artifacts
}{
   \sstdescription{
      This recipe makes a sky flat for UKIRT imaging from a series of sky
      or object frames which are combined using one of a selection of
      statistics.  It expects one dark frame followed by jittered sky frames.

      It performs a null debiassing, bad-pixel masking, and dark
      subtraction before combining the sky frames pixel by pixel to
      make the flat.  See the \htmlref{``Notes''}{sfm_notes} for
      further details.  The parameters of the flat are filed in the
      index of flats for future selection and use of the flat.

      For best results the field observed should contain few stars and no
      bright ones.  In sparse fields, recipe \htmlref{SKY\_FLAT}{SKY\_FLAT} is a faster alternative.
   }
   \label{sfm_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised sky frames using
         the median at each pixel.  This flat field is applied to the sky
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The created flat fields in {\tt{flat\_$<$filter$>$\_$<$group\_number$>$}} for the
         first or only cycle, and {\tt{{\tt{flat\_$<$filter$>$\_$<$group\_number$>$}}\_c$<$cycle\_number$>$}}
         for subsequent recipe cycles.  Token {\tt$<$filter$>$} is the filter name,
         {\tt$<$group\_number$>$} is the frame number of the group, and {\tt$<$cycle\_number$>$}
         is the number of the cycle, counting from one.

         \sstitem
         The flats are filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstparameters{
      \sstsubsection{
         NUMBER = INTEGER
      }{
         The number of frames in the jitter.  If absent, the number of
         offsets, as given by header NOFFSETS, minus one is used.  If
         neither is available, 5 is used.  An error state arises if
         the number of jittered frames is fewer than 3.  {\tt[]}
      }
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[0]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT}{SKY\_FLAT}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   SKY\_FLAT\_POL
}{
   Creates and files a flat field derived from eight frames using
   object masking to reduce artifacts
}{
   \sstdescription{
      This recipe make a sky flat for UKIRT imaging from a series of
      eight sky or object frames combined using one of a selection of
      statistics.  It is intended to be used to make a flat for
      polarimetry data.  The data should comprise two spatial positions
      at the waveplate angles 0, 45, 22.5, and 67.5 degrees.

      It performs a null debiassing, bad-pixel masking, and dark
      subtraction before combining the sky frames pixel by pixel to to
      make the flat.  See the \htmlref{``Notes''}{sfp_notes} for
      further details.  The parameters of the flat are filed in the
      index of flats for future selection and use of the flat.

      For best results the field observed should contain few stars and
      no bright ones.
   }
   \label{sfp_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat-field is created by combining normalised sky frames using
         the median at each pixel.  This flat field is applied to the sky
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         There are flats for each waveplate angle and also for 90 and 135
         degrees, made by copying the original flat frame.  This is to permit
         both flats made at each angle (\htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE}),
         or with the angles combined as here.  Each flat is called
         {\tt{flat\_$<$filter$>$\_pol$<$waveplate\_angle$>$\_}\-{\tt$<$group\_number$>$}}. The \\
         {\tt$<$waveplate\_angle$>$} is the integer part of the angle, \emph{e.g.}\ 22,
         67; where {\tt$<$filter$>$} is the filter name (excluding the {\tt{+pol}}),
         and {\tt$<$group\_number$>$} is the frame number of the group.  For each
         subsequent cycle of the recipe, the recipe makes new flats
         which have a {\tt\_c$<$cycle\_number$>$} suffix, where {\tt$<$cycle\_number$>$} is
         the number of the cycle, counting from one.

         \sstitem
         The flats are filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstparameters{
      \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED},
      \htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\EXTRACTOR}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

%\newpage
\sstroutine{
   SKY\_FLAT\_POL\_ANGLE
}{
   Creates and files flat fields derived from jittered frames
   at each waveplate angle, using object masking to reduce artifacts
}{
   \sstdescription{
      This recipe make a sky flat for UKIRT imaging from a series of
      sky or object frames combined using one of a selection of
      statistics.  It is intended to be used to make flats at each
      waveplate angle for polarimetry data.  The data should
      comprise at least three spatial positions for each waveplate
      angle 0, 45, 22.5, and 67.5 degrees in turn.

      It performs a null debiassing, bad-pixel masking, and dark
      subtraction before combining the sky frames pixel by pixel to to
      make the flat.  See the \htmlref{``Notes''}{sfpa_notes} for
      further details.  The parameters of the flat are filed in the
      index of flats for future selection and use of the flat.

      For best results the field observed should contain few stars and
      no bright ones.
   }
   \label{sfpa_notes}
   \sstnotes{
      \sstitemlist{

         \sstitem
         A World Co-ordinate System (WCS) using the AIPS convention is
         created in the headers should no WCS already exist.

         \sstitem
         For IRCAM, old headers are reordered and structured with
         headings before groups of related keywords.  The comments have
         units added or appear in a standard format.  Four deprecated
         headers are removed.  FITS-violating headers are corrected.
         Spurious instrument names are changed to IRCAM3.

         \sstitem
         The bad-pixel mask applied is {\tt\$ORAC\_DATA\_CAL/bpm}.

         \sstitem
         Each dark-subtracted frame has thresholds applied beyond which
         pixels are flagged as bad.  The lower limit is 5 standard
         deviations below the mode, but constrained to the range $-$100 to 1.
         The upper limit is 1000 above the saturation limit for the detector
         in the mode used.

         \sstitem
         The flat field is created iteratively.  First an approximate
         flat field is created by combining normalised sky frames using
         the median at each pixel.  This flat field is applied to the sky
         frames.  Sources within the flat-fielded frames are detected, and
         masked in the dark-subtracted frames.  The first stage is repeated
         but applied to the masked frames to create the final flat field.

         \sstitem
         Intermediate frames are deleted.

         \sstitem
         Sub-arrays are supported.
      }
   }
   \sstdiytopic{
      Output Data
   }{
      \sstitemlist{

         \sstitem
         The flats are called {\tt{flat\_$<$filter$>$\_pol$<$waveplate\_angle$>$\_$<$group\_number$>$}},
         The {\tt$<$waveplate\_angle$>$} is the integer part of the angle, \emph{e.g.}\ 22, 67;
         {\tt$<$filter$>$} is the filter name (excluding any {\tt{+pol}}); and {\tt$<$group\_number$>$}
         is the frame number of the group.  For each subsequent cycle of the
         recipe, the recipe makes new flats which have a {\tt\_c$<$cycle\_number$>$}
         suffix, where {\tt$<$cycle\_number$>$} is the number of the cycle, counting
         from one.

         \sstitem
         The flats are filed in {\tt\$ORAC\_DATA\_OUT/index.flat}.
      }
   }
   \sstparameters{
         \sstsubsection{
         USEVAR = LOGICAL
      }{
         Whether or not to create and propagate variance arrays. {\tt[1]}
      }
   }
   \sstdiytopic{
      Related Recipes
   }{
      \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP},
      \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED},
      \htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL}.
   }
   \sstimplementationstatus{
      \sstitemlist{

         \sstitem
         The processing engines are from the Starlink packages \xref{\CCDPACK}{sun139}{},
         \xref{\KAPPA}{sun95}{}, \xref{\FIGARO}{sun86}{}, and \xref{\FIGARO}{sun226}{}.

         \sstitem
         Uses the Starlink NDF format.

         \sstitem
         History is recorded within the data files.

         \sstitem
         The title of the data is propagated through the intermediate file
         to the flat.

         \sstitem
         Error propagation is controlled by the USEVAR parameter.
      }
   }
}

\newpage
\section{\xlabel{instrument_recipe_notes}Instrument Recipe
Notes\label{instrument_recipe_notes}}

This appendix summarises the modifications of instrument-specific
variants of the recipes, and the restricted availability of certain
recipes by instrument.

\subsection{\ClassicCam}
There is no recipe name in the headers, therefore recipes must be
supplied on the command line or the data's \htmlref{FITS headers
edited}{correcting_headers}.
\begin{latexonly}
See Section~\ref{correcting_headers} for instructions.
\end{latexonly}

Actual testing has been performed on the core recipes
JITTER\_SELF\_FLAT(\_APHOT), \\
BRIGHT\_POINT\_SOURCE(\_APHOT), REDUCE\_DARK.  Other near infra-red
plain-imaging recipes should work provided the observation pattern
matches that expected by the recipe.

Aperture photometry accesses the Persson HST lists.

\subsection{\INGRID}
By default the infrastructure uses information in the headers to
assign recipe names to \htmlref{REDUCE\_DARK}{REDUCE\_DARK} for a
dark, and \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} for
jittered target frames.  Otherwise it defaults to QUICK\_LOOK. Other
recipes supplied on the \xref{\textbf{oracdr}}{sun230}{oracdr} command
line should work provided the observation pattern matches that
expected by the recipe.

\subsection{\IRCAM}
\htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} uses eight frames and derives both
the STARE and ND\_STARE readout noises, which are both filed with the
calibration system.  The range of acceptable dark current is 0--10
electrons/sec compared with $-$1--$+$1 for \UFTI, and the nominal
ND\_STARE readout noise is 20--50 electrons compared with 8--30 electrons
for UFTI.  The STARE mode readout noise should be 30--70 electrons to
be nominal.  The log file goes to
{\tt\$ORAC\_DATA\_OUT/ircam3\_array\_tests.log}.

\subsection{\IRIS}
The four \htmlref{EXTENDED\_$n\times$$m$}{EXTENDED\_5x5} recipes cope
with missing offset information and a lower completeness (0.25 from
0.4) for automatic registration, thus a smaller fraction of detected
objects need match.

\htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} logs to a different location
\texttt{/inst2\_soft/iris2red/logs/array\_tests.log} at the AAT compared
with UFTI at UKIRT.  References to NDSTARE are not applicable, and so
are absent from the documentation. The observation mode is DRM.  The
upper limit on the readout noise is 20 electrons compared with 30
electrons for UFTI.

There are JITTER\_SELF\_FLAT variants with a higher registration
completeness (0.5 from 0.4) giving purer registration but may rely on
the telescope offsets more often.

For a full list of available recipes see the \htmladdnormallink{IRIS2
web page}{http://www.aao.gov.au/iris2/iris2_seq.html}.

\subsection{\xlabel{isaac_recipe_notes}\ISAAC\label{isaac_recipe_notes}}
The observation template and sequence names are converted into
matching recipes with a default of QUICK\_LOOK.  Available are:
\htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER},
\htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT},
\htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT},
\htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK},
\htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_\-APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT},
\htmlref{POL\_JITTER}{POL\_JITTER},
\htmlref{REDUCE\_DARK}{REDUCE\_DARK}, and
\htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}.
Please note that at the time of writing the thermal recipes have yet
to be tested with ISAAC data.  Polarimetry is not available yet.  Other
recipes supplied on the \textbf{oracdr} command line should work provided
the observation pattern matches that expected by the recipe.

The CHOP\_SKY\_JITTER recipe has no leading sky frame, so the recipe
subtracts the mode of the first sky frame from the first target frame,
rather than interpolating between the bracketting sky frames as occurs
in the standard version.  The sequence of frames can also end on the
source.

The spatial distortion correction in the core jitter recipes
uses the ATOOLS package in addition to those engines listed in the
generic documentation.

Aperture photometry accesses both the UKIRT Faint-standard and Persson
HST lists.

\subsection{\Michelle}
\htmlref{DIFFERENCE\_STATS}{DIFFERENCE\_STATS},
\htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP},
\htmlref{POL\_QU\_FIRST\_NOD\_CHOP}{POL\_QU\_FIRST\_NOD\_CHOP}, and \\
\htmlref{POL\_NOD\_CHOP}{POL\_NOD\_CHOP} only apply to Michelle.

\htmlref{ARRAY\_TESTS}{ARRAY\_TESTS} calculates and files both an average
bias frame and the read noise in the calibration system.  There is no logging.
Checks are made that appropriate waveforms are selected.

\subsection{\NACO}
The scope of the recipes is similar to that for \htmlref{ISAAC}{isaac_recipe_notes}.
No attempt has been made to reduce any coronographic data with the
standard recipes.

Registration is critical for such small point-spread functions to
match well.  Therefore the minimum number of contiguous pixels above
the threshold to be counted as a fiducial source for automatic
registration is increased from 9 to 15, and the percentile detection
threshold raised from 98\% to 99\%.  These may need further adjustment
as a wider selection of observations are processed.  The sky
co-ordinates are used to aid registration by default.

Aperture photometry accesses both the UKIRT Faint-standard and Persson
HST lists.

\subsection{\NIRI}
Tests with 2004 data are limited to thermal data and
\htmlref{REDUCE\_DARK}{REDUCE\_DARK} recipes.

The prelminaries fudge the WCS headers to give a consistent set


A 3-arcsecond aperture is used by default for the thermal imaging
aperture photometry.

\subsection{\UFTI}
The \htmlref{FP}{FP} family of recipes only applies to UFTI.

The \htmlref{sky counts are validated}{preliminaries} as part of the
initial processing.

\subsection{\UIST}
There is no ARRAY\_TESTS recipe.  Instead there are
\htmlref{DARK\_AND\_BPM}{DARK\_AND\_BPM} and \\
\htmlref{MEASURE\_READNOISE}{MEASURE\_READNOISE}.

There are JITTER\_SELF\_FLAT variants with a higher registration
completeness (0.5 from 0.4) giving purer registration but may rely on
the telescope offsets more often.

Measurement of the full-array statistics avoids the outer 5\% border,
in order to avoid aberrant pixels which can still bias the clipped
mean.

Raw polarimetric data are flipped along the second axis to counter a
bug in \xref{\POLPACK}{sun223}{} computing vector orientations for
left-handed co-ordinates.

\newpage
\section{\xlabel{internal_headers}Internal Headers\label{internal_headers}}

\subsection{\xlabel{translated_headers}Translated Headers\label{translated_headers}}

The \ORACDR\ infrastructure translates instrument metadata stored in
FITS headers into internal headers.  An internal header offers a
common name, meaning, and units independent of the instrument, thereby
makes most recipe code portable between instruments, and increases
code reuse, a major theme of \ORACDR.  The internal headers are
accessed through the \texttt{ORAC::Frame::uhdr()} and \texttt{ORAC::Group::uhdr()} methods (see \xref{Frame headers in SUN/233}{sun233}{}).

Below is a list of these translated internal headers and their
meanings and units.  Here are some notes pertaining to the table.

\begin{itemize}
\item In a primitive these header names have an \texttt{ORAC\_} prefix,
for example, ORAC\_DEC\_SCALE.
\item The abbreviations for data type are B: boolean,
F: floating point, I: integer, and S: string.  Of the floating point
only the RA\_BASE and DEC\_BASE warrant double precision, but the
recipes impose no restriction.
\item Units are in brackets.
\item Some headers retain instrument-specific values, like ORAC\_SPEED
until a common set of instrument-independent names is compiled.
\end{itemize}

\begin{center}
\begin{tabular}{lcp{80mm}}
Name                 & Type &  Meaning \\ \hline
AIRMASS\_START          & F &  Airmass at the start of the observation \\
AIRMASS\_END            & F &  Airmass at the end of the observation \\
DEC\_BASE               & F &  Declination (J2000) at reference position
                               (and offset 0,0) [deg] \\
DEC\_SCALE              & F &  Pixel scale along declination axis [arcsec] \\
DEC\_TELESCOPE\_OFFSET  & F &  Telescope declination offset with respect to
                               the DEC\_BASE position [arcsec] \\
DETECTOR\_BIAS          & F &  Detector bias (only used by IRCAM) [V] \\
DETECTOR\_MODE          & S &  Such as STARE, NDSTARE, CHOP \\
EQUINOX                 & F &  Equinox of co-ordinates (fix at 2000.0) [y] \\
EXPOSURE\_TIME          & F &  Exposure time for each co-add [s] \\
FILTER                  & S &  Filter name \\
GAIN                    & F &  Conversion factor [electrons/data number] \\
INSTRUMENT              & S &  Name of instrument such as IRCAM, UFTI, UIST
                               Michelle, ISAAC but its use is deprecated \\
NUMBER\_OF\_EXPOSURES   & I &  Number of exposures in the integration \\
NUMBER\_OF\_OFFSETS     & I &  Number of jitter offset positions \\
NUMBER\_OF\_READS       & I &  Number of reads per exposure \\
OBJECT                  & S &  Name of the object, preferably adhering
                               to IAU standard \\
OBSERVATION\_MODE       & S &  Operating mode of multi-mode instrument,
                               \texttt{imaging}, \texttt{spectroscopy}, or \texttt{ifu} \\
OBSERVATION\_NUMBER     & I &  Observation number (starting at 1 each night) \\
OBSERVATION\_TYPE       & S &  \texttt{BIAS}, \texttt{DARK}, \texttt{FLAT}, \texttt{LAMP},
                               \texttt{OBJECT}, \texttt{SKY} \\
RA\_BASE                & F &  Right Ascension (J2000) at reference
                               position (and offset 0,0) [h] \\
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{lcp{80mm}}
RA\_SCALE               & F &  Pixel scale along right-ascension axis [arcsec] \\
RA\_TELESCOPE\_OFFSET   & F &  Telescope right-ascension offset with
                               respect to the RA\_BASE position [arcsec] \\
READMODE                & S &  Such as STARE, NDSTARE, CHOP \\
ROTATION                & F &  Angle of the Declination axis with respect to
                               the frame's $y$ axis measured counter clockwise. \\
SPEED\_GAIN             & S &  Speed and type of readout, e.g. Normal, Fast,
                               Higain for UFTI; Standard, Fast, Deepwell for IRCAM. \\
TELESCOPE               & S &  The \xref{PAL palObs}{sun267}{} telescope name  \\
STANDARD                & B &  Whether or not the observation is of a standard \\
UTDATE                  & S &  UT date of the observation in \emph{yyyymmdd} format \\
UTEND                   & F &  UT of the end of the observation [h] \\
UTSTART                 & F &  UT of the start of the observation [h] \\
WAVEPLATE\_ANGLE        & F &  Polarimetry waveplate position angle [deg] \\
X\_LOWER\_BOUND         & I &  Start column of array readout \\
X\_REFERENCE\_PIXEL     & F &  The pixel index of the $x$ reference position
                               for RA\_BASE and DEC\_BASE \\
X\_UPPER\_BOUND         & I &  End column of array readout \\
Y\_LOWER\_BOUND         & I &  Start row of array readout \\
Y\_REFERENCE\_PIXEL     & F &  The pixel index of the $y$ reference position
                               for RA\_BASE and DEC\_BASE \\
\medskip
Y\_UPPER\_BOUND         & I &  End row of array readout \\ \hline
\end{tabular}
\end{center}

\subsection{\xlabel{steering_headers}Steering Headers\label{steering_headers}}

Headers which direct a recipe are called steering headers.  These can
include timing information, such as when a flat should be made;
qualifiers about the frame such as whether it is of a target or sky.
They use header information and membership index within a group.
The names of steering headers should be longer than eight characters
to avoid confusion with \FITSref\ keywords.

Most steering headers are per frame and are accessed by \texttt{ORAC::Frame::uhdr()} (see \xref{Frame headers in SUN/233}{sun233}{}).
Steering headers which must persist between frames, such as those
which define groups of related raw or processed frames like
differenced chopped pairs, must be stored in the group internal
headers, accessed by \texttt{ORAC::Group::uhdr()}.

While programmers can create their own steering headers as needed, it
is silly to invent new names for ones which already exist and are
accessed by many primitives, which the programmers would then not be
able to use directly.

Here is a list of the common steering headers used in the imaging
recipes.  Not all headers are pertinent to all recipes.  The headers
used exclusively by specialist recipes, such as for Fabry-Perot or
nod-chop in a scan mode, are not listed below.  The abbreviations for
data type are B: boolean (1 for true, 0 for false), I: integer, F:
floating point, and S: string.  Note that some of the timing headers
may in fact switch on for the same frame.

\begin{tabular}{lcp{93mm}}
Name                & Type &  Meaning \\ \hline
CREATE\_CATALOGUE    & B & Whether or not to create an object catalogue. \\
CYCLE\_NUMBER       & I & Number of the cycle, a cycle being a set of frames to
                          complete a pass through the recipe.  The first cycle is 0. \\
DEC\_OFFSET\_DIFFERENCE & F & The declination displacement between a nodded pair of
                          frames. \\
DIFFERENCE\_PAIR    & B & Whether or not to subtract pairs.  It is normally true every
                          second frame. \\
DO\_APHOT           & B & Whether or not perform aperture photometry.  Photometry is
                          performed once the mosaic is made. \\
EXTENDED\_ROW       & I & The row number of the frame for
                          \htmlref{EXTENDED\_$n\times$$m$}{EXTENDED_5x5} recipes. \\
FLAT\_DIVIDE        & B & Whether or not to apply a flat field. \\
JITTER\_FIRST       & B & This selects the ordering of polarimetry frames.  If true
                          the jittering occurs at all positions before the waveplate is
                          turned.  If false, all waveplate angles are
                          observed at a given offset. \\
JITTER\_NUMBER      & I & The number of frames in the jitter. \\
MAKE\_FLAT          & B & Whether or not to make a flat field. \\
MAKE\_GRAND\_MOSAIC & B & Whether or not register the frames and make the full mosaic
                          for EXTENDED\_$n\times$$m$ recipes. \\
MAKE\_MOSAIC        & B & Whether or not register the frames and make the mosaic.
                          For EXTENDED\_$n\times$$m$ recipes it is the time to make a
                          row mosaic. \\
MASK\_OBJECTS       & B & Whether or not to mask the objects.  Masking occurs when all the
                          jittered frames in a cycle are available. \\
PAIR\_ORDER         & B & Pair subtraction order, true means take second from the first,
                          and false means take the first from the second. \\
POL\_CYCLE\_NUMBER  & B & Number of the polarimetry cycle, a cycle being a set of frames
                          to complete a pass through the recipe for all waveplate angles.
                          The first cycle is 0. \\
RA\_OFFSET\_DIFFERENCE & F & The right-ascension displacement between a nodded pair of
                          frames. \\
REFERENCE\_FRAME    & B & A true value specifies the reference frame for normalisation
                          of the masked frames.  It is true for the first frame
                          and false for all subsequent frames in the observation. \\
REFERENCE\_LEVEL    & F & The reference modal level, used when combining masked frames
                          to form a flat. \\
REFERENCE\_SKY      & F & The reference sky level, used for sky subtraction. \\
REGISTER\_IMAGES    & B & Whether or not to register and resample the polarimetric
                          e- and o-beam mosaics. \\
SUBTRACT\_SKY       & B & Whether or not it is time to subtract the sky.  Sky subtraction
                          normally occurs once all the frames in a cycle are available. \\
TARGET\_OR\_SKY     & S & This is \texttt{"target"} for a target frame, and \texttt{"sky"}
                          for a sky calibration frame. \\ \hline
\end{tabular}

\begin{tabular}{lcp{93mm}}
Name                & Type &  Meaning \\ \hline
TARGET\_NUMBER      & I & When TARGET\_OR\_SKY is \texttt{"target"}, this counts the target
                          frames, starting from zero.  It is used for interpolation
                          between sky measurements. \\
USE\_VARIANCE       & B & Whether or not variance processing is to occur. \\
WAVEPLATE\_FLAT     & B & Whether or not to make a flat for each polarimeter waveplate angle.
                          For non-polarimetric data, the value is immaterial.  For polarimetric
                          data, false means combine all waveplate angles to make the flat
                          (there should be an equal number of each angle). \\ \hline
\end{tabular}

\newpage
\section{\xlabel{se_changes4p1}Release Notes---V4.1\label{se_changes4p1}}

The main changes are improvements to polarimetry, aperture photometry,
and Fabry-Perot reductions; several new recipes; and support for
Magellan \ClassicCam, VLT \NACO, and Gemini \NIRI\ instruments.

\subsection{New recipes}
\begin{description}
  \item [BRIGHT\_POINT\_SOURCE\_NCOLOUR]
    Reduces a multi-colour bright-point-source photometry observation.
  \item [\htmlref{BRIGHT\_POINT\_SOURCE\_NCOLOUR\_APHOT}{BRIGHT\_POINT\_SOURCE\_NCOLOUR\_APHOT}]
    Reduces a multi-colour bright-point-source photometry observation
    and performs aperture photometry.
  \item [\htmlref{BRIGHT\_POINT\_SOURCE\_CATALOGUE}{BRIGHT\_POINT\_SOURCE\_CATALOGUE}]
    Reduces a bright-point-source photometry observation, producing
    a catalogue of all sources in the field.
  \item [\htmlref{BRIGHT\_POINT\_SOURCE\_TELE}{BRIGHT\_POINT\_SOURCE\_TELE}]
    Reduces a bright-point-source photometry observation, using
    telescope offsets for registration.
  \item [BRIGHT\_POINT\_SOURCE\_TELE\_APHOT]
    Reduces a bright-point-source photometry observation, using
    telescope offsets for registration, and performs aperture photometry.
  \item [\htmlref{DIFFERENCE\_STATS}{DIFFERENCE\_STATS}]
    Calculates statistics for Michelle darks in a pairwise manner.
  \item [\htmlref{JITTER\_SELF\_FLAT\_CATALOGUE}{JITTER\_SELF\_FLAT\_CATALOGUE}]
    Reduces a ``standard jitter'' photometry observation using
    object masking, and produces a catalogue of all sources
    in the field.
  \item [\htmlref{JITTER\_SELF\_FLAT\_NCOLOUR\_APHOT}{JITTER\_SELF\_FLAT\_NCOLOUR\_APHOT}]
    Reduces a multi-colour ``standard jitter'' photometry observation
    using object masking, and performs aperture photometry.
  \item [\htmlref{LAMP\_FLAT}{LAMP\_FLAT}]
    Creates and files imaging flat fields derived from a calibration
    lamp for \ISAAC\ and \NACO.
  \item [\htmlref{POL\_QU\_FIRST\_NOD\_CHOP}{POL\_QU\_FIRST\_NOD\_CHOP}]
    Reduces a \Michelle\ chopped and nodded polarimetry observation, where
    waveplate angle iterates in pairs at each jitter position.  Its purpose
    is to form the $Q$,$U$ Stokes parameters as quickly as possible,
    hence offer more-accurate polarimetry than integrating at four waveplate
    angles before nodding.
\end{description}

\subsection{Modified recipes}
\begin{itemize}
  \item The UIST ARRAY\_TESTS calculates the dark current and readnoise
    in four regions equally divided along the $X$-axis.  The recipe
    reports the quality of each statistic compared with normal
    operating parameters.
  \item \htmlref{FP}{FP}, \htmlref{FP\_JITTER}{FP\_JITTER}, and
    \htmlref{FP\_JITTER\_NO\_SKY}{FP\_JITTER\_NO\_SKY}~~
    May allow scaling of the various components in the formula to create
    the reduced data, if other external calibrations are available,
    defaulting to the previous behaviour.
  \item \htmlref{MAKE\_BPM}{MAKE\_BPM}~~
    No longer applies an existing bad pixel mask and creates unwanrted
    variance.
  \item \htmlref{REDUCE\_DARK}{REDUCE\_DARK}~~
    Permits averaging of darks of the same exposure time.  The dark
    frame name now includes the exposure time.  This does not apply
    to instruments whose darks only have a group identifier of 0,
    namely IRCAM, UFTI, and UIST.
  \item \htmlref{SKY\_FLAT}{SKY\_FLAT} and \htmlref{SKY\_FLAT\_MASKED}{SKY\_FLAT\_MASKED}~~
    These can now process multi-coloured observations.
  \item \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP}~~
    Applies a mask beyond the etalon's transmitted circular region
    on the detector.  The circle's centre is either determined through
    the new fpcentre calibration, or it is determined using profiles of
    the surrounding ring.
\end{itemize}

\subsection{Global changes}

The main changes from a user perspective were as follows.

\begin{itemize}
   \item Updated and expanded documentation, featuring the new recipes
   and instrument-data supported, more on the \htmlref{``Features of
   the Primitives''}{features_of_the_primitives}, and a new appendix
   listing the \htmlref{file prefixes}{file_prefixes}.

   \item Added support for Magellan \ClassicCam\ imager, and the ESO
   \NACO\ instrument in imaging mode.  These have only processed
   a few nights data exercising a few recipes.  The NACO pipeline
   would certainly benefit from more data.

   \item Upgraded support for the Gemini \NIRI\ instrument from
   pre-alpha to alpha, through more-thorough header translations,
   adjusting the nominal WCS to an actual one, setting the saturation
   levels, tested aperture photometry within a 3-arcsec aperture
   of thermal data.  It's still a work in progress, but it should be
   possible to process non-thermal data too given a sequence of frames
   matching a standard sequence.

   \item Incorporated eStar (intelligent-agent) calls in
   in five recipes, including the two new recipes which make an
   inventory of the sources such as
   \htmlref{BRIGHT\_POINT\_SOURCE\_CATALOGUE}{BRIGHT\_POINT\_SOURCE\_CATALOGUE}.

   \item The IRIS2 ARRAY\_TESTS has been improved.  The mode, speed,
   and readnoise are written to the calibration log and reported.

   \item Several recipes in the \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE}
   \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} families
   and \htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER}
   have two additional steps: one to correct for residual bias
   variations along columns, and the other to correct for field
   distortion.  For most instruments these are null, but not for
   \ISAAC, where both are applied; and NACO, where the bias striping is
   removed.

   \item The \ISAAC\ sky co-ordinate system is tied to the undistorted
   grid co-ordinates rather than than the distorted grid.  This means
   that measured sky positions for sources will not be misplaced by the
   distortion. IRIS2 now corrects its world co-ordinate system for
   spatial distortion, but the pixel grid is not resampled.

   \item Improved central-source registration and corrected the world
   co-ordinate system associated with polarimetry products.  The latter
   includes allowance for the bifurcation in the Wollaston prism, and
   the left-handed sky co-ordinates of \UIST\ (by flipping the raw data
   and WCS headers).  Enlarged the extracted target and sky regions
   for UIST.

   \item Combining sources in NOD\_CHOP recipes revamped, using the
   chop and nod offsets to decide upon the visibility of an image.
   Thus it can now cope with just one positive-negative image pair.

  \item Centroid hunting allows for the source to be just outside
   the initial search box, and should lead to better registration
   of single sources and photometry, when the source is not placed
   at the nominal location (such as shifted instrument apertures at
   UKIRT).

   \item The option to clean small blemishes using a 15$\times$15 box
   filter during flat creation is now accessible from recipes, say when
   invoking \_FLAT\_FIELD\_MASKED\_GROUP\_.

   \item Object masking reports the detection threshold read from the
   EXTRACTOR parameter file rather than a hardwired value.

   \item For ESO data \htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER}
   allows the last frame to be of the target.  Fixed a bug where the
   normalised sky frames were flat-fielded prior to object masking
   instead of flattening the frames with masked deviant pixels.

   \item Fixed a bug in determining a consistent set of sky levels for
   \htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER} in multiple recipe
   iterations.

   \item Fixed a bug where exposure time was not integrated in the
   grand mosaic of EXTENDED recipes.  The the start and end times and
   airmasses are also updated in the grand mosaic's headers.  The
   mosaic's WCS is set to the SKY by default.

   \item Allow polarimetry recipes to work with angles of 0, 45, 90,
   and 135 degrees.  This permits the circular polarisation to be
   determined from the Stokes images.  Appropriately named flats for
   90 and 135 degrees are created where necessary.

   \item There is a new polrefang calibration to correct the measured
   polarisation angles to position angle, allowing for instrumental
   alignment. The index file may be created manually to overide the
   default calibrations.

   \item The default near-infrared polarisation selection criteria
   have changed.  The maximum polarisation threshold is increased from
   50\% to 75\%.  The standard deviation is relaxed to 10\%.  There is
   a new criterion where the minimum intensity must be at least three
   standard deviations above zero.  The binning size is increased from
   3 to 5 and its value is reported.

   \item The polarimetry-parameter images now have their world
   co-ordinates set to SKY, so plots will be annotated with equatorial
   co-ordinates.

   \item More intermediate frames are tidied at the end of recipes,
   notably in CHOP\_SKY\_JITTER.

   \item Improved header translations for \ISAAC, such as offering
   fallback translations if the primary keyword is absent, setting
   cumulative offsets to zero for the first jitter position,
   recognising different observation-type values, and improved the
   test for the source to be a standard for ESO data.  More headers
   are tested for a waveplate angle leading to greater robustness when
   the polarimetry recipes are released. These improvements were based
   upon experience of more data from a longer range of epochs.

   \item ORACUT now set for selection of calibrations of INGRID and ESO
   data.  Michelle's ORACTIME is now in decimal UT days.

   \item The changed \Michelle\ headers are supported.

   \item Michelle reductions adapted to handle the nod iterator used
   in observation preparation.

   \item \UIST\ uses separate flat calibrations for imaging and
   spectroscopy.

   \item The KAPVIEW display recognises a boolean \texttt{key} keyword.
   If set to true ({\tt{1}}), it places a key, such as the colour
   table, besides the graphic.

\end{itemize}

The main changes from a programmer perspective were as follows.

\begin{itemize}
   \item Much of the ISAAC code applies generally to ESO instruments.
   There are new ESO/ directories for recipes and primitives.  These
   directories are ahead of the instrument-specific directories in the
   search path for the recipe and primitive source code. \texttt{ORAC::Frame::ESO} and \texttt{ORAC::Group::ESO} modules from which
   instrument-specific frame and group methods are sub-classed.

   \item  Sigma-clipping is allowed for certain combination methods
   during mosaic formation via a new SIGMA argument.  There is also
   a new ZERO argument to permit optional zero-point shifts between
   contributing frames.  While the default continues to apply intensity
   offsets, Fabry-Perot wavelength mosaics set ZERO to false.

   \item There is a new POLARIMETRY argument for some of the
   registration primitives.

   \item In aperture photometry primitives the centroid search
   boxsize is now decoupled from the aperture size via a BOXSIZE
   argument.

   \item LAMP is a new value for internal header
   ORAC\_OBSERVATION\_TYPE to support internal lamps used to make
   flats.

   \item The handling of the filters and standards' catalogues has
   been redesigned in the photometry primitives to be be more
   transparent and to make it easier to use multiple catalogues of
   standards.  A waveband is interchanged rather than a column index.

   \item \_CALC\_STOKES\_ has a boolean DEBIAS argument to control the
   application of the statistical-bias correction.

   \item \_CALC\_STOKES\_NOD\_CHOP\_ has a new boolean CENTROID
   argument, whose valued is passed to \_COMBINE\_CHOPPED\_SOURCE\_.

\end{itemize}

\newpage
\section{\xlabel{se_changes4p0}Release Notes---V4.0\label{se_changes4p0}}

The main changes are the addition of support for \UIST, \ISAAC, and
\INGRID\ instruments.

\subsection{New recipes}
\begin{description}
  \item [\htmlref{DARK\_AND\_BPM}{DARK\_AND\_BPM}]
    The design of the data-handling system means a traditional
    ARRAY\_TESTS is not possible for \UIST.  Thus there are two recipes
    to perform the equivalent steps for darks not in the same
    observation group.  This recipe uses a long-exposure DARK frame to
    locate bad pixels, then creates and files a bad-pixel mask.  It
    then measures and reports the dark current from a long-exposure DARK
    frame.  If this recipe is run at \UKIRT, the dark current is stored in
    an engineering log file.
  \item [\htmlref{MAKE\_BPM}{MAKE\_BPM}]
    Creates and files a bad-pixel mask from a long-exposure dark by
    thresholding $+$/$-$ 5 clipped standard deviations about the clipped
    mean.
  \item [\htmlref{MEASURE\_READNOISE}{MEASURE\_READNOISE}]
    This is the second UIST-specific recipe replacing ARRAY\_TESTS.
    This recipe measures the readnoise for a group of UIST DARK frames
    and files that measurement with the calibration system.  If this recipe
    is run in a UKIRT environment it will create or append to a log file
    located at {\tt/ukirt\_sw/logs/uist\_array\_tests.log}.
  \item [\htmlref{NOD\_SKY\_FLAT\_THERMAL}{NOD\_SKY\_FLAT\_THERMAL}]
    This is like \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK},
    but it expects that the nod throws alternate to sky.  The sky frames
    alone make the flat.
\end{description}

\subsection{Modified recipes}
\begin{itemize}
  \item \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS}~~
    The log file is now called {\tt$<$instrument$>$\_array\_tests.log}
    where {\tt$<$instrument$>$} is the lowercase instrument name.
  \item \htmlref{NOD\_CHOP\_FAINT}{NOD\_CHOP\_FAINT}~~
    There is now an option to create and display a quality map of the
    combined source images.
  \item \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK}~~
    This recipe and
    \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}
    now do not clean deviant pixels from the individual frames
    contributing to the flat.  Bad pixels in the mosaic are not filled.
    The difference-pair frames (suffix {\tt\_dp}) are no longer removed
    upon recipe completion.
  \item \htmlref{REDUCE\_DARK}{REDUCE\_DARK}~~
    This now supports variance creation and propagation by default.
    There is a new steering parameter USEVAR to disable this.
\end{itemize}

\subsection{Global changes}

The main changes from a user perspective were as follows.

\begin{itemize}
   \item Updated and expanded documentation, particularly the
   \htmlref{description of the primitives}{features_of_the_primitives}
   and lists the main primitives used at each stage, mention of
   \xref{\textbf{xoracdr}}{sun230}{xoracdr}, and many more hyperlinks.

   \item Introduction of environment variable \texttt{ORAC\_KEEP} to retain
   intermediate frames.

   \item Environment variables \texttt{ORAC\_DATA\_IN} and \texttt{ORAC\_DATA\_OUT}
   can define paths relative to the current working directory.

   \item \textbf{xoracdr} now knows the default calibrations for all
   instruments.  A bug which prevented \textbf{xoracdr} operating on
   non-networked computers is fixed.

   \item Calibration reference offset added for off-centre nod patterns.
   This and the baseshift offset used array references.  Arrays of
   values in a \texttt{-calib} can be comma separated.

   \item A bug affecting ORACTIME in calibrations for Michelle fixed;
   it was previously set to 0 in all cases.

   \item Cater for early Michelle data which had missing metadata
   affecting six headers.  Allow for missing, undefined, or malformed
   RA\_BASE and DEC\_BASE headers in \UFTI\ data.

   \item Allow for old UFTI data with CTYPE1 header set erroneously to
   \texttt{'Detector Rows'} to create WCS.

   \item For \IRIS, modify the header translations for filter name
   and observation mode; correct the airmass calculation; and allow
   alternate frames to have alternate files, but still be members of the
   same group by using different headers for group membership checks.

   \item There is no longer the assumption of a right-handed world
   co-ordinate system in co-ordinate transformations benefitting UIST
   and future instruments with an extra reflection in the optical train.

   \item There are additional checks for significantly negative frame
   means after dark subtraction.  Depending on the severity this may
   stop the pipeline, or merely issue a warning.  This is to ensure
   that valid darks are observed.

   \item The broadened mean method has been reinstated for combining
   frames into a flat.  This avoids the artefact in self-flat fielding
   where in an $n$-point jitter pattern, 1/$n$ pixels divide by
   themselves giving rise to a false peak at the normalisation factor
   in the histogram of values in a flat-fielded frame.

   \item A possible cause of cause of a negative mode in is given in
   the warning announnced by \_NORMALISE\_TO\_MODE\_.

   \item \_GENERATE\_OFFSETS\_EXTENDED\_ now uses the 98 percentile,
   the same as the other \_GENERATE\_OFFSETS\_ primitives.

   \item Centroiding now has a default smoothing option to make
   object location more robust for fainter sources.

   \item A double-pass median filtering of bad pixels now occurs just prior
   to the near-infra-red photometry to reduce bias from unmeasured flux.
   It particulalry helps the flat-fielded images, as the mosaics
   almost invariably lose their bad pixels in the region of interest
   during their formation.

   \item If variance information is available, the aperture photometry
   uses it to estimate photometric errors.

   \item Tidying correctly erases NDF components within HDS container
   files.  Allow for \texttt{\_bc} files in relevant \_TIDY\_ primitives.

   \item Support added to remove electronic ghosting, correct residual
   bias, and resample for field distortion, all initially for \ISAAC.
\end{itemize}

The main changes from a programmer perspective were as follows.

\begin{itemize}
   \item Calibration index files permit user header (uhdr) to be in
   expressions for bias, dark, flat, and sky.

   \item Infrastructure uses perl modules \texttt{Astro::FITS::Header} for access
   to FITS headers, and \texttt{Starlink::HDSPACK} for manipulation of HDS components.

   \item Add the internal headers ORAC\_TELESCOPE,
   ORAC\_X\_REFERENCE\_PIXEL, and ORAC\_Y\_REFERENCE\_PIXEL.

   \item There is a {\tt\$Grp->memberindex( \$Frm )} method which returns
   the position the supplied frame has in the group, starting from 0.
   This is useful in batch-mode processing where the groups are pre-populated.

   \item \_CLIPPED\_STATS\_ has new NUMBER argument returning the
   number of good pixels.

   \item \_DIVIDE\_BY\_FLAT\_CHOP\_SKY\_ and \_DIVIDE\_BY\_FLAT\_EXTENDED\_
   permit flat-fielding of sky frames via a new argument FLATSKY.

   \item There are some new primitives including \_GET\_FILTER\_PARAMETERS\_ to
   encapsulate filter attributes, and \_FORM\_SKY\_LEVELS\_ to
   determine the modal sky level for the sky frames after flat-fielding.

   \item Script \texttt{nongeneric\_imaging.csh} is moved from the \texttt{etc/} to the
   new \texttt{admin/} directory.

   \item Lexical handles rather than global variables are used for accessing files.

\end{itemize}


\section{\xlabel{se_changes3p1}Release Notes---V3.1-1\label{se_changes3p1}}

The main change is the addition of support for IRIS2.

\subsection{New recipes}
\begin{description}
  \item [\htmlref{ADDWCS}{ADDWCS}]
    Adds a valid WCS in the FITS headers of raw data.  This recipe
    is for all instruments.
  \item [ARRAY\_TESTS]
    This is for IRIS2.  It calculates and reports the readnoise and
    dark current using a group of four frames taken in the array
    tests sequence.  The readnoise and dark current are logged to
    a text file, and the readnoise is filed with the calibration system.
  \item [\htmlref{DARK\_SUBTRACT}{DARK\_SUBTRACT}]
    Subtracts a dark frame from an observation.  This recipe is meant
    for a quick look of data that are being taken at a high rate.
  \item [\htmlref{NOD\_CHOP\_FAINT}{NOD\_CHOP\_FAINT}]
    Reduction of nodded and chopped data, specifically for Michelle.
    It is similar to \htmlref{NOD\_CHOP}{NOD\_CHOP}, but first removes
    horizontal and vertical artifacts from the mosaic, then forms a single
    image of the source using a median filter, and finally smooths the
    combined image to enhance the visibility of faint sources.
  \item [\htmlref{NOD\_CHOP\_SCAN}{NOD\_CHOP\_SCAN}]
    Reduction of nodded and chopped data taken in a scan pattern,
    specifically for Michelle.  It is similar to NOD\_CHOP, but will
    create a mosaic from nodded and chopped groups taken in a scan
    pattern.
  \item [\htmlref{REDUCE\_FLAT}{REDUCE\_FLAT}]
    Reduces a flat field by masking bad pixels, subtracting a dark,
    and normalising the result.  This recipe is for all instruments.
\end{description}

\subsection{Modified recipes}
\begin{itemize}
  \item \htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT}~~
    The photometry aperture has been increased to 5 arcseconds from 3,
    and inner and outer diameters of the sky annulus have been modified
    correspondingly.  The reported photometry uses filter zero points
    and widths, the latter to find and report the broadband-$N$
    equivalent magnitude and flux for narrowband-$N$ filters.
    Extinctions are now included.

    The recipe now determines the baseshift calibration, which
    measures the displacement of the source images from the nominal
    locations.

  \item \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS}~~
    For Michelle the estimated readout noise is no longer reported.
\end{itemize}

\subsection{Global changes}

The main changes from a user perspective were as follows.

\begin{itemize}
   \item Undefined or nonsense headers used by the recipes are
   replaced internally to pipeline, but not in the physical files,
   This usually permits the pipeline to complete.   Recipes report
   the names of modified headers, for manual checking and correction
   of the raw data.

   \item Further sanity checks are included for Michelle.  The
   waveform header is validated, and incorrect combinations reported.
   The mean data value must lie between 25000 and 48000 counts to
   prevent a warning message from appearing.

   \item Recipes make an on-the-fly night log in \texttt{\$ORAC\_DATA\_OUT}.
   Night logs contain the group number.  The file name has an
   \texttt{\_im} suffix for Michelle.

   \item The default UFTI gain reflects the gain's changing values arising
   from the use of a different controller.

   \item NDF blank titles are removed.

   \item The UFTI bad-pixel mask has changed, now having 0.3\% more
   bad pixels.

   \item Centroiding is protected against data comprising all bad
   values.

   \item The hybrid registration has a further improvement for a special
   case.

   \item The near-infrared photometry uses the latest standards list,
   which also includes standards for the $IZJHKLM$ wavebands.

   \item In photometry recipes the sky units are now reported as
   counts/s/pixel.

   \item Scripts have improved error detection and reporting after accessing
   text files.

   \item The default display suffices have been augmented.  These are
   for Michelle {\tt\_cab}, {\tt\_scab}, {\tt\_cpc}, and {\tt\_rpc}; and
   {\tt\_dk} for IRCAM.

   \item The calibration called mask, should be used to specify other
   than the default bad-pixel mask, rather than the bpm calibration.
\end{itemize}

The main changes from a programmer perspective were as follows.

\begin{itemize}
   \item There is better structuring of the preliminary steps to
         permit instrument-specific variants, such as correcting the
         world co-ordinate system headers.

   \item The waveplate angle header values are standardised to a
         single format.

   \item The preliminary operation includes the removal of axes
         after a rearrangement in \\
         ORAC::Convert.

   \item The registration was modified to allow for changes to
         \xref{\CCDPACK}{sun139}{}.

   \item The \_COMBINE\_CHOPPED\_FRAME\_ primitive as used by the
         NOD\_CHOP family of recipes has new options.  These comprise
         centroiding with validation, the method by which the
         individual chopped and nodded images are combined,
         the ability to apply block smoothing for faint sources,
         and the removal of pickup and bias variations.  The
         removes column then row patterns, by subtracting the
         median of each column or row from all the values in that
         column or row.
\end{itemize}

\section{\xlabel{se_changes3p0}Release Notes---V3.0-3\label{se_changes3p0}}

The main changes are the addition of recipes for Michelle nodded and
chopped observations, and a rearranged directory structure for new and
multi-mode instruments.

\subsection{New recipes}
\begin{description}
   \item [ARRAY\_TESTS]
      This is for Michelle.  It derives a mean bias file, and
      calculates and reports the read noise, using the latter pair of
      minimum-exposure frames in the array tests sequence.  Both the
      bias frame and readnoise are recorded in the calibration system.
   \item [\htmlref{NOD\_CHOP}{NOD\_CHOP}]
      Reduction of nodded and chopped data, specifically for Michelle.
      Each recipe cycle comprises four frames located at two nod
      positions and the A and B beams.  The individual beams are
      differenced and then so are successive pairs of observations.
      The differenced images are then combined into a mosaic.  On
      successive cycles the mosaics are co-added.
   \item [\htmlref{NOD\_CHOP\_APHOT}{NOD\_CHOP\_APHOT}]
      As \htmlref{NOD\_CHOP}{NOD\_CHOP}, but it also extracts, registers,
      and combines the two positive and two negative images of the
      source. Then it performs 3-arcsecond aperture photometry on the
      combined image, logging to a small text list.  It compares the
      object name against a file of $N,Q$ standards to determine the
      zero point.  No extinction correciton is currently applied, as
      the coefficients have yet to be determined.
   \item [\htmlref{MOVING\_NOD\_CHOP}{MOVING\_NOD\_CHOP}]
      As \htmlref{NOD\_CHOP}{NOD\_CHOP}, but mosaic registration
      is adjusted to track the motion of an asteroid or compact comet
      using ephemeris data.
   \item [\htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP}]
      Reduces chopped and nodded poliarmetry data of point and small
      ($<\sim10$ arcsec) extended sources, specifically for Michelle.
      The data are expects to iterate over waveplate angle before the
      telescope is nodded.  The recipe forms integrating mosaics as
      \htmlref{NOD\_CHOP}{NOD\_CHOP}, for each of four waveplate
      angles.  For each mosaic it combines the two positive and two
      negative images of the source.  The recipe then calculates
      polarisation frames and catalogues of vectors from these as
      earlier recipes like \htmlref{POL\_JITTER}{POL\_JITTER}.
    \item [\htmlref{POL\_NOD\_CHOP}{POL\_NOD\_CHOP}]
      As \htmlref{POL\_ANGLE\_NOD\_CHOP}{POL\_ANGLE\_NOD\_CHOP},
      except the data are ordered such that the telescope performs
      its nodding pattern before the waveplate is turned.
\end{description}

\subsection{Modified recipes}

\begin{itemize}
    \item \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS}~~
       Instrument-specific versions for UFTI and IRCAM.  Both record the
       read noise in the calibration system.
\end{itemize}

\subsection{Global changes}

The main changes from a user perspective were as follows.

\begin{itemize}
   \item Correct data variance creation for UKIRT infra-red data.  The
         previous calculations were for CCD data.
   \item Easier to switch on data-variance processing.  This combined
         with handling of chopped data has caused some reordering of
	 the early steps; for instance the editing of the world
	 co-ordinate system (WCS) occurs just before dark subtraction,
	 rather than immediately after the \_IMAGING\_HELLO\_
	 preliminaries.  Thus a few of the early frames such as
	 {\tt\_db} and {\tt\_bp} now do not have a WCS defined.
   \item More-efficient masking using \EXTRACTOR\ instead of \PISA.
         Some of the acceleration is because some of the steps to
	 sweeten the data for \PISA, such as the removal of the bad
	 pixels, are now unnecessary.
   \item Flat-field creation now uses an unweighted median to give
         approximately equal weighting to the contributing frames.
         The previous version of \xref{MAKEFLAT}{sun139}{MAKEFLAT} was
         supposed to weight the values but had bugs.  The corrected
         task weights by the data value in the absence of a variance
         array assuming pure Poisson statistics, which is in appropriate
         for infra-red data.  The unweighted median gives similar
         results to earlier \ORACDR\ versions.  There is a beneficial
         exception where the earlier MAKEFLAT biassed towards certain
         contributing frames, and the unweighted median gives a more
         equitable division.
   \item An improved option for registration is available, although it
         is not the default.  It uses the WCS to only compare sources
         in the overlap regions, and permits a match using a single source,
         provided it is within 12 pixels of the nominal WCS position.
   \item For moving-target registration and the ephemeris file, a bug
         affecting object names containing spaces is fixed.
   \item Better formatting of output with blank lines to block related
         output, and some of the commentary contain more details.  The
         historical and unnecessary "Orac says: " prefix was removed
         from the commentary.
   \item The nearest-neighbour registration immediately prior to forming
         a mosaic had assumed that the brightest object with
         identification number 1 would be present in all the offset
	 files.  In rare cases, this may not be true.  For instance,
	 if the centred target is a faint or low surface-brightness
	 galaxy at low galactic latitude, brighter stars relegate the
	 galaxy to a high identification number.  So the code now
	 checks for a common-denominator object between all the frames
	 with a higher identification number.
   \item The mosaic-making primitive has been partly restructured to
         make the code more obvious, and it also rationalises the
         naming.  Gone is the {\tt\_mu} file.  The mosaic with bad
	 pixels filled has its own {\tt\_fb} suffix.  All
	 individual-cycle mosaics are retained.  The only disadvantage
	 is that for a single-cycle observation, there are two copies
	 of the same mosaic, one with suffix {\tt\_mos} and the other
	 with suffix {\tt\_mos\_0}; the recipe cannot know if there
         is a second cycle to come.
   \item The mosaics have the world co-ordinate system domain set to sky
         so that displays with \xref{\GAIA}{sun214}{} and
         \xref{\KAPPA}{sun95}{} have sky co-ordinates.
   \item The start and end UT times for mosaics are updated to that of
         the first- and last-contributing frames.
   \item The photometry results file now reports the sky in counts per
         second (previously just counts), and the exposure time.  The
         alignment of the columns is thus slightly altered.
   \item The recipe tidying has been improved to remove all unwanted
         files.  Some of the registration text files, certain suffices,
         and later-cycle frames were being missed.
   \item In the polarimetry calculations, the chip position angle is
         added to the offset of north with respect to the analyser,
         so that the vectors are also measured with respect to north.
         This omission had been giving vector orientations approximately
         89 degrees too high for IRCAM.
   \item More allowance for occasional problems with the headers in the
         raw data, \emph{e.g.}\ the base R.A. in degrees not hours and
         defunct instrument read modes.
   \item In earlier versions, there were fatal errors which the recipes
         reported, but allowed the pipeline to continue.  These are now
         corrected so that the recipe ends its processing.
   \item Expanded tutorial documentation, particularly of the description
         of algorithms used by the primitives and more hyperlinks, and
         updated for the new directory structure.  Various minor
         improvements, new hyperlinks and corrections to the recipe
         documentation.
\end{itemize}

The main changes from a programmer perspective were as follows.

\begin{itemize}
   \item The primitives access user headers for steering.
   \item The FITS header information is accessed through generic user
         headers with the prefix \texttt{ORAC\_}.  This insulation
         permits common code for multiple instruments.
   \item There were upgrades for the latest versions of \KAPPA\ and
         \ARD, notably for further use of the world co-ordinate system.
         In general recipes use the pixel domain for tasks like
         \xref{CENTROID}{sun95}{CENTROID} and \xref{PSF}{sun95}{PSF},
         recording the former domain, and then resetting WCS frame
         after using the \KAPPA\ task.
   \item There is a reorganised directory structure for the recipes
         and primitives.  These are divided into instrument-specific;
         general; or by topic, such as imaging or spectroscopy.  The
         topic directories also have subdirectories for specific instruments.
         This restructuring permits code reuse for current and new instruments.
         It is also now possible to have recipes and primitives with the same
         name for different topics or instrument.  Such scripts do have
         similar functions, but the exact processing depends on the
         data topic or some instrument attribute.
\end{itemize}

\section{\xlabel{se_changes2p1}Release Notes---V2.1-0\label{se_changes2p1}}

The main changes are the addition of spatially jittered \FP\ recipes,
and recipes for compact comets.

\subsection{New recipes}
\begin{description}
   \item [\htmlref{FP\_JITTER}{FP\_JITTER}]
      Reduction of a Fabry-Perot observation, comprising eight frames,
      on and off the source, and on and off the spectral line both to
      the blue and to the red.  This is repeated for a series of spatial
      positions of the source.
   \item [\htmlref{FP\_JITTER\_NO\_SKY}{FP\_JITTER\_NO\_SKY}]
      Reduction of a Fabry-Perot observation, comprising four frames,
      all on the source, and on and off the spectral line both to
      the blue and to the red.  This is repeated for a series of spatial
      positions of the source.
   \item [\htmlref{MOVING\_QUADRANT\_JITTER}{MOVING\_QUADRANT\_JITTER}]
      As \htmlref{QUADRANT\_JITTER}{QUADRANT\_JITTER} but registration
      is adjusted to track the motion of a comet using ephemeris
      data.  The comet should $<$45 arcsec diameter for UFTI, or $<$10
      arcsec for IRCAM.  Compared with
      \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT},
      this recipe avoids cometary artifacts appearing in the flat field.
   \item [\htmlref{QUADRANT\_JITTER\_TELE}{QUADRANT\_JITTER\_TELE}]
      As QUADRANT\_JITTER, but registers using the telescope offsets.
      This is used for observing compact comets (limiting angular
      sizes as above), when the telescope has tracked the
      nucleus.
\end{description}

\subsection{Modified recipes}

\begin{itemize}
    \item \htmlref{ARRAY\_TESTS}{ARRAY\_TESTS}
       For UFTI, the ADU conversion is obtained from the GAIN header,
       rather than being hardwired at 7.0.
    \item \htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER}
       This now functions correctly for multiple cycles of the recipe.
    \item \htmlref{FP}{FP}
       Documentation improvements especially in the description.
       Primitive \_FP\_STEER\_ has a new steering parameter, NPAIRS,
       and parameter NUMBER has changed to its normal meaning.
    \item \htmlref{NIGHT\_LOG}{NIGHT\_LOG}
       This can start from observation numbers other than 1.  A bug
       has been fixed where the dimensions appeared as zero for UFTI.
       It arose because certain headers no longer existed after 2000
       August.
    \item \htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP}
       This is no longer limited to eight frames.
    \item \htmlref{SKY\_AND\_JITTER}{SKY\_AND\_JITTER}
       A bug has been fixed where some intermediate files were not being
       removed for this recipe and its variant.
\end{itemize}

\subsection{Global changes}

The main changes from a user perspective were as follows.

\begin{itemize}
   \item The aperture for \_APHOT recipes is now 5 arcseconds.
   \item A new photometry catalogue \texttt{fs2001.dat}, supplied in
      original form by Sandy Leggett, is used by the \_APHOT recipes.
      The new catalogue contains $IZLM$ magnitudes for the first time,
      and the $JHK$ data have been refined to account for recent
      observations.  The 2000 edition is accessed for $JHK$ photometry
      if the 2001 catalogue is unavailable.
   \item Another new UFTI bad-pixel mask.  Old masks are available on
      request.
   \item A bug that affected some rare mixed-method registrations has
      been fixed.  The $y$ offset had the wrong sign.
   \item Allow for a special case in the mosaicking registration, when
      the nearest-neighbour method is used to align the various images,
      \emph{{and}} an automatic multiple-object registration was found.
      It was possible not to find a common object identifier in all
      the fields when the target is a low-surface brightness galaxy.
      While this is still possible, it is far less likely than before.
   \item The IRCAM saturation level was refined upwards to 20000, or
      33000 if header SPD\_GAIN is {\tt{"Deepwell"}}.  SPD\_GAIN
      is created by the recipe when it is absent, based upon the value
      of the detector bias.
   \item The message concerning an AST SKY Frame creation,
      which could be confused with a data frame of blank sky, has been
      clarified.  The same script allows for a missing CROTA2 header
      in old data when inserting world co-ordinate system headers.
   \item Various minor improvements and corrections to the
      documentation, such as correcting the former prefix for UFTI
      mosaics in the reference section, and excluding references to
      IRCAM in the FP recipes.
\end{itemize}


\section{\xlabel{se_changes2p0}Release Notes---V2.0-1\label{se_changes2p0}}

The major changes are the move to generic recipes, and the introduction
of many new recipes, especially for polarimetry and Fabry-Perot data.

\subsection{New recipes}
\begin{description}
   \item [\htmlref{CHOP\_SKY\_JITTER}{CHOP\_SKY\_JITTER}]
      Reduction of alternating sky-target jitters for extended objects
      of size comparable to the detector's field of view.
   \item [\htmlref{CHOP\_SKY\_JITTER\_BASIC}{CHOP\_SKY\_JITTER\_BASIC}]
      A basic (faster) version of CHOP\_SKY\_JITTER.
   \item [\htmlref{FP}{FP}]
      Reduction of a Fabry-Perot observation, without jittering.
   \item [\htmlref{JITTER\_SELF\_FLAT\_NCOLOUR}{JITTER\_SELF\_FLAT\_NCOLOUR}]
      Reduction of multi-colour standard jitters.  This will become
      the new JITTER\_SELF\_FLAT once the recipes are colour generic.
   \item [\htmlref{POL\_ANGLE\_JITTER}{POL\_ANGLE\_JITTER}]
      Reduces an imaging polarimetry observation, in which the
      waveplate angle iterates at each jitter position.
   \item [\htmlref{POL\_EXTENDED}{POL\_EXTENDED}]
      Reduces an imaging polarimetry observation of an extended
      source.
   \item [\htmlref{POL\_JITTER}{POL\_JITTER}]
      Reduces an imaging polarimetry observation, in which the
      spatial is position jittered before moving the waveplate
      angle.
   \item [\htmlref{SKY\_FLAT\_FP}{SKY\_FLAT\_FP}]
      Creates and files a Fabry-Perot flat field derived from eight
      frames, using object masking.
   \item [\htmlref{SKY\_FLAT\_POL}{SKY\_FLAT\_POL}]
      Creates a polarimetry flat field derived from eight frames
      (two at each waveplate angle), using object masking.  It copies
      the flat for each waveplate angle and files them.
   \item [\htmlref{SKY\_FLAT\_POL\_ANGLE}{SKY\_FLAT\_POL\_ANGLE}]
      Creates and files polarimetry flat fields derived from jittered
      frames at each waveplate angle, using object masking.
\end{description}

\subsection{Modified recipes}
Many former recipes had numerous variants for different jitter sizes.
These have largely been superseded by generic equivalents.  Only the
EXTENDED recipes await conversion.  The families of recipes changed
are listed below.

\begin{itemize}
    \item \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT}
          (Six recipes in the family)  There were three-,
          five-, seven-, and nine-point versions, but most were only
          available for one or two recipe variants.
    \item \htmlref{MOVING\_JITTER\_SELF\_FLAT}{MOVING\_JITTER\_SELF\_FLAT}
          (Two recipes)  These were limited to nine-point jitters.
    \item \htmlref{NOD\_SELF\_FLAT\_NO\_MASK}{NOD\_SELF\_FLAT\_NO\_MASK}
          (Four recipes) There were limited to fixed sizes of four- and
          eight-point jitters.
    \item \htmlref{SKY\_AND\_JITTER}{SKY\_AND\_JITTER} (Two recipes)
          Only five-point jitters were available.
\end{itemize}

In addition certain recipes had a fixed jitter size, but no longer.
These families are as follows.

\begin{itemize}
    \item \htmlref{BRIGHT\_POINT\_SOURCE}{BRIGHT\_POINT\_SOURCE} (Two recipes)
       These were formerly restricted to five-point jitters.
\end{itemize}

\subsection{Global changes}

The main changes from a user perspective were as follows.

\begin{itemize}
   \item Recipes and primitives are instrument generic.
   \item \htmlref{Improved registration}{automatic_registration} allowing
      mixed solutions.  There is a new offset type---beam
      separa\-tions---for combining polarimetry mosaics.
   \item \htmlref{Thresholding}{bad_pixels} of dark-subtracted data
      to prevent bizarre values affecting the pipeline processing.
      In addition \htmlref{JITTER\_SELF\_FLAT}{JITTER\_SELF\_FLAT} and
      \htmlref{SKY\_FLAT}{SKY\_FLAT} recipes and their variants which
      use object masking to make a flat, now have the deviant pixels of
      the initial flat-field frame reflagged as bad.
   \item Editing of the FITS headers to create a world co-ordinate
      system which \xref{\GAIA}{sun214}{} and \xref{\KAPPA}{sun95}{}
      recognise.  Also pre-ORAC IRCAM data have their headers
      structured and comments edited to bring them closer towards the
      \htmladdnormallink{UKIRT FITS
      standard}{http://www.jach.hawaii.edu/JACpublic/UKIRT/software/orac/docs/orac016-fith.fm.A4.ps},
      and to make the headers easier to read and comprehend.
   \item The names of flats have changed.  The filter name is included
      for easy identification.  Certain characters have special
      meaning to HDS, therefore \texttt{[]\{\}} are removed and a decimal
      point becomes a \texttt{p} in the flat's name.  The {\tt{\_cycle}}
      suffix is shortened to {\tt{\_c}}, and all {\tt{\_subgrp}}
      strings removed from the group number.  Flats are are not
      combined over multiple cycles over recipes.  SKY\_FLAT and
      SKY\_FLAT\_MASKED are limited to jitters between three to five
      points for compatibility with other ORAC tools.  It is still
      possible to make private variants of these recipes in which the
      number of jitter positions is set by the NUMBER steering
      parameter.
   \item Mosaics are combined using the mean at each pixel.  This was
      formerly the median.  The change was made to correct the
      photometry.  Poor registration from telescope offsets due to
      sparse fields leads to multiple peaks in the mosaic's grid, and
      given the steep point-spread function's profile, the median
      preferentially selects pixels not at a peak.  This resulted in a
      typical underestimate of the flux of standard stars by 1--3\%.
      The \_MAKE\_MOSAIC\_ primitive now has an argument to select
      various estimators should you prefer not to use the mean.
   \item For the aperture photometry the default sky annulus radii
      have been increased.  This reduces the error estimating the sky
      level, both statistically and from the extend low-level pedestal
      in the point-spread function.  The area is increased 2.9$\times$
      for IRCAM and 5.6$\times$ for UFTI.
   \item To counteract the spike artifact in the histogram of sky values
      of flat-fielded frames where the pre-flattened frame itself
      contributed to the flat (`self-flat' recipes), the mode is
      now calculated using multiple standard-deviation clipping for
      \htmlref{JITTER\_SELF\_FLAT\_APHOT}{JITTER\_SELF\_FLAT\_APHOT} and
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}.
      The previous estimation was from iterative application of
      Chauvenet's criterion and using the \mbox{3 $\lsk$ median $-$ 2 $\lsk$ mean}
      formula, and lead to a underestimate of the sky level.  For
      typical standard stars this systematic error led to a
      brightening of 1--2\%.  The latter method is still used for
      photometric recipes which do not self flat, such as
      \htmlref{BRIGHT\_POINT\_SOURCE\_APHOT}{BRIGHT\_POINT\_SOURCE\_APHOT}.
      If you create and apply a `superflat', the artifact is much
      reduced and therefore, the former estimator is appropriate.
   \item More and better processing-status messages.  For example, all
      floating-point numbers are now reported with a sensible number of
      decimal places, and the names of calibration frames are reported.
   \item Addition of FWHM to the aperture photometry results and small
      text list.  The file name column is 3 characters wider to
      accommodate the positive and negative suffices of recipe
      \htmlref{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}{NOD\_SELF\_FLAT\_NO\_MASK\_APHOT}.
   \item The saturation level in the aperture photometry was a constant.
      Now it is set to the appropriate value by instrument and mode.
   \item It is possible to use versions of \KAPPA\  other than the
     latest.  The changed argument lists in various tasks are adjusted
     for the \KAPPA\  version.
   \item More intermediate files, mostly the text files, are removed.
   \item Pipeline activates two more application engines: \POLPACK\ and
      {\footnotesize CATSELECT}.
   \item A new UFTI bad-pixel mask.
   \item Added waveplate angle to flat rules file ({\tt\$ORAC\_DATA\_CAL/rules.flat}).
        The angle defaults to zero if it does not have a value in the FITS
        headers.
   \item Bug fixes and documentation improvements, especially links in
      the Perl POD.
\end{itemize}

% ? End of main text
\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
