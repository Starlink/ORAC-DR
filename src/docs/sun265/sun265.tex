\documentclass[twoside,11pt,nolof]{starlink}

% -----------------------------------------------------------------------------
\stardoccategory    {Starlink User Note}
\stardocinitials    {SUN}
\stardocsource      {sun\stardocnumber}
\stardoccopyright
{Copyright \copyright\ 2014 University of British Columbia and the Science \& Technology Facilities Council}
\stardocnumber      {265.0}
\stardocauthors     {A.G. Gibb, T. Jenness, F. Economou}
\stardocdate        {10 Jun 2014}
\stardoctitle       {PICARD --- a PIpeline for Combining and Analyzing Reduced Data}
\stardocversion     {Version 1.0.0}
\stardocmanual      {User's Guide}
\stardocabstract  {
  \picard\ is a facility for combining and analyzing reduced data,
  normally the output from the \oracdr\ data reduction pipeline. This
  document describes an introduction to using \picard\ for processing
  instrument-independent data.
}

% -----------------------------------------------------------------------------

% +
%  Name:
%     sun265.tex
%
%  Purpose:
%     Documentation for PICARD
%
%  Authors:
%     AGG: Andy Gibb (UBC)
%
%  History:
%     2011-01-20 (AGG):
%        Initial version
%     2012-07-30 (AGG):
%        Updates for Kapuahi
%     2013-03-01 (AGG):
%        Updates for Hikianalia
%     2014-06-09 (AGG):
 %        Updates for 2014A
%     {Add further history here}
%
% -

\stardocname  {\stardocinitials /\stardocnumber}

% -----------------------------------------------------------------------------
% A new environment for quoting verbatim
% Environment for indenting and using a small font.
\newenvironment{myquote}{\begin{quote}\begin{small}}{\end{small}\end{quote}}

\providecommand{\starlink}{\htmladdnormallink{Starlink}{http://starlink.eao.hawaii.edu}}

% Shorthand and HTML references for other Starlink tasks
\providecommand{\CCDPACK}{\textsc{ccdpack}}
\providecommand{\CCDPACKref}{\xref{\CCDPACK}{sun139}{}}
\providecommand{\CUPID}{\textsc{cupid}}
\providecommand{\CUPIDref}{\xref{\CUPID}{sun255}{}}
\providecommand{\FLUXES}{\textsc{fluxes}}
\providecommand{\FLUXESref}{\xref{\FLUXES}{sun213}{}}
\providecommand{\GAIA}{\textsc{gaia}}
\providecommand{\GAIAref}{\xref{\GAIA}{sun214}{}}
\providecommand{\HDSTRACE}{\textsc{hdstrace}}
\providecommand{\HDSTRACEref}{\xref{\HDSTRACE}{sun102}{}}
\providecommand{\KAPPA}{\textsc{kappa}}
\providecommand{\CURSA}{\xref{\textsc{cursa}}{sun190}{}}
\providecommand{\KAPPAref}{\xref{(SUN/95)}{sun95}{}}
\providecommand{\SMURF}{\textsc{smurf}}
\providecommand{\SMURFcook}{\xref{SC/19}{sc19}{}}
\providecommand{\SMURFsun}{\xref{SUN/258}{sun258}{}}
\providecommand{\ADAMsgref}{\xref{SG/4}{sg4}{}}
\providecommand{\ADAMsunref}{\xref{SUN/101}{sun101}{}}
\providecommand{\astref}{\xref{SUN/211}{sun211}{}}
\providecommand{\ndfref}{\xref{SUN/33}{sun33}{}}

\providecommand{\oracdr}{\textsc{orac-dr}}
\providecommand{\oracsun}{\xref{SUN/230}{sun230}{}}
\providecommand{\oracprogsun}{\xref{SUN/233}{sun233}{}}
\providecommand{\scubasun}{\xref{SUN/231}{sun231}{}}
\providecommand{\scubaiisun}{\xref{SUN/264}{sun264}{}}
\providecommand{\picard}{\textsc{picard}}

% Application tasks
\providecommand{\task}[1]{\textsf{#1}}

% SMURF tasks
\providecommand{\badbolos}{\xref{\task{badbolos}}{sun258}{BADBOLOS}}
\providecommand{\calcdark}{\xref{\task{calcdark}}{sun258}{CALCDARK}}
\providecommand{\calcflat}{\xref{\task{calcflat}}{sun258}{CALCFLAT}}
\providecommand{\calcnoise}{\xref{\task{calcnoise}}{sun258}{CALCNOISE}}
\providecommand{\calcresp}{\xref{\task{calcresp}}{sun258}{CALCRESP}}
\providecommand{\copyflat}{\xref{\task{copyflat}}{sun258}{COPYFLAT}}
\providecommand{\dreamsolve}{\xref{\task{dreamsolve}}{sun258}{DREAMSOLVE}}
\providecommand{\dreamweights}{\xref{\task{dreamweights}}{sun258}{DREAMWEIGHTS}}
\providecommand{\gsdtoacsis}{\xref{\task{gsd2acsis}}{sun258}{GSD2ACSIS}}
\providecommand{\gsdshow}{\xref{\task{gsdshow}}{sun258}{GSDSHOW}}
\providecommand{\smurfhelp}{\xref{\task{smurfhelp}}{sun258}{SMURFHELP}}
\providecommand{\impaztec}{\xref{\task{impaztec}}{sun258}{IMPAZTEC}}
\providecommand{\makecube}{\xref{\task{makecube}}{sun258}{MAKECUBE}}
\providecommand{\qlmakemap}{\xref{\task{qlmakemap}}{sun258}{QLMAKEMAP}}
\providecommand{\rawunpress}{\xref{\task{rawunpress}}{sun258}{RAWUNPRESS}}
\providecommand{\rawfixmeta}{\xref{\task{rawfixmeta}}{sun258}{RAWFIXMETA}}
\providecommand{\sctwosim}{\xref{\task{sc2sim}}{sun258}{SC2SIM}}
\providecommand{\sctwothreadtest}{\xref{\task{sc2threadtest}}{sun258}{SC2THREADTEST}}
\providecommand{\scanfit}{\xref{\task{scanfit}}{sun258}{SCANFIT}}
\providecommand{\skynoise}{\xref{\task{skynoise}}{sun258}{SKYNOISE}}
\providecommand{\smurfcopy}{\xref{\task{smurfcopy}}{sun258}{SMURFCOPY}}
\providecommand{\stackframes}{\xref{\task{stackframes}}{sun258}{STACKFRAMES}}
\providecommand{\starecalc}{\xref{\task{starecalc}}{sun258}{STARECALC}}
\providecommand{\timesort}{\xref{\task{timesort}}{sun258}{TIMESORT}}
\providecommand{\unmakecube}{\xref{\task{unmakecube}}{sun258}{UNMAKECUBE}}

\providecommand{\extinction}{\xref{\task{extinction}}{sun258}{EXTINCTION}}
\providecommand{\flatfield}{\xref{\task{flatfield}}{sun258}{FLATFIELD}}
\providecommand{\jcmtstate}{\xref{\task{jcmtstate2cat}}{sun258}{JCMTSTATE2CAT}}
\providecommand{\dumpocscfg}{\xref{\task{dumpocscfg}}{sun258}{DUMPOCSCFG}}
\providecommand{\makemap}{\xref{\task{makemap}}{sun258}{MAKEMAP}}
\providecommand{\gettsys}{\xref{\task{gettsys}}{sun258}{GETTSYS}}

\providecommand{\remsky}{\xref{\task{remsky}}{sun258}{REMSKY}}
\providecommand{\clean}{\xref{\task{sc2clean}}{sun258}{SC2CLEAN}}
\providecommand{\concat}{\xref{\task{sc2concat}}{sun258}{SC2CONCAT}}
\providecommand{\fft}{\xref{\task{sc2fft}}{sun258}{SC2FFT}}
\providecommand{\fts}{\xref{\task{sc2fts}}{sun258}{SC2FTS}}

\providecommand{\rebin}{\texttt{rebin}}
\providecommand{\iterate}{\texttt{iterate}}

% Other tasks
\providecommand{\makemos}{\xref{\task{makemos}}{sun139}{MAKEMOS}}
\providecommand{\csub}{\xref{\task{csub}}{sun95}{CSUB}}
\providecommand{\clinplot}{\xref{\task{clinplot}}{sun95}{CLINPLOT}}
\providecommand{\mlinplot}{\xref{\task{mlinplot}}{sun95}{MLINPLOT}}
\providecommand{\collapse}{\xref{\task{collapse}}{sun95}{COLLAPSE}}
\providecommand{\fitsedit}{\xref{\task{fitsedit}}{sun95}{FITSEDIT}}
\providecommand{\kapdiv}{\xref{\task{div}}{sun95}{DIV}}
\providecommand{\ndfcopy}{\xref{\task{ndfcopy}}{sun95}{NDFCOPY}}
\providecommand{\provshow}{\xref{\task{provshow}}{sun95}{PROVSHOW}}
\providecommand{\thresh}{\xref{\task{thresh}}{sun95}{THRESH}}
\providecommand{\wcsmosaic}{\xref{\task{wcsmosaic}}{sun95}{WCSMOSAIC}}
\providecommand{\wcsalign}{\xref{\task{wcsalign}}{sun95}{WCSALIGN}}
\providecommand{\wcsattrib}{\xref{\task{wcsattrib}}{sun95}{WCSATTRIB}}
\providecommand{\fitslist}{\xref{\task{fitslist}}{sun95}{FITSLIST}}
\providecommand{\display}{\xref{\task{display}}{sun95}{DISPLAY}}
\providecommand{\topcat}{\xref{\textsc{topcat}}{sun253}{}}


% macros for typesetting parameters
\providecommand{\aparam}[1]{\texttt{#1}}     % ADAM parameter
\providecommand{\cparam}[1]{\texttt{#1}}     % CONFIG parameter
\providecommand{\ndfcomp}[1]{\texttt{#1}}    % NDF component

% -----------------------------------------------------------------------------
\begin{document}
\scfrontmatter

\section{\xlabel{introduction}Introduction\label{se:intro}}

The \oracdr\ pipeline (\oracsun) is a suite of recipes and primitives
for the automated processing of raw instrument data into
scientifically-useable products. However, this is only the start point
for the analysis and further operations on these data is
inevitable. The \textbf{PI}peline for \textbf{C}ombining and
\textbf{A}nalyzing \textbf{R}educed \textbf{D}ata (\picard) is a
modification to \oracdr\ which allows pipeline-processed data to be
manipulated using generic, instrument-independent
methods. Furthermore, it is inefficient to begin at the
computationally-expensive raw data stage again for every minor
adjustment to the analysis. Thus \oracdr\ and \picard\ together
represent two halves of the data reduction and analysis workflow.

This document will describe the basics of using \picard\ and contains
a summary of available processing recipes.

\subsection{Document conventions}

In an attempt to make this document clearer to read, different fonts
are used for specific structures.

Starlink package names are shown in small caps (e.g.\ \SMURF);
individual task names are shown in sans-serif
(e.g.\ \makemap). \picard\ recipe and primitive names are also shown
in sans-serif and are always upper case (e.g.\ \task{REMOVE\_BACKGROUND}).

Text relating to filenames (including suffices for data products), key
presses or entries typed at the command line are also denoted by
fixed-width type (e.g.\ \texttt{\% smurf}), as are parameters for
tasks which are displayed in upper case (e.g.\ \aparam{METHOD}).

References to Starlink documents, i.e., Starlink User Notes (SUN),
Starlink General documents (SG) and Starlink Cookbooks (SC), are given
in the text using the document type and the corresponding number
(e.g.\ SUN/95). Non-Starlink documents are cited in the text and
listed in the bibliography.

File name suffices represent the text between the final underscore
character and the three-letter \verb+.sdf+ extension. For example, a
file named \verb+s4a20101020_00002_0001_cal.sdf+ has the suffix
\verb+_cal+.

\section{\xlabel{picard}PICARD overview\label{se:picard}}

\picard\ is a tool for analyzing and combining a batch of astronomical
data files that have previously had their instrumental signatures
removed (for example by running \oracdr\ on the raw data). It is
designed to be instrument-independent. \picard\ uses the same
infrastructure as \oracdr, where data are processed by recipes which
contain a series of processing steps called primitives.

\picard\ is designed to be easy to use. It needs no initialization,
has few options and, by default, assumes that all input/output occurs
in the current working directory.

\subsection{Requirements for running PICARD}

\oracdr\ (and thus \picard) requires a recent Starlink
installation. The latest release may be obtained from
\htmladdnormallink{\texttt{http://starlink.eao.hawaii.edu/starlink}}{http://starlink.eao.hawaii.edu/starlink}. Since
\oracdr\ development is an ongoing process, it is recommended that the
newest builds be used. These builds can be obtained from:
\htmladdnormallink{\texttt{http://starlink.eao.hawaii.edu/starlink/rsyncStarlink}}{http://starlink.eao.hawaii.edu/starlink/rsyncStarlink}
and may be kept up-to-date with rsync.

The Starlink Perl installation (Starperl) must be used to run the
pipeline due to the module requirements. The Starlink environment
should be initialized as usual before running \picard.

\subsection{Important environment variables}

\picard\ does not need to have specific environment variables defined
(other than those initialized as part of Starlink). Data are read from
and written to the current working directory by default. However, it
is possible to define an alternative location for the output data via
\verb+ORAC_DATA_OUT+ (which is used by \oracdr).

Two other specialized environment variables may be defined by users
who wish to write their own processing routines: see Section
\ref{se:write} for more information.

\subsection{Running PICARD}

The only mandatory arguments are the name of the recipe and a list of
the files to process. Running \picard\ is as easy as typing
\begin{terminalv}
% picard <options> RECIPE *.sdf
\end{terminalv}
where \task{RECIPE} is the name of the processing recipe to use and
\verb+*.sdf+ is the list of files to process. In practice, everything
after the recipe name is treated as an input file. The recipe will be
applied to all input files, which must be in NDF format. Currently
there is no automated conversion from FITS.

More generally:
\begin{terminalv}
% picard [options] RECIPE FILES
\end{terminalv}
where \verb+[options]+ are command-line options of the form
\verb+-option+ or \verb+-option value+.  Note that the options must be
given before the recipe. The options are described in more detail
below.

\subsection{PICARD options}

\picard\ has a number of command-line options which may be used to
control the processing and feedback.

\input{sun265_options}

See the documentation for individual recipes in Appendix~\ref{ap:full}
for supported recipe parameters.

\section{Hints and tips\label{se:hints}}

This section lists a handful of useful hints and tips for running
\picard.

\begin{itemize}

\item
Make sure the \verb+.sdf+ extension is included in the filename if
passing in a single file.

\item A single recipe parameter file can be used for multiple recipes:
\begin{terminalv}
[RECIPE1]
PARAM1 = VALUE1
PARAM2 = VALUE2

[RECIPE2]
PARAM_A = VALUE_A
PARAM_B = VALUE_B
\end{terminalv}

\item If the environment variable \verb+ORAC_DATA_OUT+ is defined, any
  files created by \picard\ will be written in that location. Check
  there if new files are expected but do not appear in the current
  directory.

\item The list of files can be the output from \texttt{cat}: e.g.\
\begin{terminalv}
% picard -log s RECIPE_NAME `cat filestoprocess.lis`
\end{terminalv}
Remember to include the \verb+.sdf+ for each file in the list in the
file \verb+filestoprocess.lis+.

\item All data should be from the same instrument. For SCUBA-2 users,
  this means data from a single wavelength.

\item By default \picard\ does not know how to display the files
  produced as part of processing, especially if relying on
  instrument-specific features. If display is required, make a copy of
  the file \texttt{disp.dat} located in
  \verb+$ORAC_CAL_ROOT/inst_name+ where \verb+inst_name+ is the
  (lower-case) name of the instrument from which the data originated
  (e.g.\,\verb+scuba2+).

\item Be as specific as possible when providing the list of input
  files to avoid the possibility of processing output files from
  \picard\ in subsequent runs: running with \verb+*.sdf+ is generally
  a bad idea. Creating a text file containg the relevant filenames is
  best (see above).

\end{itemize}

\section{Writing PICARD recipes and primitives\label{se:write}}

\picard\ allows users to write their own primitives and recipes for
processing reduced data, although a number of (mostly SCUBA-2) recipes
exist. Interested users are advised to read \oracsun\ and
\oracprogsun\ for further details. The user can specify the
environment variables \verb+ORAC_RECIPE_DIR+ and
\verb+ORAC_PRIMITIVE_DIR+ to point to the locations containing recipes
and primitives.

While \picard\ is designed to be instrument-independent, it is
possible to access methods from supported instrument classes, provided
that all the input data are from the same instrument. This is
particularly useful for accessing instrument-specific values and
methods provided by the calibration class, for example. It also
provides access to instrument-specific recipes and primitives.

\newpage
\appendix
\begin{small}

\section{\xlabel{ap_list}Alphabetical list of PICARD recipes\label{ap:list}}

\begin{description}
\menuitem{CALC\_SCUBA2\_AVPSPEC}{
  Calculate average bolometer power spectra from SCUBA-2 data}
\menuitem{CALC\_SCUBA2\_FCF}{
  Calculate FCFs from SCUBA-2 calibrators}
\menuitem{CALC\_SCUBA2\_NEFD}{
  Calculate NEFDs from SCUBA-2 images}
\menuitem{CALIBRATE\_SCUBA2\_DATA}{
  Calibrate SCUBA-2 data}
\menuitem{COADD\_JSA\_TILES}{
  co-add JSA tiles together by tile number}
\menuitem{CREATE\_MOMENTS\_MAP}{
  Creates a moments map from a spectral line cube}
\menuitem{CREATE\_PNG}{
  Create a PNG from the current Frame object.}
\menuitem{CROP\_SCUBA2\_IMAGES}{
  Trim images to the defined map area}
\menuitem{MOSAIC\_JCMT\_IMAGES}{
  Coadd images produced by JCMT instruments}
\menuitem{PICARD\_DEMONSTRATOR}{
  Simple recipe to test Picard infrastructure}
\menuitem{SCUBA2\_REMOVE\_BACKGROUND}{
  Remove a background from images}
\menuitem{SCUBA2\_CHECK\_CAL}{
  perform SCUBA-2 calibration checks on standard sources}
\menuitem{SCUBA2\_CHECK\_RMS}{
  calculate RMS and NEFD via two methods to compare with ITC}
\menuitem{SCUBA2\_DISPLAY\_PCA}{
  Calculate and display properties of PCA components}
\menuitem{SCUBA2\_JACKKNIFE}{
  calculate optimal map using jack-knife noise estimator}
\menuitem{SCUBA2\_JACKKNIFE\_PSF}{
  create a scaled PSF from maps with fake sources added}
\menuitem{SCUBA2\_MAP\_PSPEC}{
  Calculate the noise power spectrum of a SCUBA-2 map}
\menuitem{SCUBA2\_MATCHED\_FILTER}{
  Apply a matched filter to input images}
\menuitem{SCUBA2\_PHOTOM}{
  perform aperture photometry on SCUBA-2 images}
\menuitem{SCUBA2\_REGISTER\_IMAGES}{
  Register SCUBA-2 images to a common position}
\menuitem{SCUBA2\_SASSY}{
  analyze a single SASSy field}
\menuitem{STACK\_JCMT\_FRAMES}{
  stack images produced by JCMT instruments}
\menuitem{UNCALIBRATE\_SCUBA2\_DATA}{
  Undo the calibration for SCUBA-2 images}
\menuitem{UNTRIM\_JSA\_TILES}{
  restore JSA tiles to full size}
\end{description}




\end{small}
\newpage

\section{\xlabel{ap_full}Specifications of PICARD recipes\label{ap:full}}

The following pages describe the current \picard\ recipes in detail.
\input{mainrecipes}

\end{document}
