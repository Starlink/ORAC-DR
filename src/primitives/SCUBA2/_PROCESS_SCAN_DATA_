# -*-cperl-*-

=head1 NAME

_PROCESS_SCAN_DATA_ - deal with scan mode data, making an image if appropriate

=head1 SYNOPSIS

_PROCESS_SCAN_DATA_ PERCENT_CMP=75

_PROCESS_SCAN_DATA_ METHOD=REBIN

_PROCESS_SCAN_DATA_ METHOD=QL

=head1 DESCRIPTION

A general-purpose primitive which processes scan data according to
given criteria. The processing is directed by the map-making method
and, if the iterative map-maker is to be used, the
percentage-completion parameter which delays the creation of a map
until a certain proportion of the observation has been completed. If
the criteria are not satisfied, the data are flatfielded as an
intermediate step which will help speed up the final map-making step.

For the simple rebinning map-maker, the data have the atmosphere
subtracted and are extinction corrected before creating the map.

The quick-look map-maker may also be used.

=head1 ARGUMENTS

The following arguments are supported:

=over 4

=item B<METHOD>

Method to use in making the map. Valid options are C<ITERATE>,
C<REBIN>, or C<QL>. Default is C<ITERATE>.

=item B<PERCENT_CMP>

If specified, this number is the minimum percentage of the observation
that has been completed. The default is 0 to process each file as it
appears on disk. Only accessed if B<METHOD> is C<ITERATE>.

=back

=head1 EXTERNAL TASKS

The following external tasks are used:

=over 4

=item ORAC-DR PRIMITIVES

_EXTINCTION_CORRECT_FRAME_, _FLATFIELD_, _MAKEMAP_FRAME_,
_QLMAKEMAP_FRAME_, _REMOVE_PLANE_FROM_IMAGE_

=back

=head1 NOTES

This primitive is primarily designed for the SUMMIT pipeline only.

=head1 OUTPUT DATA

If the completion criteria are not satisfied the Frame uhdr entry
C<NOCALIB> is set to 1, otherwise set to 0.

If no map is made this time through, the current Frame is marked as
C<new>, with the C<isgood> attribute set to -1.

=head1 OUTPUT FILES

Flatfielded data with suffix C<_ff> are written out during execution,
but deleted once a map has been made (C<ITERATE> only).

A frame mosaic file with extension C<_fmos> will exist (once the
percentage-completion criteria are satisfied, if appropriate).

=head1 AUTHOR

Andy Gibb E<lt>agg@astro.ubc.caE<gt>

=head1 COPYRIGHT

Copyright (C) 2009 University of British Columbia. All Rights
Reserved.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307,
USA.

=cut

if ( $Frm->uhdr("DARKONLY") ) {
  $Frm->uhdr("NOCALIB",1);
  # Don't bother copying the last set of data
  unless ( $Frm->uhdr("OBSEND")) {
    _COPY_RAW_DATA_
  }
} else {
# Map-making method: iterate or rebin
my $method = lc(get_prim_arg($_PRIM_ARGS_, "METHOD", "iterate"));

# Choose map-making method
if ( $method =~ /^it/ ) {
  # #### ITERATE ####

  # Percentage-completion parameter - default to 0 to pick up every
  # file as it is written to disk.
  my $completion = get_prim_arg($_PRIM_ARGS_, "PERCENT_CMP", 0);

  # Determine the new_index flag which indicates the scan pattern
  # has been completed at least once since the last time this
  # primitive was called.
  my $new_index;
  if ( $Frm->uhdr("TCS_INDEX") > $Grp->uhdr("LAST_INDEX") ) {
    $new_index = 1;
    # Unset the MAPMADE flag because we have enough data to make a
    # new map
    $Grp->uhdr("MAPMADE",0);
  } else {
    $new_index = 0;
  }
  my $obscomp = 0;
  # Only take notice of the completion parameter for observations
  # which consist of a single pass of the scan pattern.
  unless ( $new_index ) {
    $obscomp = 1 if ($Frm->uhdr("PERCENT_CMP") > $completion );
    $Grp->uhdr("OBSCOMP",$obscomp);
  }

  # Time to make a new map...
  if ( $obscomp || $new_index ) {
    unless ( $Grp->uhdr("MAPMADE") ) {
      my $infiles;
      if ( $new_index ) {
	# Pass in the new data to makemap
	orac_print "Scan pattern completed - making image\n", "green";
	# Mark the current Frame as `new' so it will be processed
	$Frm->isgood(-1);
	$infiles = "NEW";
      } else {
	# Pass all the current data to makemap
	orac_print "Observation greater than $completion % complete - making image\n", "green";
	$infiles = "OBS";
      }

      # Makemap can't handle a mix of flatfielded and raw data, so
      # flatfield these data before continuing
      _FLATFIELD_
      _MAKEMAP_FRAME_ METHOD=ITER INFILES=$infiles

      # Mark as good on exit
      $Frm->isgood(1);

      # Now that data have been processed, set the LAST_INDEX flag
      # to the current TCS_INDEX
      $Grp->uhdr("LAST_INDEX", $Frm->uhdr("TCS_INDEX"));

      # Unset the NOCALIB flag now we have a map
      $Frm->uhdr("NOCALIB",0);
      # Set the OBSEND flag so that a new Group file can be created -
      # assuming that the WAIT flag is being used for
      # _MAKE_MOSAIC_GROUP_
      $Frm->uhdr("OBSEND",1);
      # Set a Group flag to denote a new Group image will have been
      # made by the next time this primitive is called
      $Grp->uhdr("MAPMADE",1);
    }
  } else {
    # If there is insufficient data to pass to makemap, do something
    # useful, such as flatfield the data
    orac_print "No enough data yet to make an image - proceeding with flatfield\n";

    _FLATFIELD_
      # Set the NOCALIB flag so data won't be calibrated
      $Frm->uhdr("NOCALIB",1);
    # Mark the Frame as `new' so it's included the next time a map
    # is made
    $Frm->isgood(-1);

    # Unset the MAPMADE flag as no new Group image should be created
    # this time through the recipe
    $Grp->uhdr("MAPMADE",0);
  }

} elsif ( $method =~ /^re/ ) {
  # #### REBIN ####

  # If the rebin method has been chosen, we must separately remove the
  # atmosphere and correct for extinction
  _REMOVE_PLANE_FROM_IMAGE_
  _EXTINCTION_CORRECT_FRAME_

  # Create image with current data
  _MAKEMAP_FRAME_ METHOD=REBIN

  # Make sure the NOCALIB flag is UNset
  $Frm->uhdr("NOCALIB",0);

} elsif ( $method =~ /^q/ ) {
  # #### QUICKLOOK ####

  # Create an image with the current data
  _QLMAKEMAP_FRAME_

  # Make sure the NOCALIB flag is UNset
  $Frm->uhdr("NOCALIB",0);
}
}
